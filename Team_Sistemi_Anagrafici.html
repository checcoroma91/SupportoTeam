<!DOCTYPE html>

<html lang="it">
<head>
<!-- SupportoTeam v2.1.8 STABLE -->

<!-- PATCH v1.3c: clearLinks fallback + CRQ bootstrap/render keys (no new <script> tags) -->

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Supporto Team ‚Äì Sistemi Anagrafici (v2.1.8)</title>
<style>:root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --chip:#1f2937; --space:18px; --edge:clamp(8px, 2vw, 16px); --op-max:60vh; }
*{box-sizing:border-box} html, body { max-width:100%; overflow-x:hidden; }
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b1023,#0f172a);color:var(--text)}
.wrap{max-width:none;margin:0;padding:var(--space) var(--edge)} header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:20}
h1{margin:0;font-size:22px;display:flex;align-items:center;gap:10px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;align-items:center}
input[type="search"], select, button, .chip {border:1px solid #263041;background:#0b1328;color:var(--text);padding:10px 12px;border-radius:10px}
input[type="search"]{flex:1;min-width:220px;margin-left:20px} button{cursor:pointer}
main{padding:var(--space) var(--edge)} .section{border:1px solid #1f2937;border-radius:14px;margin-bottom:16px;background:linear-gradient(180deg,#0e142a,#091026); overflow:hidden}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
.section-title{display:flex;align-items:center;gap:10px;font-weight:600} .section-title .toggle{width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #263041;border-radius:8px;background:#0a1227}
.section-actions{display:flex;gap:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:14px; position:relative;}
.card{background:#0b1023;border:1px solid #1f2937;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
.card-head{display:flex;align-items:center;gap:10px;justify-content:space-between}
.drag-handle{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #334155;background:#0a1227;color:#cbd5e1;border-radius:8px;cursor:grab}
.drag-handle:active{cursor:grabbing} .card h3{margin:0;font-size:16px;display:flex;align-items:center;gap:8px}
.card p{margin:0;color:var(--muted);font-size:13px}
.actions{display:flex;gap:8px;margin-top:6px} .actions button{background:#0a1227} .actions .danger{border-color:#3a1b1b;background:#1b0f10;color:#fecaca}
a{ color:#38bdf8; text-decoration-color: rgba(56,189,248,.6); } a:visited{ color:#f59e0b; } a:hover{ color:#7dd3fc; text-decoration-color: currentColor; } a:active{ color:#22c55e; } a:focus-visible{ outline:2px dashed #22c55e; outline-offset:2px; border-radius:4px; }
dialog{border:none;border-radius:14px;padding:0;max-width:560px;width:100%} .modal{background:#0b1023;color:var(--text);border:1px solid #1f2937;border-radius:14px;overflow:hidden} .modal .content{padding:16px}
.row{display:flex;gap:10px;margin-bottom:10px} .row input, .row textarea, .row select{flex:1;width:100%;border:1px solid #263041;background:#0a1227;color:var(--text);padding:10px;border-radius:10px} .row textarea{min-height:80px}
.empty{color:#94a3b8;text-align:center;padding:40px} footer{color:#94a3b8;font-size:12px;text-align:center;padding:22px} .kbd{border:1px solid #334155;background:#0a1227;border-radius:6px;padding:2px 6px;font-family:ui-monospace,Menlo,Consolas,monospace}
.dragging{ opacity:.6; } .section.drop-target{ outline: 2px dashed rgba(34,197,94,.35); } .insert-caret{ position:absolute; width:3px; border-radius:2px; background: #22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.25), 0 0 18px rgba(34,197,94,.35); pointer-events:none; z-index:5; }
.hidden{ display:none; }
@media (max-width: 900px){ :root{ --space:14px } .grid{ gap:12px; padding:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); } }
@media (max-width: 640px){ h1{ font-size:20px } .toolbar{ flex-direction:column; align-items:stretch; gap:8px; } .toolbar > *{ width:100%; } input[type="search"]{ margin-left:0; min-width:0; } button, select, input[type="search"]{ padding:8px 10px; } .section-header{ flex-direction:column; align-items:stretch; gap:8px; } .section-actions{ justify-content:flex-end; } .grid{ grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .card{ padding:12px } .section-title .toggle{ width:24px; height:24px } }
@media (max-width: 420px){ .grid{ grid-template-columns: 1fr; } }
@media (max-width: 640px){ dialog{ margin:0; width:100vw; height:100vh; max-width:100vw; max-height:100vh; } .modal{ height:100%; border-radius:0; border-left:none; border-right:none; display:flex; flex-direction:column; } .modal-bar{ position:sticky; top:0; z-index:2; display:flex; align-items:center; justify-content:space-between; padding:12px var(--edge); background:#0b1023; border-bottom:1px solid #1f2937; } .modal-bar .title{ font-weight:600; } .modal-bar .close{ appearance:none; background:transparent; color:var(--text); border:1px solid #334155; width:36px; height:36px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; } .modal .content{ flex:1; overflow:auto; padding:12px var(--edge); } .row{ gap:8px; margin-bottom:8px } #cancelBtn{ display:none } }
dialog::backdrop{ background: rgba(2,6,23,.6) }
.modal-bar{ display:grid; grid-template-columns: 1fr auto; align-items:center; padding:12px var(--edge); background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom:1px solid #1f2937; }
.modal-bar .title{ margin:0; padding-left:8px; font-weight:600; line-height:1.2; } .modal-bar .close{ justify-self:end; width:36px; height:36px; border-radius:10px; }
.table { width: 100%; border-collapse: collapse; }
.table th, .table td { border: 1px solid #1f2937; padding: 8px 10px; font-size: 13px; vertical-align: top; }
.table th { background: #0a1227; text-align: left; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #263041; background: var(--chip); color: #cbd5e1; }
.badge.state { background:#0a1227; color:#cbd5e1; border-color:#334155; }
.badge.max { background:#5b1c33; color:#ffd1dc; border-color:#7a2a49; }
.table-actions { display: inline-flex; gap: 8px; }
.table-actions button { background: #0a1227; border: 1px solid #263041; color: var(--text); padding: 6px 8px; border-radius: 8px; }
.table-actions .danger { border-color: #3a1b1b; background: #1b0f10; color: #fecaca; }
#opBody > .grid { display:block; }
#opTableWrap { width:100%; overflow:auto; max-height: var(--op-max); }
#opSummaryBar { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #1f2937; background: #0a1227; position:sticky; top:0; z-index:1; }
#opSummaryBar .count { color: var(--muted); font-size:13px; }
.col-id{ display:none; }
th.sortable{ cursor:pointer; user-select:none; }
th.sortable .arrow{ opacity:.7; margin-left:6px; }
/* Services full width */
#svcBody > .grid { display:block; }
#svcTableWrap { width:100%; overflow:auto; max-height: var(--op-max); }
/* Multiline columns */
.col-operation{ white-space: pre-wrap; word-break: break-word; }
.col-multiline{ white-space: pre-wrap; word-break: break-word; }

/* === v15: applicativo -1%, azioni +1% === */
#svcTable{ table-layout: fixed; width: 100%; }
#svcTable th, #svcTable td{ box-sizing: border-box; }
#svcTable td, #svcTable th{ white-space: normal; overflow-wrap:anywhere; word-break: break-word; }
#svcTable col.w-routine{     width: 7%; }
#svcTable col.w-tipo{        width: 5%; }
#svcTable col.w-servizio{    width: 15%; }
#svcTable col.w-oper{        width: 18%; }
#svcTable col.w-fallback{    width: 6%; }
#svcTable col.w-descr{       width: 22%; }
#svcTable col.w-ambito{      width: 5%; }
#svcTable col.w-applicativo{ width: 7%; }  /* reduced by 1% */
#svcTable col.w-in{          width: 5%; }
#svcTable col.w-out{         width: 5%; }
#svcTable col.w-azioni{      width: 5%; }  /* increased by 1% */



/* === v25 (from v15): Dialog improvements for Sections === */

#sectionsDlg .modal-bar { position: sticky; top: 0; z-index: 2; }

#sectionsDlg #sectionsList .list-item {
  display: grid;
  grid-template-columns: 1.6fr 2.4fr minmax(140px,0.8fr) minmax(170px,0.9fr) minmax(250px, auto);
  gap: 12px; align-items: center; padding: 8px 0; border-bottom: 1px solid #1f2937;
}
#sectionsDlg #sectionsList .list-item > input, #sectionsDlg #sectionsList .list-item > select { min-width: 0; padding-left: 8px; padding-right: 8px; }
#sectionsDlg #sectionsList .iconSel { width: 120px; }
#sectionsDlg #sectionsList .controls { display:inline-flex; flex-wrap: nowrap; gap:8px; white-space: nowrap; }
#sectionsDlg #sectionsList .controls button { flex: 0 0 auto; }

/* Filter menu: wide + grid 5 cols */

#filterSectionsDlg .modal-bar { position: sticky; top: 0; z-index: 2; }





#filterMenu .menu-btn .text { flex:1; min-width:0; }

@media (min-width: 1600px){   }
@media (max-width: 1000px){  }
@media (max-width: 640px){  }

/* === v38: Grid definitiva: controlli auto, Nome/Descr minmax, niente x-scroll === */
#sectionsDlg #sectionsList .list-item {
  display: grid;
  grid-template-columns:
    minmax(220px, 1fr)   /* Nome */
    minmax(320px, 2fr)   /* Descrizione */
    auto                 /* Icona */
    auto                 /* Colore */
    auto;                /* Azioni */
  gap: 8px;
  align-items: center;
}
#sectionsDlg .content > .row {
  display: grid;
  grid-template-columns:
    minmax(220px, 1fr)
    minmax(320px, 2fr)
    auto
    auto
    auto;
  gap: 8px;
  align-items: center;
}
#sectionsDlg input,
#sectionsDlg select { min-width: 0; width: 100%; }
#sectionsDlg .controls { display: inline-flex; width: auto; gap: 6px; }
#sectionsDlg .modal, 


/* === v39: fix selettori che dilatano le colonne auto; controlli a misura contenuto === */
/* 1) Lasciare input a larghezza piena nella propria cella, ma NON i select */
#sectionsDlg input { min-width: 0; width: 100%; }
#sectionsDlg select { width: max-content; max-width: 100%; min-width: 0; }
#sectionsDlg #sectionsList .iconSel { width: max-content; }

/* 2) Le colonne di controllo (auto) devono misurare il contenuto reale */
#sectionsDlg #sectionsList .controls { display: inline-flex; gap: 6px; white-space: nowrap; width: max-content; }
#sectionsDlg #sectionsList .controls button { width: 26px; height: 26px; }

/* 3) Griglia definitiva: Nome/Descr minmax, controlli auto */
#sectionsDlg #sectionsList .list-item {
  display: grid;
  grid-template-columns:
    minmax(220px, 1fr)   /* Nome */
    minmax(320px, 2fr)   /* Descrizione */
    auto                 /* Icona */
    auto                 /* Colore */
    auto;                /* Azioni */
  gap: 8px;
  align-items: center;
}
#sectionsDlg .content > .row {
  display: grid;
  grid-template-columns:
    minmax(220px, 1fr)
    minmax(320px, 2fr)
    auto
    auto
    auto;
  gap: 8px;
  align-items: center;
}

/* 4) Mai scrollbar orizzontale nella dialog */
#sectionsDlg .modal, 


/* === v40: no-x-scroll robusto + colonne controlli a misura + contenitore sicuro === */
html, body { overflow-x: hidden; }




/* Grid: Nome/Descr elastiche, controlli auto */
#sectionsDlg #sectionsList .list-item,
#sectionsDlg .content > .row {
  display: grid;
  grid-template-columns:
    minmax(220px, 1fr)
    minmax(320px, 2fr)
    auto
    auto
    auto;
  gap: 8px;
  align-items: center;
}
/* Evita che i figli forzino la larghezza della traccia */
#sectionsDlg #sectionsList .list-item > *,
#sectionsDlg .content > .row > * { min-width: 0; }

/* Input riempiono la cella; select/azioni "a misura" */
#sectionsDlg input { width: 100%; }
#sectionsDlg select { width: auto; max-width: 100%; }
#sectionsDlg #sectionsList .iconSel { width: auto; }
#sectionsDlg #sectionsList .controls { width: auto; display: inline-flex; gap: 6px; white-space: nowrap; }
#sectionsDlg #sectionsList .controls button { width: 26px; height: 26px; }


/* === v41: dimensioni come mock: colonne fisse a misura, dialog responsive === */
:root{
  --col-name: clamp(180px, 22vw, 240px);
  --col-desc: clamp(260px, 34vw, 380px);
  --col-icon: clamp(80px, 10vw, 110px);
  --col-color: clamp(120px, 14vw, 180px);
  --col-actions: clamp(170px, 20vw, 220px);
}

/* Dialog size like screenshots */




/* Grid: colonne con variabili per matchare il mock */
#sectionsDlg #sectionsList .list-item,
#sectionsDlg .content > .row{
  display: grid;
  grid-template-columns: var(--col-name) var(--col-desc) var(--col-icon) var(--col-color) var(--col-actions);
  gap: 12px; align-items: center;
}

/* Elementi interni: non forzare overflow, riempire la cella */
#sectionsDlg #sectionsList .list-item > *,
#sectionsDlg .content > .row > *{ min-width: 0; }
#sectionsDlg input, #sectionsDlg select { width: 100%; }
#sectionsDlg #sectionsList .controls{ display:flex; gap:8px; justify-content:flex-start; width:100%; }
#sectionsDlg #sectionsList .controls button{ width:32px; height:32px; border-radius:9px; }

/* Filtro: barra a griglia come mock (cards) */


@media (max-width: 1200px){  }
@media (max-width: 900px){  }


/* === injected from Team_Sistemi_Anagrafici.html (dialogs) === */

:root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --chip:#1f2937; --space:18px; --edge:clamp(8px, 2vw, 16px); }
*{box-sizing:border-box} html, body { max-width:100%; overflow-x:hidden; }
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b1023,#0f172a);color:var(--text)}
.wrap{max-width:none;margin:0;padding:var(--space) var(--edge)} header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:20}
h1{margin:0;font-size:22px;display:flex;align-items:center;gap:10px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;align-items:center}
input[type="search"], select, button, .chip {border:1px solid #263041;background:#0b1328;color:var(--text);padding:10px 12px;border-radius:10px}
input[type="search"]{flex:1;min-width:220px;margin-left:20px} button{cursor:pointer}
main{padding:var(--space) var(--edge)} .section{border:1px solid #1f2937;border-radius:14px;margin-bottom:16px;background:linear-gradient(180deg,#0e142a,#091026); overflow:hidden}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
.section-title{display:flex;align-items:center;gap:10px;font-weight:600} .section-title .toggle{width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #263041;border-radius:8px;background:#0a1227}
.section-actions{display:flex;gap:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:14px; position:relative;}
.card{background:#0b1023;border:1px solid #1f2937;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
.card-head{display:flex;align-items:center;gap:10px;justify-content:space-between}
.drag-handle{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #334155;background:#0a1227;color:#cbd5e1;border-radius:8px;cursor:grab}
.drag-handle:active{cursor:grabbing} .card h3{margin:0;font-size:16px;display:flex;align-items:center;gap:8px}
.card p{margin:0;color:var(--muted);font-size:13px} .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.tag{background:var(--chip);border:1px solid #263041;color:#cbd5e1;padding:4px 8px;border-radius:8px;font-size:12px}
.actions{display:flex;gap:8px;margin-top:6px} .actions button{background:#0a1227} .actions .danger{border-color:#3a1b1b;background:#1b0f10;color:#fecaca}
a{ color:#38bdf8; text-decoration-color: rgba(56,189,248,.6); } a:visited{ color:#f59e0b; } a:hover{ color:#7dd3fc; text-decoration-color: currentColor; } a:active{ color:#22c55e; } a:focus-visible{ outline:2px dashed #22c55e; outline-offset:2px; border-radius:4px; }
dialog{border:none;border-radius:14px;padding:0;max-width:560px;width:100%} .modal{background:#0b1023;color:var(--text);border:1px solid #1f2937;border-radius:14px;overflow:hidden} .modal .content{padding:16px}
.row{display:flex;gap:10px;margin-bottom:10px} .row input, .row textarea, .row select{flex:1;width:100%;border:1px solid #263041;background:#0a1227;color:var(--text);padding:10px;border-radius:10px} .row textarea{min-height:80px}
.empty{color:#94a3b8;text-align:center;padding:40px} footer{color:#94a3b8;font-size:12px;text-align:center;padding:22px} .kbd{border:1px solid #334155;background:#0a1227;border-radius:6px;padding:2px 6px;font-family:ui-monospace,Menlo,Consolas,monospace}
.dragging{ opacity:.6; } .section.drop-target{ outline: 2px dashed rgba(34,197,94,.35); } .insert-caret{ position:absolute; width:3px; border-radius:2px; background: #22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.25), 0 0 18px rgba(34,197,94,.35); pointer-events:none; z-index:5; }
@media (max-width: 900px){ :root{ --space:14px } .grid{ gap:12px; padding:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); } }
@media (max-width: 640px){ h1{ font-size:20px } .toolbar{ flex-direction:column; align-items:stretch; gap:8px; } .toolbar > *{ width:100%; } input[type="search"]{ margin-left:0; min-width:0; } button, select, input[type="search"]{ padding:8px 10px; } .section-header{ flex-direction:column; align-items:stretch; gap:8px; } .section-actions{ justify-content:flex-end; } .grid{ grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .card{ padding:12px } .section-title .toggle{ width:24px; height:24px } }
@media (max-width: 420px){ .grid{ grid-template-columns: 1fr; } }
@media (max-width: 640px){ dialog{ margin:0; width:100vw; height:100vh; max-width:100vw; max-height:100vh; } .modal{ height:100%; border-radius:0; border-left:none; border-right:none; display:flex; flex-direction:column; } .modal-bar{ position:sticky; top:0; z-index:2; display:flex; align-items:center; justify-content:space-between; padding:12px var(--edge); background:#0b1023; border-bottom:1px solid #1f2937; } .modal-bar .title{ font-weight:600; } .modal-bar .close{ appearance:none; background:transparent; color:var(--text); border:1px solid #334155; width:36px; height:36px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; } .modal .content{ flex:1; overflow:auto; padding:12px var(--edge); } .row{ gap:8px; margin-bottom:8px } #cancelBtn{ display:none } }
dialog::backdrop{ background: rgba(2,6,23,.6) }
.modal-bar{ display:grid; grid-template-columns: 1fr auto; align-items:center; padding:12px var(--edge); background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom:1px solid #1f2937; }
.modal-bar .title{ margin:0; padding-left:8px; font-weight:600; line-height:1.2; } .modal-bar .close{ justify-self:end; width:36px; height:36px; border-radius:10px; }
  
#sectionsDlg #sectionsList{ display:flex; flex-direction:column; gap:16px; }
#sectionsDlg #sectionsList .list-item{ display:grid; grid-template-columns: 1.2fr 1.4fr 120px 180px auto; align-items:center; gap:14px; padding:12px 14px; background:#0b1023; border:1px solid #1f2937; border-radius:12px; }
#sectionsDlg #sectionsList .controls{ display:inline-flex; gap:10px; justify-self:end; } #sectionsDlg #sectionsList .controls button{ min-width:36px; height:36px; border-radius:10px; }
#sectionsDlg .content > .row:last-child{ margin-top:22px; padding-top:14px; border-top:1px solid #1f2937; display:grid; grid-template-columns: 1.2fr 1.4fr 120px 180px auto; gap:14px; align-items:center; }
#sectionsDlg #newSectionName, #sectionsDlg #newSectionColor{ height:36px; } #sectionsDlg #addSectionBtn{ height:36px; border-radius:10px; }
.toolbar button#exportBtn{ border-color:#2563eb; box-shadow:0 0 0 1px rgba(37,99,235,.25) inset; } .toolbar button#importBtn{ border-color:#059669; box-shadow:0 0 0 1px rgba(5,150,105,.25) inset; }
.toolbar button#exportBtn:hover{ background:#0b1023; color:#bfdbfe; } .toolbar button#importBtn:hover{ background:#0b1023; color:#a7f3d0; }
.menu-btn { display:flex; align-items:flex-start; justify-content:space-between; width:100%; padding:10px 12px; border:1px solid #1f2937; background:#0b1023; color:var(--text); border-radius:10px; }
.menu-btn:hover { background:#0a1227; } .menu-btn .hint { color: var(--muted); font-size:12px; }
.menu-btn .label{ display:grid; grid-template-columns: 48px 1fr; grid-template-rows: auto auto; column-gap:8px; align-items:start; } .menu-btn .text{ grid-column:2; grid-row:1/span 2; padding-left:0; text-align:left; align-self:start; }
.menu-btn .ico{ grid-row:1/span 2; grid-column:1; display:flex; align-items:center; justify-content:center; box-sizing:border-box; width:48px; height:48px; padding:8px; font-size:1.2rem; background:#0a1227; border:1px solid #1f2937; border-radius:10px; } .menu-btn .text .name{ margin:0; padding:0; font-weight:700; font-size:15px; line-height:1.2; text-align:left; } .menu-btn .text .desc{ display:block; color: var(--muted); font-size:12px; margin:4px 0 0 0; padding:0; text-align:left; }
#sectionsDlg select.iconSel{ min-width:120px; }

/* ===== Menu "Filtra sezioni" in orizzontale (max 5 colonne) ===== */
#filterSectionsDlg {
  /* un po' pi√π largo per poter ospitare fino a 5 colonne */
  max-width: 1200px;
  width: min(96vw, 1200px);
}



/* La griglia del menu */


/* Le card-bottone del menu riempiono la cella in altezza */


/* Manteniamo il layout interno compatto anche su pi√π colonne */


/* Responsive: scala il numero di colonne quando lo spazio si riduce */
@media (max-width: 1100px) {
  
}
@media (max-width: 900px) {
  
}
@media (max-width: 700px) {
  
}
@media (max-width: 480px) {
  
}

.toolbar button#clearAllBtn{ border-color:#7F1D1D; box-shadow:0 0 0 1px rgba(127,29,29,.25) inset; color:#FECACA; background:#1B0F10; }
.toolbar button#clearAllBtn:hover{ background:#260F12; }

/* === v41 FIX (Jan 2026): Gestisci sezioni & Menu senza scrollbar su desktop === */


/* === Soluzione 2 (Jan 2026): Container Queries + cqw per 'Gestisci sezioni' e 'Menu sezioni' === */
/* Le dialog diventano container: le unit√† cqw/cqh si riferiscono alla LARGHEZZA della dialog */
#sectionsDlg .modal, 

/* Tipografia e spaziature proporzionali alla larghezza del container */
#sectionsDlg .modal .content,
#filterSectionsDlg .modal .content { padding: clamp(12px, 2cqw, 24px); }

#sectionsDlg .modal .title,
#filterSectionsDlg .modal .title { font-size: clamp(16px, 2.8cqw, 22px); }

#sectionsDlg .modal .content .row input,
#sectionsDlg .modal .content .row select,
#sectionsDlg .modal .content .row textarea,
#filterSectionsDlg .modal .content .menu-btn { border-radius: clamp(8px, 1.2cqw, 12px); padding: clamp(8px, 1.4cqw, 14px); }

/* Lista Gestisci sezioni: griglia con gap e dimensioni fluide ma vincoli locali gi√† presenti */
#sectionsDlg #sectionsList { gap: clamp(8px, 1.2cqw, 14px); }
#sectionsDlg #sectionsList .list-item { border-radius: clamp(8px, 1.2cqw, 12px); padding: clamp(8px, 1.4cqw, 14px); }
#sectionsDlg #sectionsList .controls button { width: clamp(26px, 2.4cqw, 36px); height: clamp(26px, 2.4cqw, 36px); border-radius: clamp(6px, 1cqw, 10px); }

/* Riga di creazione nuova sezione */
#sectionsDlg .content > .row:last-child { gap: clamp(8px, 1.2cqw, 14px); }
#sectionsDlg #newSectionName, #sectionsDlg #newSectionColor, #sectionsDlg #addSectionBtn { height: clamp(32px, 3.2cqw, 40px); }

/* Menu Sezioni: griglia responsive gi√† definita. Usiamo cqw per card */






/* Bottoni azione in fondo alle dialog */
#sectionsDlg .content .primary,
#sectionsDlg .content button,
#filterSectionsDlg .content .primary,
#filterSectionsDlg .content button { font-size: clamp(12px, 1.8cqw, 16px); padding: clamp(8px, 1.4cqw, 12px) clamp(10px, 2cqw, 16px); border-radius: clamp(8px, 1.2cqw, 12px); }

/* === Auto fit-to-container (Jan 2026) per sectionsDlg & filterSectionsDlg === */
#sectionsDlg .modal, 
#sectionsDlg .modal .content, #filterSectionsDlg .modal .content { flex:1; overflow:hidden; }
.fit-viewport { position: relative; width:100%; height:100%; display:block; overflow:hidden; }
.fit-content { transform-origin: 0 0; will-change: transform; }


/* === Canonical dialogs (cleaned Jan 2026) === */
/* Larghezza dialog: override del max-width generico del <dialog> */
#sectionsDlg, #filterSectionsDlg { max-width: none; }
#sectionsDlg { width: clamp(900px, 92vw, 1240px); }
#filterSectionsDlg { width: clamp(900px, 96vw, 1400px); }

/* Container Queries + layout flessibile */
#sectionsDlg .modal, #filterSectionsDlg .modal { display:flex; flex-direction:column; container-type: inline-size; }
#sectionsDlg .modal .content, #filterSectionsDlg .modal .content { flex:1; overflow:hidden; padding: clamp(12px, 2cqw, 24px); }

/* Auto-fit viewport (no centratura, niente spazio vuoto) */
.fit-viewport { position: relative; width:100%; height:100%; display:block; overflow:hidden; }
.fit-content  { transform-origin: 0 0; will-change: transform; }

/* Menu compatto dentro #filterSectionsDlg */
#filterMenu.menu-grid { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: clamp(6px, 0.8cqw, 10px); align-items: stretch; }
#filterMenu .menu-btn { height:100%; display:flex; align-items:stretch; justify-content:space-between; text-align:left; padding: clamp(6px, 1cqw, 10px); border-radius: clamp(6px, 1cqw, 10px); }
#filterMenu .menu-btn .label { display:grid; grid-template-columns: 40px 1fr; grid-template-rows: auto auto; column-gap: clamp(4px, 0.8cqw, 8px); align-items:start; }
#filterMenu .menu-btn .ico { font-size: clamp(18px, 2.2cqw, 28px); width: clamp(32px, 5cqw, 40px); height: clamp(32px, 5cqw, 40px); padding: clamp(4px, 0.8cqw, 6px); }
#filterMenu .menu-btn .name { font-size: clamp(12px, 1.8cqw, 14px); font-weight:600; }
#filterMenu .menu-btn .desc { font-size: clamp(11px, 1.6cqw, 13px); color: var(--muted); }

/* Responsive colonne (solo numero di colonne) */
@media (max-width: 1100px) { #filterMenu.menu-grid { grid-template-columns: repeat(4, minmax(0,1fr)); } }
@media (max-width: 900px)  { #filterMenu.menu-grid { grid-template-columns: repeat(3, minmax(0,1fr)); } }
@media (max-width: 700px)  { #filterMenu.menu-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 480px)  { #filterMenu.menu-grid { grid-template-columns: 1fr; } }

/* === SectionsDlg polish (Jan 2026): allinea icone bottoni e distanzia la riga 'nuova sezione' === */
/* 1) Icone nei bottoni (blocchi spostamento/elimina) centrati perfettamente */
#sectionsDlg #sectionsList .controls { display:inline-flex; gap: clamp(6px, 1cqw, 10px); }
#sectionsDlg #sectionsList .controls button {
  display: inline-flex; align-items: center; justify-content: center;
  width: clamp(26px, 2.6cqw, 32px); height: clamp(26px, 2.6cqw, 32px);
  padding: 0; line-height: 1; /* evita decentramenti verticali */
}
#sectionsDlg #sectionsList .controls button > * { pointer-events: none; }

/* 2) Allineamento verticale coerente di select e input nella grid */
#sectionsDlg #sectionsList .list-item > select,
#sectionsDlg #sectionsList .list-item > input { align-self: center; }

/* 3) Sezione 'nuova sezione': pi√π respiro e separatore visivo */
#sectionsDlg .content > .row:last-child {
  margin-top: clamp(14px, 2.4cqw, 20px) !important;
  padding-top: clamp(10px, 2cqw, 16px) !important;
  border-top: 1px dashed #1f2937; /* separatore leggero coerente col tema */
}
#sectionsDlg #newSectionName,
#sectionsDlg #newSectionDesc,
#sectionsDlg #newSectionIcon,
#sectionsDlg #newSectionColor,
#sectionsDlg #addSectionBtn {
  height: clamp(34px, 3.2cqw, 40px);
}

/* 4) Micro-affinamenti: bordo e raggio coerenti nelle list-item */
#sectionsDlg #sectionsList .list-item {
  border: 1px solid #1f2937; border-radius: 12px; padding: clamp(10px, 1.6cqw, 14px);
}

#crqBody > .grid{display:block;}
</style>
<style>
/* === v41.1: OP date columns single-line & min width === */
#opTable th:nth-child(8), #opTable td.col-created { white-space: nowrap; min-width: 120px; } /* Inserito il */
#opTable th:nth-child(9), #opTable td.col-due     { white-space: nowrap; min-width: 120px; } /* Scadenza */
#opTable { table-layout: auto; }

/* === v41.2: Gestisci sezioni ‚Üí maggiore distacco riga "Nuova sezione" === */
#sectionsDlg #sectionsList { margin-bottom: clamp(10px, 2cqw, 16px); }
#sectionsDlg .content > .row:last-child {
  margin-top: clamp(28px, 3.6cqw, 40px) !important;
  padding-top: clamp(14px, 2.4cqw, 22px) !important;
  border-top: 1px dashed #1f2937;
}
/* Evita taglio verticale select Icona/Colore */
#sectionsDlg select, #sectionsDlg .content > .row select { padding: 8px 10px; min-height: 36px; height: auto; line-height: 1.2; }
#sectionsDlg #newSectionIcon, #sectionsDlg #newSectionColor { padding-top: 8px; padding-bottom: 8px; min-height: 36px; }

/* === v41.3: Servizi ‚Üí nuova colonna STATO + rebalance larghezze === */
/* Colonne contate includendo la colonna ID (hidden) come 1¬™ */
#svcTable th:nth-child(3),  #svcTable td:nth-child(3)  { width: 64px; }      /* TIPO */
#svcTable th:nth-child(6),  #svcTable td:nth-child(6)  { width: 120px; }     /* fallback JDBC/SWP */
#svcTable th:nth-child(12), #svcTable td:nth-child(12) { width: 140px; }     /* STATO (wrap) */
#svcTable th:nth-child(13), #svcTable td:nth-child(13) { width: 96px; white-space: nowrap; } /* Azioni */
</style>
<style>
/* === v41.4a: TIPO leggermente pi√π largo, spazio preso da APPLICATIVO === */
#svcTable th:nth-child(3), #svcTable td:nth-child(3) { width: 84px; }      /* TIPO */
#svcTable th:nth-child(9), #svcTable td:nth-child(9) { width: 120px; }     /* APPLICATIVO */
</style>
<style>
/* === v41.4b: Impaginazione dialog "Filtra Servizi" ‚Äî compatta, a griglia, senza x-scroll === */
/* Contenitore e tipografia coerenti con le altre dialog */
#svcFilterDlg .modal { display:flex; flex-direction:column; }
#svcFilterDlg .modal .content { flex:1; overflow:auto; padding: clamp(12px, 2cqw, 24px); }

/* Griglia delle card del filtro (3 colonne su desktop, 2 su tablet, 1 su mobile) */
#svcFilterDlg .opf-grid { 
  display:grid; 
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: clamp(10px, 1.2cqw, 16px);
  align-items: start;
}
@media (max-width: 1000px){ #svcFilterDlg .opf-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
@media (max-width: 640px){ #svcFilterDlg .opf-grid{ grid-template-columns: 1fr; } }

/* Card del filtro: sfondo, bordo e raggio coerenti con il tema */
#svcFilterDlg .opf-card{
  background:#0b1023; 
  border:1px solid #1f2937; 
  border-radius: clamp(8px, 1cqw, 12px);
  padding: clamp(10px, 1.4cqw, 14px);
}
#svcFilterDlg .opf-card h4{ 
  margin: 0 0 8px 0; 
  font-size: clamp(13px, 2cqw, 15px); 
  font-weight: 600; 
}

/* Righe interne con due colonne per input affiancati */
#svcFilterDlg .opf-row{ 
  display:grid; 
  grid-template-columns: 1fr 1fr; 
  gap: clamp(8px, 1cqw, 12px);
}
#svcFilterDlg .row > input,
#svcFilterDlg .opf-row > input{
  min-width: 0; width: 100%; 
  padding: 10px 12px; 
  border:1px solid #263041; 
  background:#0a1227; color: var(--text); 
  border-radius: 10px;
}
#svcFilterDlg .opf-checks label{ display:flex; align-items:center; gap:8px; margin: 4px 0; }

/* Barra azioni sempre visibile al fondo della finestra */
#svcFilterDlg .opf-actions{
  position: sticky; bottom: 0; 
  display:flex; justify-content:flex-end; gap: 8px; 
  padding: 10px 0 0 0; margin-top: 12px; 
  background: linear-gradient(180deg, rgba(11,16,35,0), #0b1023 40%);
  border-top: 1px solid #1f2937; 
}
#svcFilterDlg .opf-actions .primary{ border-color:#2563eb; box-shadow:0 0 0 1px rgba(37,99,235,.25) inset; }

/* Niente scroll orizzontale nella dialog */
#svcFilterDlg, #svcFilterDlg *{ overflow-wrap: anywhere; }
html, body { overflow-x:hidden; }
</style>
<!-- HELP CRQ CSS -->
<style>#helpCrqDlg{border:none;border-radius:14px;max-width:1000px;width:100%}#helpCrqDlg .modal{background:#0b1023;border:1px solid #1f2937;border-radius:14px;overflow:hidden}#helpCrqDlg .modal .content{padding:16px}#helpCrqDlg .modal-bar{display:grid;grid-template-columns:1fr auto;align-items:center;padding:12px var(--edge);background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-bottom:1px solid #1f2937}.modal-bar .title{font-weight:600}#helpCrqTableWrap{width:100%;overflow:auto}#helpCrqTable{width:100%;border-collapse:collapse;color:var(--text)}#helpCrqTable th,#helpCrqTable td{border:1px solid #1f2937;padding:8px 10px;font-size:13px;vertical-align:top}#helpCrqTable th{background:#0a1227;text-align:left;color:var(--text)}#helpCrqTable tbody tr:nth-child(odd){background:#0b1023}#helpCrqTable tbody tr:nth-child(even){background:#0c142f}#helpCrqTable tr[data-bmc]{cursor:pointer}#helpCrqTable tr[data-bmc]:hover{background:#0e1732}#helpCrqTable tr[data-bmc].copied{box-shadow:inset 0 0 0 2px rgba(34,197,94,.35)}#helpCrqTable tr[data-bmc]:focus{outline:2px dashed #22c55e;outline-offset:-2px}#helpCrqTable a{color:#e5e7eb;text-decoration-color:rgba(229,231,235,.6)}#helpCrqTable a:hover{color:#ffffff;text-decoration-color:#ffffff}</style>
<!-- HELP CRQ ULTRA-FALLBACK CSS --><style>#helpCrqOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:9999}#helpCrqCard{position:fixed;left:50%;top:6vh;transform:translateX(-50%);width:min(1000px,94vw);max-height:88vh;overflow:auto;background:#0b1023;color:#e5e7eb;border:1px solid #1f2937;border-radius:14px;display:none;z-index:10000}#helpCrqCard header{display:grid;grid-template-columns:1fr auto;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2937;background:linear-gradient(90deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}#helpCrqCloseBtn{border:1px solid #263041;background:#0b1328;color:#e5e7eb;padding:6px 10px;border-radius:8px;cursor:pointer;margin-left:8px}#helpCrqCard .body{padding:16px}</style>
<style>
/* OP wide */
html body #opFilterDlg { width: clamp(1400px, 98vw, 1920px); max-width: 1920px; }
html body .opf-grid-op{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: clamp(12px, 1.2cqw, 18px); align-items:start; }
@media (max-width: 1700px){ html body .opf-grid-op{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
@media (max-width: 1400px){ html body .opf-grid-op{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
@media (max-width: 1000px){ html body .opf-grid-op{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 640px){  html body .opf-grid-op{ grid-template-columns: 1fr; } }
html body #opFilterDlg .opf-card{ background:#0b1023; border:1px solid #1f2937; border-radius: clamp(10px, 1.2cqw, 14px); padding: clamp(12px, 1.6cqw, 18px); }
html body #opFilterDlg .opf-card h4{ margin: 0 0 10px 0; font-size: clamp(14px, 2.2cqw, 16px); font-weight: 600; }
html body #opFilterDlg .opf-row{ display:grid; grid-template-columns: 1fr 1fr; gap: clamp(10px, 1cqw, 14px); }
html body #opFilterDlg .opf-actions{ position: sticky; bottom: 0; display:flex; justify-content:flex-end; gap: 10px; padding: 12px 0 0 0; margin-top: 14px; background: linear-gradient(180deg, rgba(11,16,35,0), #0b1023 40%); border-top: 1px solid #1f2937; }

/* SVC wide */
html body #svcFilterDlg { width: clamp(1400px, 98vw, 1920px); max-width: 1920px; }
html body #svcFilterDlg .content{ padding: clamp(14px, 2cqw, 24px); }
html body .svc-grid-op{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: clamp(12px, 1.2cqw, 18px); align-items:start; }
@media (max-width: 1700px){ html body .svc-grid-op{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
@media (max-width: 1400px){ html body .svc-grid-op{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
@media (max-width: 1000px){ html body .svc-grid-op{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 640px){  html body .svc-grid-op{ grid-template-columns: 1fr; } }
html body #svcFilterDlg .opf-card{ background:#0b1023; border:1px solid #1f2937; border-radius: clamp(10px, 1.2cqw, 14px); padding: clamp(12px, 1.6cqw, 18px); }
html body #svcFilterDlg .opf-card h4{ margin: 0 0 10px 0; font-size: clamp(14px, 2.2cqw, 16px); font-weight: 600; }
html body #svcFilterDlg .opf-row{ display:grid; grid-template-columns: 1fr 1fr; gap: clamp(10px, 1cqw, 14px); }
html body #svcFilterDlg input[type="text"], html body #svcFilterDlg input[placeholder]{ min-height:38px; min-width:0; width:100%; }
html body #svcFilterDlg .opf-checks label{ display:flex; align-items:center; gap:8px; margin: 4px 0; }
html body #svcFilterDlg .opf-actions{ position: sticky; bottom: 0; display:flex; justify-content:flex-end; gap: 10px; padding: 12px 0 0 0; margin-top: 14px; background: linear-gradient(180deg, rgba(11,16,35,0), #0b1023 40%); border-top: 1px solid #1f2937; }
</style>
<style>
html body #servicesDlg { width: clamp(1400px, 98vw, 1920px); max-width: 1920px; }
#servicesDlg .modal { display:flex; flex-direction:column; }
#servicesDlg .modal .content { flex:1; overflow:auto; padding: clamp(12px, 2cqw, 24px); }
</style>
<style>
/* === OP Accordion Wide Dialog (v1) === */
html body #openPointsDlg { width: clamp(1600px, 98vw, 2200px); max-width: 2200px; }
#openPointsDlg .modal { display:flex; flex-direction:column; }
#openPointsDlg .modal .content { flex:1; overflow:auto; padding: clamp(12px, 2cqw, 24px); }
/* Ensure OP table container grows to fit columns without x-scroll */
#openPointsDlg #opTableWrap { overflow-x: visible; }
</style>
<style>
html body #linksDlg { width: clamp(1400px, 98vw, 1920px); max-width: 1920px; }
#linksDlg .modal { display:flex; flex-direction:column; }
#linksDlg .modal .content { flex:1; overflow:auto; padding: clamp(12px, 2cqw, 24px); }
</style>
<style>
/* === HOME: Menu Principale (hero + mega bottoni) ‚Äî Palette BPER === */
.home-hero { margin: clamp(14px, 3vw, 28px) 0; text-align: center; }
.home-hero h2 { margin: 0 0 clamp(10px, 2vw, 18px) 0; font-size: clamp(22px, 4.2vw, 34px); letter-spacing: 0.3px; }

.home-menu { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: clamp(10px, 1.4cqw, 16px); align-items: stretch; justify-items: center; }
@media (max-width: 900px) { .home-menu { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
@media (max-width: 520px) { .home-menu { grid-template-columns: 1fr; } }

.home-tile { width: 100%; display: grid; grid-auto-rows: minmax(0, auto); align-content: center; text-align: left; padding: clamp(12px, 2cqw, 16px); border: 1px solid #1f2937; background: #0b1023; border-radius: clamp(10px, 1.2cqw, 14px); cursor: pointer; transition: transform .05s ease, background .15s ease, border-color .15s ease; }
.home-tile:hover { background: #0a1227; transform: translateY(-1px); border-color: #263041; }
.home-tile:active { transform: translateY(0); }

.home-tile .tile-head { display: grid; grid-template-columns: 64px 1fr; column-gap: clamp(8px, 1.2cqw, 12px); align-items: center; }
.home-tile .tile-ico { display: flex; align-items: center; justify-content: center; width: 64px; height: 64px; border-radius: 14px; border: 1px solid #1f2937; background: #0a1227; font-size: clamp(28px, 5.2cqw, 36px); line-height: 1; }
.home-tile .tile-title { margin: 0; font-weight: 700; font-size: clamp(15px, 2.6cqw, 18px); }
.home-tile .tile-desc { margin: 4px 0 0 0; color: var(--muted); font-size: clamp(12px, 2cqw, 13px); }

/* Accenti colore in stile BPER: azzurro, giallo, viola tenue, verde, rosso scuro, blu */
.tile-links .tile-ico { box-shadow: 0 0 0 1px rgba(56,189,248,.25) inset; color:#7dd3fc; }
.tile-op    .tile-ico { box-shadow: 0 0 0 1px rgba(250,204,21,.25) inset;  color:#fde68a; }
.tile-crq   .tile-ico { box-shadow: 0 0 0 1px rgba(167,139,250,.25) inset; color:#c4b5fd; }
.tile-svc   .tile-ico { box-shadow: 0 0 0 1px rgba(34,197,94,.25) inset;  color:#86efac; }
.tile-clear .tile-ico { box-shadow: 0 0 0 1px rgba(127,29,29,.35) inset;  color:#fecaca; }
.tile-save  .tile-ico { box-shadow: 0 0 0 1px rgba(37,99,235,.35) inset;  color:#bfdbfe; }

/* (Opzionale) nascondi i pulsanti piccoli in header: DISATTIVATO DI DEFAULT */
/*
header .toolbar #linksBtn,
header .toolbar #openPointsBtn,
header .toolbar #helpCrqBtn,
header .toolbar #servicesBtn,
header .toolbar #clearAllBtn,
header .toolbar #saveRepoBtn {
  display: none !important;
}
*/
</style>
<style>.home-menu .tile-save .tile-ico{box-shadow:0 0 0 1px rgba(37,99,235,.35) inset;color:#bfdbfe;}
#linksToolbar #linksRepoLoadBtn{border-color:#059669;box-shadow:0 0 0 1px rgba(5,150,105,.25) inset;}
#linksToolbar #linksRepoLoadBtn:hover{background:#0b1023;color:#a7f3d0;}</style><style>
html body #crqFilterDlg { width: clamp(1400px, 98vw, 1920px); max-width: 1920px; }
#crqListDlg .modal { display:flex; flex-direction:column; }
#crqListDlg .modal .content { flex:1; overflow:auto; padding: clamp(12px, 2cqw, 24px); }
#crqTableWrap { width:100%; overflow:auto; max-height: var(--op-max); }
#crqSummaryBar { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #1f2937; background:#0a1227; position:sticky; top:0; z-index:1; }
#crqSummaryBar .count { color: var(--muted); font-size:13px; }
th.sortable { cursor:pointer; user-select:none; }
th.sortable .arrow { opacity:.7; margin-left:6px; }
</style>

<style>
/* === CRQ Wide like OP === */
html body #crqListDlg { width: clamp(1600px, 98vw, 2200px); max-width: 2200px; }
#crqListDlg .modal { display:flex; flex-direction:column; }
#crqListDlg .modal .content { flex:1; overflow:auto; padding: clamp(12px, 2cqw, 24px); }
/* Ensure CRQ table grows to fit columns without x-scroll */
#crqListDlg #crqTableWrap { overflow-x: visible; }
</style>

<style>
.app-dialog .content button{font-size:14px;padding:8px 12px;border-radius:10px}
.app-dialog .content button.primary{border-color:#2563eb;box-shadow:0 0 0 1px rgba(37,99,235,.25) inset}
</style>

<style>
.home-tile{background:#0a1227;border-color:#2b3a53}
.home-tile:hover{background:#0b132e;border-color:#3a4c6b}
.home-tile .tile-ico{background:#0a1227;border-color:#334155;box-shadow:0 1px 0 rgba(0,0,0,.25) inset}
.home-tile .tile-title{color:#ffffff}
.home-tile .tile-desc{color:#cbd5e1}
.home-tile:focus-visible{outline:2px solid #22c55e;outline-offset:2px;border-radius:12px}
</style>
<style>
#crqListDlg .modal .content{display:flex;flex-direction:column}
#crqBody{display:flex;flex-direction:column}
#crqSummaryBar{order:0}
#crqTableWrap{order:1;flex:1 1 auto;width:100%;overflow:auto}
#crqTable{width:100%}
</style>
<style>
#crqListDlg .modal .content{display:flex;flex-direction:column}
#crqBody{display:flex;flex-direction:column}
#crqSummaryBar{order:0}
#crqTableWrap{order:1;flex:1 1 auto;width:100%;overflow:auto}
#crqTable{width:100%}
</style>

<style>
/* === v2.1.8: Filtri CRQ & Open Points allineati allo stile 'Filtra Servizi' (solo CSS) === */
html body #opFilterDlg .opf-card,
html body #crqFilterDlg .opf-card { background:#0b1023; border:1px solid #1f2937; border-radius:clamp(10px,1.2cqw,14px); padding:clamp(12px,1.6cqw,18px); }
html body #opFilterDlg .opf-card h4,
html body #crqFilterDlg .opf-card h4 { margin:0 0 10px 0; font-size:clamp(14px,2.2cqw,16px); font-weight:600; }
html body #opFilterDlg .opf-row,
html body #crqFilterDlg .opf-row { display:grid; grid-template-columns:1fr 1fr; gap:clamp(10px,1cqw,14px); }
html body #opFilterDlg .opf-card input[type="text"],
html body #opFilterDlg .opf-card input[type="date"],
html body #crqFilterDlg .opf-card input[type="text"],
html body #crqFilterDlg .opf-card input[type="date"] { min-height:38px; min-width:0; width:100%; padding:10px 12px; border:1px solid #263041; background:#0a1227; color:var(--text); border-radius:10px; outline:none; }
html body #opFilterDlg .opf-card input[type="text"]::placeholder,
html body #crqFilterDlg .opf-card input[type="text"]::placeholder { color:var(--muted); }
html body #opFilterDlg .row > input,
html body #crqFilterDlg .row > input { min-height:38px; padding:10px 12px; border:1px solid #263041; background:#0a1227; color:var(--text); border-radius:10px; }
html body #opFilterDlg .opf-checks,
html body #crqFilterDlg .opf-checks { padding:6px 8px; border:1px solid #263041; border-radius:10px; background:#0a1227; }
html body #opFilterDlg .opf-checks label,
html body #crqFilterDlg .opf-checks label { display:flex; align-items:center; gap:8px; margin:4px 0; color:var(--text); }
html body #opFilterDlg .opf-actions,
html body #crqFilterDlg .opf-actions { position:sticky; bottom:0; display:flex; justify-content:flex-end; gap:10px; padding:12px 0 0 0; margin-top:14px; background:linear-gradient(180deg, rgba(11,16,35,0), #0b1023 40%); border-top:1px solid #1f2937; }
</style>


<style>
/* === v2.1.8: Forza TUTTE le input box dei FILTRI in stile scuro/blu (niente box bianchi) === */
:root{
  --filter-input-bg: #0b2a52;
  --filter-input-bg2: #0a2447;
  --filter-input-border: #2b4d78;
  --filter-input-radius: 18px;
  --filter-input-minh: 46px;
  --filter-input-pad-y: 12px;
  --filter-input-pad-x: 14px;
}

/* Scope: solo finestre FILTRI */
html body #svcFilterDlg,
html body #opFilterDlg,
html body #crqFilterDlg{ color-scheme: dark; }

/* Input + select dentro i filtri */
html body #svcFilterDlg input,
html body #svcFilterDlg select,
html body #opFilterDlg input,
html body #opFilterDlg select,
html body #crqFilterDlg input,
html body #crqFilterDlg select{
  appearance: none;
  -webkit-appearance: none;
  background: var(--filter-input-bg) !important;
  border: 1px solid var(--filter-input-border) !important;
  color: var(--text) !important;
  border-radius: var(--filter-input-radius) !important;
  min-height: var(--filter-input-minh) !important;
  padding: var(--filter-input-pad-y) var(--filter-input-pad-x) !important;
  box-shadow: 0 0 0 1px rgba(11,42,82,.35) inset;
}

/* Eccezione: checkbox/radio NON diventano pillole */
html body #svcFilterDlg input[type="checkbox"],
html body #svcFilterDlg input[type="radio"],
html body #opFilterDlg input[type="checkbox"],
html body #opFilterDlg input[type="radio"],
html body #crqFilterDlg input[type="checkbox"],
html body #crqFilterDlg input[type="radio"]{
  appearance: auto;
  -webkit-appearance: auto;
  min-height: auto !important;
  padding: 0 !important;
  border-radius: 4px !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Placeholder */
html body #svcFilterDlg input::placeholder,
html body #opFilterDlg input::placeholder,
html body #crqFilterDlg input::placeholder{ color: rgba(148,163,184,.95) !important; }

/* Focus */
html body #svcFilterDlg input:focus,
html body #svcFilterDlg select:focus,
html body #opFilterDlg input:focus,
html body #opFilterDlg select:focus,
html body #crqFilterDlg input:focus,
html body #crqFilterDlg select:focus{
  outline: none;
  border-color: #3b82f6 !important;
  box-shadow: 0 0 0 2px rgba(59,130,246,.28), 0 0 0 1px rgba(11,42,82,.35) inset;
}

/* Date picker icon (Chrome/Edge) */
html body #svcFilterDlg input[type="date"]::-webkit-calendar-picker-indicator,
html body #opFilterDlg input[type="date"]::-webkit-calendar-picker-indicator,
html body #crqFilterDlg input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1) opacity(.85); }

/* Autofill (Chrome): evita giallo/bianco */
html body #svcFilterDlg input:-webkit-autofill,
html body #opFilterDlg input:-webkit-autofill,
html body #crqFilterDlg input:-webkit-autofill{
  -webkit-text-fill-color: var(--text) !important;
  box-shadow: 0 0 0 1000px var(--filter-input-bg) inset !important;
  transition: background-color 9999s ease-in-out 0s;
}

/* Checkbox group container coerente */
html body #svcFilterDlg .opf-checks,
html body #opFilterDlg .opf-checks,
html body #crqFilterDlg .opf-checks{
  background: var(--filter-input-bg2) !important;
  border: 1px solid var(--filter-input-border) !important;
  border-radius: 16px !important;
}
</style>

</head>
<body>
<header>
<div class="wrap">
<h1><span class="dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--accent);"></span>BPER Banca ‚Äì Team Sistemi Anagrafici</h1>
<div class="toolbar">

</div>
</div>
</header>
<main class="wrap">
<!-- === HOME: MENU PRINCIPALE === -->
<section aria-label="Menu principale" class="home-hero">
<h2>Menu Principale</h2>
<div class="home-menu">
<button class="home-tile tile-links" onclick="openLinksDialog()" type="button">
<div class="tile-head">
<div class="tile-ico">üîó</div>
<div>
<p class="tile-title">LINK UTILI</p>
<p class="tile-desc">Raccolta link per sezioni, import/export e gestione</p>
</div>
</div>
</button>
<button class="home-tile tile-op" onclick="openOpenPointsDialog &amp;&amp; openOpenPointsDialog()" type="button">
<div class="tile-head">
<div class="tile-ico">üìù</div>
<div>
<p class="tile-title">OPEN POINTS</p>
<p class="tile-desc">Apri/gestisci Open Points, filtri, export</p>
</div>
</div>
</button>
<button class="home-tile tile-crq" onclick="openCrqList && openCrqList()" type="button">
<div class="tile-head">
<div class="tile-ico">üìã</div>
<div>
<p class="tile-title">CRQ</p>
<p class="tile-desc">Mappatura stati e strumenti CRQ</p>
</div>
</div>
</button>
<button class="home-tile tile-svc" onclick="openServicesDialog()" type="button">
<div class="tile-head">
<div class="tile-ico">üõ†</div>
<div>
<p class="tile-title">SERVIZI</p>
<p class="tile-desc">Catalogo REST/SOAP, filtri ed export</p>
</div>
</div>
</button>
<button class="home-tile tile-clear" onclick="clearAll()" title="Pulisci tutte le sezioni, link, OP e servizi (irreversibile)" type="button">
<div class="tile-head">
<div class="tile-ico">üßπ</div>
<div>
<p class="tile-title">PULISCI TUTTO</p>
<p class="tile-desc">Azzera dati locali (localStorage)</p>
</div>
</div>
</button>
<button class="home-tile tile-save" onclick="(window.handleSave ? window.handleSave() : alert('Funzione non disponibile'))" type="button">
<div class="tile-head">
<div class="tile-ico">üíæ</div>
<div>
<p class="tile-title">SALVA SU REPO</p>
<p class="tile-desc">Esegue il salvataggio ‚Äú1‚Äëclick‚Äù sul repo</p>
</div>
</div>
</button>
<button class="home-tile tile-save" onclick="window.reloadFromRepo ? window.reloadFromRepo(true) : alert('Funzione non disponibile');" type="button"><div class="tile-head"><div class="tile-ico">üì•</div><div><p class="tile-title">CARICA DA REPO</p><p class="tile-desc">Legge i file in /data e aggiorna</p></div></div></button>
<button class="home-tile tile-save" onclick="window.loadFromFolder ? window.loadFromFolder() : alert('Funzione non disponibile')" type="button"><div class="tile-head"><div class="tile-ico">üìÅ</div><div><p class="tile-title">CARICA DA CARTELLA</p><p class="tile-desc">Seleziona una cartella e importa i file JSON (link, OP, CRQ, servizi)</p></div></div></button>
</div>
</section>
<!-- ===== SEZIONE: OPEN POINTS ===== -->
&gt;
</main>
<footer>Supporto Team
<!-- CRQ DIALOG (OP-style) -->
<dialog id="crqListDlg">
  <div class="modal">
    <header class="modal-bar">
      <span class="title">Change Requests (CRQ)</span>
      <button aria-label="Chiudi" class="close" id="crqCloseXBtn">‚úï</button>
    </header>
    <div class="content">
      <section class="section" id="crqSection">
        <div class="section-header" style="background: linear-gradient(90deg, #4c1d95, #5b21b6); border-bottom: 1px solid #5b21b680;">
          <div class="section-title">
            <button class="toggle" id="crqToggle">‚ñæ</button>
            <span>üìã</span> <span>Change Requests (CRQ)</span>
          </div>
          <div class="section-actions">
            <button onclick="openCrqEditor()">‚ûï Nuovo</button>
            <button onclick="exportCrqToFile()">üíæ Salva</button>
            <button onclick="importCrqFromFile()">üì• Carica</button>
            <button onclick="openCrqFilterDialog()">üîé Filtra</button>
            <button onclick="exportCrqToCSV()">üì§ CSV</button>
            <button onclick="exportCrqToExcel()">üì§ Excel (.xls)</button>
 <button onclick="openHelpCrq()" title="Apri Help CRQ">‚ùî Help</button>
            <button class="danger" onclick="clearCrq()">üßπ Pulisci</button>
          </div>
        </div>
        <div id="crqBody">
          <div class="grid" style="padding:0">
            <div id="crqSummaryBar"><div class="count" id="crqCount">0 risultati</div></div>
            <div id="crqTableWrap">
              <table class="table" id="crqTable"></table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</dialog>

<!-- CRQ EDITOR -->
<dialog id="crqEditorDlg">
  <div class="modal">
    <header class="modal-bar">
      <span class="title" id="crqDlgTitle">Nuova CRQ</span>
      <button aria-label="Chiudi" class="close" id="crqEditorCloseXBtn">‚úï</button>
    </header>
    <div class="content">
      <div class="row"><input id="crqRfcAperti" placeholder="RFC Aperti *"/></div>
      <div class="row">
        <input id="crqDataApertura" placeholder="Data apertura" type="date"/>
        <input id="crqAnno" placeholder="Anno"/>
      </div>
      <div class="row">
        <select id="crqEmerg">
          <option value="">Emerg.: n/d</option>
          <option>No</option>
          <option>S√¨</option>
        </select>
        <select id="crqUtilizzato">
          <option value="">Utilizzato: n/d</option>
          <option>Si</option>
          <option>No</option>
        </select>
      </div>
      <div class="row"><input id="crqCategoria" placeholder="Categoria"/></div>
      <div class="row">
        <input id="crqDataRilascio" placeholder="Data rilascio" type="date"/>
        <input id="crqRifNostro" placeholder="Rif nostro"/>
      </div>
      <div class="row"><input id="crqPrj" placeholder="PRJ"/></div>
      <div class="row"><textarea id="crqContenuto" placeholder="Contenuto"></textarea></div>
      <div class="row" style="justify-content:flex-end">
        <button id="crqCancelBtn">Annulla</button>
        <button class="primary" id="crqSaveBtn">Salva</button>
      </div>
    </div>
  </div>
</dialog>

<!-- CRQ FILTER DIALOG (OP-style cards) -->
<dialog id="crqFilterDlg">
  <div class="modal">
    <header class="modal-bar">
      <span class="title">Filtra CRQ</span>
      <button aria-label="Chiudi" class="close" id="crqFilterCloseXBtn">‚úï</button>
    </header>
    <div class="content">
      <div class="row"><input id="crqfText" placeholder="Cerca in tutte le colonne (RFC/PRJ/Categoria/Contenuto/Rif/Anno)"/></div>
      <div class="opf-grid opf-grid-op">
        <div class="opf-card"><h4>RFC Aperti</h4><input id="crqfRfc" placeholder="RFC contiene..."/></div>
        <div class="opf-card"><h4>Data apertura</h4><div class="opf-row"><input id="crqfAperturaFrom" type="date"/><input id="crqfAperturaTo" type="date"/></div></div>
        <div class="opf-card"><h4>Anno</h4><input id="crqfAnno" placeholder="Anno"/></div>
        <div class="opf-card"><h4>Emergenza</h4><div class="opf-checks" id="crqfEmergGroup"><label><input type="checkbox" value="No"/> No</label><label><input type="checkbox" value="S√¨"/> S√¨</label></div></div>
        <div class="opf-card"><h4>Utilizzato</h4><div class="opf-checks" id="crqfUtilGroup"><label><input type="checkbox" value="Si"/> Si</label><label><input type="checkbox" value="No"/> No</label></div></div>
        <div class="opf-card"><h4>Categoria</h4><input id="crqfCategoria" placeholder="Categoria contiene..."/></div>
        <div class="opf-card"><h4>Data rilascio</h4><div class="opf-row"><input id="crqfRilFrom" type="date"/><input id="crqfRilTo" type="date"/></div></div>
        <div class="opf-card"><h4>Rif nostro</h4><input id="crqfRif" placeholder="Rif contiene..."/></div>
        <div class="opf-card"><h4>PRJ</h4><input id="crqfPrj" placeholder="PRJ contiene..."/></div>
        <div class="opf-card"><h4>Contenuto</h4><input id="crqfContenuto" placeholder="Contenuto contiene..."/></div>
      </div>
      <div class="opf-actions" style="margin-top:12px">
        <button id="crqfResetBtn">Azzera</button>
        <button class="primary" id="crqfApplyBtn">Applica</button>
      </div>
    </div>
  </div>
</dialog>
</footer>
<!-- Dialog: Link -->
<dialog id="dialog"><div class="modal">
<header class="modal-bar"><span class="title" id="dlgTitle">Nuovo link</span><button aria-label="Chiudi" class="close" id="closeXBtn">‚úï</button></header>
<div class="content">
<div class="row"><input id="fTitle" placeholder="Titolo"/></div>
<div class="row"><input id="fUrl" placeholder="URL (https://‚Ä¶)"/></div>
<div class="row"><textarea id="fDesc" placeholder="Descrizione (opzionale)"></textarea></div>
<div class="row"><input id="fTags" placeholder="Tag separati da virgola (es. progetto, clienti)"/></div>
<div class="row"><select id="fSection"></select></div>
<div class="row" style="justify-content:flex-end"><button id="cancelBtn">Annulla</button><button class="primary" id="saveBtn">Salva</button></div>
</div>
</div></dialog>
<!-- Dialog: Gestisci sezioni -->
<dialog id="sectionsDlg"><div class="modal">
<header class="modal-bar"><span class="title">Gestisci sezioni</span><button aria-label="Chiudi" class="close" id="closeSectionsBtn">‚úï</button></header>
<div class="content">
<div class="fit-viewport" data-fit="true" data-max-scale="1">
<div class="fit-content">
<div class="list" id="sectionsList"></div>
<div class="row">
<input id="newSectionName" placeholder="Nome nuova sezione"/>
<input id="newSectionDesc" placeholder="Descrizione (opzionale)"/>
<select class="iconSel" id="newSectionIcon">
<option value="">Icona (auto)</option>
<option>üìÅ</option><option>üë•</option><option>üß©</option><option>üìÇ</option><option>üìù</option><option>üìå</option><option>üìä</option><option>üìé</option><option>üõ†</option><option>üóÉ</option><option>üìÖ</option><option>üß™</option><option>üí°</option><option>‚úÖ</option><option>‚öô</option>
</select>
<select id="newSectionColor"><option value="">Colore (auto)</option></select>
<button class="primary" id="addSectionBtn">Aggiungi</button>
</div>
</div>
</div>
</div>
</div></dialog>
<!-- Dialog: Men√π sezioni -->
<dialog id="filterSectionsDlg"><div class="modal">
<header class="modal-bar"><span class="title">Filtra sezioni</span><button aria-label="Chiudi" class="close" id="fsCloseBtn">‚úï</button></header>
<div class="content">
<div class="fit-viewport" data-fit="true" data-max-scale="1">
<div class="fit-content">
<div class="list menu-grid" id="filterMenu"></div>
</div>
</div>
</div>
</div></dialog>
<!-- Dialog: Link Utili (container con accordion link) -->
<dialog id="linksDlg"><div class="modal">
<header class="modal-bar"><span class="title">Link utili</span><button aria-label="Chiudi" class="close" id="linksCloseXBtn">‚úï</button></header>
<div class="content">
<div class="toolbar" id="linksToolbar" style="display:flex;gap:8px;flex-wrap:wrap;margin:0 0 10px 0;"><input id="q" placeholder="Cerca per titolo, tag o descrizione‚Ä¶ (‚åò/Ctrl + K)" type="search"/><button id="filterSectionsBtn" title="Apri menu sezioni">üè† Menu</button>
<button id="newBtn">‚ûï Nuovo link</button>
<button id="manageSectionsBtn">üìÇ Gestisci sezioni</button>
<button id="exportBtn">üíæ Salva link</button>
<button id="importBtn">üì• Carica link</button>
<button id="clearLinksBtn" class="danger" title="Elimina solo i link (non tocca sezioni/OP/Servizi/CRQ)">üßπ Pulisci link</button></div>
<div id="container"></div>
</div>
</div></dialog>
<!-- Dialog: Open Points -->
<dialog id="opDialog"><div class="modal">
<header class="modal-bar">
<span class="title" id="opDlgTitle">Nuovo open point</span>
<button aria-label="Chiudi" class="close" id="opCloseXBtn">‚úï</button>
</header>
<div class="content">
<div class="row"><input id="opTitle" placeholder="Titolo *"/></div>
<div class="row"><input id="opProject" placeholder="Progetto"/></div>
<div class="row"><input id="opAssignees" placeholder="Assegnatari (separati da virgola)"/></div>
<div class="row">
<select id="opPriority">
<option value="low">Priorit√†: Bassa</option>
<option selected="" value="medium">Priorit√†: Media</option>
<option value="high">Priorit√†: Alta</option>
<option value="critical">Priorit√†: Critica</option>
</select>
</div>
<div class="row">
<select id="opStatus">
<option selected="" value="Nuovo">Stato: Nuovo</option>
<option value="Da fare">Stato: Da fare</option>
<option value="In corso">Stato: In corso</option>
<option value="Schedulato">Stato: Schedulato</option>
<option value="Completato">Stato: Completato</option>
</select>
<label style="display:inline-flex;align-items:center;gap:8px;margin-left:10px">
<input id="opMaxPrio" type="checkbox"/> Priorit√† massima
 </label>
</div>
<div class="row">
<input id="opCreatedAt" placeholder="Data inserimento" type="date"/>
<input id="opDueAt" placeholder="Scadenza" type="date"/>
</div>
<div class="row"><textarea id="opDesc" placeholder="Descrizione"></textarea></div>
<div class="row"><textarea id="opNotes" placeholder="Note"></textarea></div>
<div class="row" style="justify-content:flex-end">
<button id="opCancelBtn">Annulla</button>
<button class="primary" id="opSaveBtn">Salva</button>
</div>
</div>
</div></dialog>
<!-- Dialog: Filtro OP -->
<!-- Dialog: Filtro OP (ORIZZONTALE) -->
<dialog id="opFilterDlg">
<div class="modal">
<header class="modal-bar">
<span class="title">Filtra Open Points</span>
<button aria-label="Chiudi" class="close" id="opFilterCloseXBtn">‚úï</button>
</header>
<div class="content">
<div class="row">
<input id="opfText" placeholder="Cerca in tutte le colonne (titolo, progetto, assegnatari, descrizione, note, stato, priorit√†)"/>
</div>
<div class="opf-grid opf-grid-op">
<div class="opf-card">
<h4>ID / Titolo</h4>
<div class="opf-row">
<input id="opfId" placeholder="ID contiene‚Ä¶"/>
<input id="opfTitle" placeholder="Titolo contiene‚Ä¶"/>
</div>
</div>
<div class="opf-card">
<h4>Progetti / Assegnatari</h4>
<div class="opf-row">
<input id="opfProjects" placeholder="Progetti (virgole)"/>
<input id="opfAssignees" placeholder="Assegnatari (virgole)"/>
</div>
</div>
<div class="opf-card">
<h4>Descrizione / Note</h4>
<div class="opf-row">
<input id="opfDesc" placeholder="Descrizione contiene‚Ä¶"/>
<input id="opfNotes" placeholder="Note contengono‚Ä¶"/>
</div>
</div>
<div class="opf-card">
<h4>Priorit√†</h4>
<div class="opf-checks" id="opfPrioGroup">
<label><input type="checkbox" value="low"/> Bassa</label>
<label><input type="checkbox" value="medium"/> Media</label>
<label><input type="checkbox" value="high"/> Alta</label>
<label><input type="checkbox" value="critical"/> Critica</label>
</div>
</div>
<div class="opf-card">
<h4>Stato</h4>
<div class="opf-checks" id="opfStatusGroup">
<label><input type="checkbox" value="Nuovo"/> Nuovo</label>
<label><input type="checkbox" value="Da fare"/> Da fare</label>
<label><input type="checkbox" value="In corso"/> In corso</label>
<label><input type="checkbox" value="Schedulato"/> Schedulato</label>
<label><input type="checkbox" value="Completato"/> Completato</label>
</div>
</div>
<div class="opf-card">
<h4>Inserito il</h4>
<div class="opf-row">
<input id="opfCreatedFrom" placeholder="Creato dal" type="date"/>
<input id="opfCreatedTo" placeholder="Creato al" type="date"/>
</div>
</div>
<div class="opf-card">
<h4>Scadenza</h4>
<div class="opf-row">
<input id="opfDueFrom" placeholder="Scadenza da" type="date"/>
<input id="opfDueTo" placeholder="Scadenza a" type="date"/>
</div>
</div>
<div class="opf-card">
<h4>Altre opzioni</h4>
<label style="display:flex;align-items:center;gap:8px">
<input id="opfMaxOnly" type="checkbox"/> Solo "Priorit√† massima"
          </label>
</div>
</div>
<div class="opf-actions" style="margin-top:12px">
<button id="opfResetBtn">Azzera</button>
<button class="primary" id="opfApplyBtn">Applica</button>
</div>
</div>
</div>
</dialog>
<!-- Dialog: Salva link -->
<dialog id="saveLinksDlg"><div class="modal">
<header class="modal-bar">
<span class="title">Salva link</span>
<button aria-label="Chiudi" class="close" id="saveLinksCloseBtn">‚úï</button>
</header>
<div class="content">
<div class="row">
<input id="saveLinksFileName" placeholder="Nome file" value="linkhub-links.json"/>
</div>
<div class="row" style="justify-content:flex-end">
<button id="saveLinksCancelBtn">Annulla</button>
<button class="primary" id="saveLinksOkBtn">Salva</button>
</div>
</div>
</div></dialog>
<!-- Dialog: Salva OP -->
<dialog id="saveOPDlg"><div class="modal">
<header class="modal-bar">
<span class="title">Salva Open Points</span>
<button aria-label="Chiudi" class="close" id="saveOPCloseBtn">‚úï</button>
</header>
<div class="content">
<div class="row">
<input id="saveOPFileName" placeholder="Nome file" value="open-points.json"/>
</div>
<div class="row" style="justify-content:flex-end">
<button id="saveOPCancelBtn">Annulla</button>
<button class="primary" id="saveOPOkBtn">Salva</button>
</div>
</div>
</div></dialog>
<!-- Dialog: Servizi -->
<dialog id="serviceDialog"><div class="modal">
<header class="modal-bar">
<span class="title" id="svcDlgTitle">Nuovo servizio</span>
<button aria-label="Chiudi" class="close" id="svcCloseXBtn">‚úï</button>
</header>
<div class="content">
<div class="row"><input id="svcRoutine" placeholder="ROUTINE *"/></div>
<div class="row">
<select id="svcTipo">
<option selected="" value="REST">TIPO: REST</option>
<option value="SOAP">TIPO: SOAP</option>
</select>
</div>
<div class="row"><input id="svcServizio" placeholder="SERVIZIO *"/></div>
<div class="row"><textarea id="svcOperation" placeholder="OPERATION / PARAMETRI (una per riga)"></textarea></div>
<div class="row"><input id="svcFallback" placeholder="fallback JDBC/SWP"/></div>
<div class="row"><textarea id="svcDescrizione" placeholder="DESCRIZIONE"></textarea></div>
<div class="row"><input id="svcAmbito" placeholder="AMBITO"/></div>
<div class="row"><input id="svcApplicativo" placeholder="APPLICATIVO"/></div>
<div class="row"><textarea id="svcParamsIn" placeholder="PARAMETRI DI INGRESSO (uno per riga)"></textarea></div>
<div class="row"><textarea id="svcOutput" placeholder="OUTPUT DEL SERVIZIO (uno per riga)"></textarea></div>
<div class="row" style="justify-content:flex-end">
<button id="svcCancelBtn">Annulla</button>
<button class="primary" id="svcSaveBtn">Salva</button>
</div>
</div>
</div></dialog>
<!-- Dialog: Filtro Servizi -->
<!-- Dialog: Filtro Servizi (ORIZZONTALE, COMPLETO) -->
<dialog id="svcFilterDlg">
<div class="modal">
<header class="modal-bar">
<span class="title">Filtra Servizi</span>
<button aria-label="Chiudi" class="close" id="svcFilterCloseXBtn">‚úï</button>
</header>
<div class="content">
<div class="row"><input id="svcfText" placeholder="Cerca in tutte le colonne (routine, tipo, servizio, operation/parametri, fallback, descrizione, ambito, applicativo, parametri IN, output, stato)"/></div>
<div class="svc-grid-op">
<div class="opf-card">
<h4>ID / Routine</h4>
<div class="opf-row">
<input id="svcfId" placeholder="ID contiene‚Ä¶"/>
<input id="svcfRoutine" placeholder="Routine (virgole)"/>
</div>
</div>
<div class="opf-card">
<h4>Servizio / Tipo</h4>
<div class="opf-row">
<input id="svcfServizi" placeholder="Servizi (virgole)"/>
<div class="opf-checks" id="svcfTipoGroup" style="padding:6px 8px;border:1px solid #263041;border-radius:10px;background:#0a1227;">
<label><input type="checkbox" value="REST"/> REST</label>
<label><input type="checkbox" value="SOAP"/> SOAP</label>
</div>
</div>
</div>
<div class="opf-card">
<h4>Descrizione / Ambito</h4>
<div class="opf-row">
<input id="svcfDescrizione" placeholder="Descrizione contiene‚Ä¶"/>
<input id="svcfAmbiti" placeholder="Ambiti (virgole)"/>
</div>
</div>
<div class="opf-card">
<h4>Applicativo / Fallback</h4>
<div class="opf-row">
<input id="svcfApplicativi" placeholder="Applicativi (virgole)"/>
<input id="svcfFallback" placeholder="Fallback (virgole)"/>
</div>
</div>
<div class="opf-card">
<h4>Operation / Parametri</h4>
<div class="row">
<input id="svcfOperation" placeholder="Operation / Parametri (virgole)"/>
</div>
</div>
<div class="opf-card">
<h4>Parametri &amp; Output</h4>
<div class="opf-row">
<input id="svcfParamsIn" placeholder="Parametri ingresso (virgole)"/>
<input id="svcfOutput" placeholder="Output servizio (virgole)"/>
</div>
</div>
<div class="opf-card">
<h4>Stato</h4>
<div class="opf-checks" id="svcfStatoGroup"></div>
</div>
</div>
<div class="opf-actions" style="margin-top:12px">
<button id="svcfResetBtn">Azzera</button>
<button class="primary" id="svcfApplyBtn">Applica</button>
</div>
</div>
</div>
</dialog>
<!-- DIALOG: SERVIZI (contenitore accordion servizi) -->
<dialog id="servicesDlg">
<div class="modal">
<header class="modal-bar">
<span class="title">Servizi</span>
<button aria-label="Chiudi" class="close" id="servicesCloseXBtn">‚úï</button>
</header>
<div class="content">
<!-- ===== SEZIONE: SERVIZI ===== -->
<section class="section" id="servicesSection">
<div class="section-header" style="background: linear-gradient(90deg, #0e3a43, #0b4a56); border-bottom: 1px solid #0b4a5680;">
<div class="section-title">
<button class="toggle" id="svcToggle">‚ñæ</button>
<span>üõ†</span> <span>Servizi (REST/SOAP)</span>
</div>
<div class="section-actions">
<button onclick="openServiceDialog()">‚ûï Nuovo</button>
<button onclick="exportServicesToFile()">üíæ Salva</button>
<button onclick="importServicesFromFile()">üì• Carica</button>
<button onclick="openSvcFilterDialog()">üîé Filtra</button>
<button onclick="exportServicesToCSV()">üì§ CSV</button>
<button onclick="exportServicesToExcel()">üì§ Excel (.xls)</button>
<button class="danger" onclick="clearServices()">üßπ Pulisci</button></div>
</div>
<div id="svcBody">
<div class="grid" style="padding:0">
<div id="svcTableWrap">
<table class="table" id="svcTable"></table>
</div>
</div>
</div>
</section> </div>
</div>
</dialog>
<script>
// Apertura dialog LINK UTILI
function openLinksDialog(){
  try{ var dlg = document.getElementById('linksDlg'); if(dlg && dlg.showModal){ dlg.showModal(); } else { alert('Apri il file nel browser per usare questa finestra.'); } }
  catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }
}
window.addEventListener('DOMContentLoaded', function(){
  try{ var btn=document.getElementById('linksBtn'); if(btn){ btn.addEventListener('click', openLinksDialog); } }catch(e){}
  try{ var x=document.getElementById('linksCloseXBtn'); if(x){ x.addEventListener('click', function(){ var dlg=document.getElementById('linksDlg'); if(dlg) dlg.close(); }); } }catch(e){}
});
</script>
<script>
// Apertura dialog SERVIZI
function openServicesDialog(){
  try{ var dlg = document.getElementById('servicesDlg'); if(dlg && dlg.showModal){ dlg.showModal(); } else { alert('Apri il file nel browser per usare questa finestra.'); } }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }
}
window.addEventListener('DOMContentLoaded', function(){
  try{ var btn=document.getElementById('servicesBtn'); if(btn){ btn.addEventListener('click', openServicesDialog); } }catch(e){}
  try{ var x=document.getElementById('servicesCloseXBtn'); if(x){ x.addEventListener('click', function(){ var dlg=document.getElementById('servicesDlg'); if(dlg) dlg.close(); }); } }catch(e){}
});
</script>
<script>
  window.AUTOSAVE_ENDPOINT = "https://supportoteam.francesco-romano2.workers.dev";
</script>
<script>
// Polyfills & utils
if(!window.structuredClone){ window.structuredClone = (obj)=> JSON.parse(JSON.stringify(obj)); }
if(!window.crypto){ window.crypto = {}; }
if(!crypto.randomUUID){ crypto.randomUUID = ()=> 'id-' + Math.random().toString(16).slice(2) + '-' + Date.now(); }
function escapeHtml(s){ s = String(s || ''); return s.replace(/[&<>"']/g, function(m){ switch(m){ case '&': return '&amp;'; case '<': return '&lt;'; case '>': return '&gt;'; case '"': return '&quot;'; case "'": return '&#39;'; default: return m; } }); }
function escapeAttr(s){ s=String(s||''); return s.replace(/\"/g,'"'); }
function todayISO(){ try{ return new Date().toISOString().slice(0,10); }catch(_){ return ''; } }
function toast(msg){ var t=document.createElement('div'); t.textContent=msg; t.style.position='fixed'; t.style.bottom='18px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.background='#0b1227'; t.style.border='1px solid #334155'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex=99; t.style.color='#e5e7eb'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); },1600); }

// Palette & storage
var PALETTE = [ { id:'emerald', c1:'#064e3b', c2:'#065f46' }, { id:'blue', c1:'#0b3a68', c2:'#0f447a' }, { id:'indigo', c1:'#312e81', c2:'#3730a3' }, { id:'cyan', c1:'#0e3a43', c2:'#0b4a56' }, { id:'violet', c1:'#4c1d95', c2:'#5b21b6' }, { id:'amber', c1:'#78350f', c2:'#92400e' }, { id:'rose', c1:'#7f1d1d', c2:'#991b1b' } ];
var STORAGE_KEY_V2 = 'linkhub.v2';

function save(st){ try{ localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(st || state)); }catch(e){ console.error('save:', e); } }
function loadState() {
  // Se Repo Mode √® attivo: ignoro completamente il localStorage e NON innesco il demo-seed.
  if (isRepoModeOn()) {
    return { sections: [], links: [], openPoints: [], services: [], crq: [] };
  }

  // Comportamento originale (localStorage come fonte)
  try {
    var raw = localStorage.getItem(STORAGE_KEY_V2);
    if (raw) { return normalizeState(JSON.parse(raw)); }

    // Demo-seed solo quando repoMode √® OFF
    var demo={ sections:[
      {id: crypto.randomUUID(), name:'Team', desc:'Contatti, orari, riunioni', icon:'üë•', collapsed:false, color:{id:'emerald', c1:'#064e3b', c2:'#065f46'}},
      {id: crypto.randomUUID(), name:'Progetti', desc:'Piani, task, roadmap', icon:'üß©', collapsed:false, color:{id:'blue', c1:'#0b3a68', c2:'#0f447a'}},
      {id: crypto.randomUUID(), name:'File', desc:'Documenti e cartelle', icon:'üìÅ', collapsed:false, color:{id:'indigo', c1:'#312e81', c2:'#3730a3'}}
    ], links:[], openPoints:[], services:[] };
    localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(demo));
    return normalizeState(demo);
  } catch(e) {
    console.error('load:', e);
    return { sections: [], links: [], openPoints: [], services: [], crq: [] };
  }
}


function normalizeState(x){
  var PL = (PALETTE && PALETTE.length) ? PALETTE.length : 7;
  var sections = Array.isArray(x.sections)? x.sections.map(function(s,i){ return {
    id: s.id || crypto.randomUUID(),
    name: String(s.name||'Senza nome').trim()||'Senza nome',
    collapsed: !!s.collapsed,
    color: (s.color&&s.color.c1&&s.color.c2)? s.color : PALETTE[i%PL],
    desc: String(s.desc||'').trim(),
    icon: String(s.icon||'').trim()
  }; }) : [{id: crypto.randomUUID(), name:'Generale', collapsed:false, color:PALETTE[0], desc:'', icon:'üìÅ'}];
  var ids = new Set(sections.map(function(s){return s.id;})); var fallback = sections[0]? sections[0].id : '';
  var links = Array.isArray(x.links)? x.links.map(function(l){ return { id: l.id || crypto.randomUUID(), title: (l.title||'').trim(), url: (l.url||'').trim(), desc: (l.desc||'').trim(), tags: (l.tags||[]).map(function(t){return String(t).trim();}).filter(Boolean), sectionId: ids.has(l.sectionId)? l.sectionId : fallback }; }) : [];
  function nOP(o){ var a=(o.assignees||o.assegnatari||''); var arr=Array.isArray(a)? a : String(a).split(',').map(function(s){return s.trim();}).filter(Boolean); return { id: o.id || crypto.randomUUID(), title: String(o.title||o.titolo||'').trim(), project: String(o.project||o.progetto||'').trim(), assignees: arr, priority: (o.priority||o.priorita||o['priorit√†']||'medium').toLowerCase(), status: String(o.status||o.stato||'Nuovo').trim(), maxPriority: !!(o.maxPriority||o.max||o['priorit√†Massima']), createdAt: String(o.createdAt||o.dataInserimento||'').trim(), dueAt: String(o.dueAt||o.dataScadenza||'').trim(), desc: String(o.desc||o.descrizione||'').trim(), notes: String(o.notes||o.note||'').trim() }; }
  var openPoints = Array.isArray(x.openPoints)? x.openPoints.map(nOP) : [];
  function nService(s){ return { id: s.id || crypto.randomUUID(), routine: String(s.routine || '').trim(), tipo: (s.tipo || '').toString().toUpperCase() === 'SOAP' ? 'SOAP' : 'REST', servizio: String(s.servizio || '').trim(), operation: String(s.operation || s['operation / parametro'] || '').trim(), fallback: String(s.fallback || s['fallback JDBC/SWP'] || '').trim(), descrizione: String(s.descrizione || '').trim(), ambito: String(s.ambito || '').trim(), applicativo: String(s.applicativo || s['applicativo'] || '').trim(), paramsIngresso: String(s.paramsIngresso || s['paramsIngresso'] || s['parametriIngresso'] || '').trim(), outputServizio: String(s.outputServizio || s['outputServizio'] || s['output'] || '').trim() }; }
  var services = Array.isArray(x.services) ? x.services.map(nService) : [];

 var crq = Array.isArray(x.crq) ? x.crq.map(function(o){ return typeof normalizeCRQItem==='function' ? normalizeCRQItem(o) : o; }) : [];
  return { sections:sections, links:links, openPoints:openPoints, services:services, crq: crq };
}

// UI state
function loadUIState(){ try { return JSON.parse(localStorage.getItem(UI_STATE_KEY)) || {}; } catch(e){ return {}; } }
function saveUIState(ui){ try { localStorage.setItem(UI_STATE_KEY, JSON.stringify(ui)); } catch(e){} }
var state=null; var UI_STATE_KEY='ui.state.v1';


// === Preferenza 'Dati da repo' (ignora localStorage) ===
const SETTINGS_KEY = 'linkhub.settings.v1';
function loadSettings() { try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; } catch(_) { return {}; } }
function saveSettings(s) { try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s || {})); } catch(_) {} }
function isRepoModeOn(){ try{ var s=loadSettings(); return !!(s && s.repoModeOn); }catch(_) { return false; } }
function setRepoMode(on){ try{ var s=loadSettings(); s.repoModeOn=!!on; saveSettings(s); }catch(_){} }
// Init
window.addEventListener('DOMContentLoaded', initApp);
function initApp(){
  state = loadState();
  // --- Repo Mode UI binding
  try {
    const chk = document.getElementById('repoModeChk');
    if (chk) {
      chk.checked = isRepoModeOn();
      chk.addEventListener('change', function() {
        setRepoMode(chk.checked);
        location.reload();
      });
    }
  } catch(_) {}

  (function restoreSectionUI(){ var ui = loadUIState(); if (!ui.sectionCollapsed) return; try { state.sections.forEach(function(s){ if (ui.sectionCollapsed.hasOwnProperty(s.id)) s.collapsed = ui.sectionCollapsed[s.id]; }); } catch(e){} })();
  render(); renderOpenPoints(); renderServices(); (window.renderCrq ? window.renderCrq() : (function(){try{if(typeof renderCrq==='function') renderCrq();}catch(e){}})()); updateFilterSectionsBtn();
  var q=document.getElementById('q'); if(q) q.addEventListener('input', render);
  window.addEventListener('keydown', function(e){ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); if(q) q.focus(); } });
  (function(){var _el=document.getElementById('exportBtn'); if(_el) _el.onclick=function(){ if(window.showSaveFilePicker) saveLinksWithPicker(); else openSaveLinksDialog(); };})();
  var _im=document.getElementById('importBtn'); if(_im) _im.onclick=importFullJSON;
 var _cl=document.getElementById('clearLinksBtn'); if(_cl) _cl.onclick=(typeof clearLinks==='function' ? clearLinks : function(){
  try{
    if(!window.state){ alert('Stato non inizializzato'); return; }
    if(!confirm('Confermi? Saranno eliminati SOLO i Link. Operazione irreversibile.')) return;
    state.links = [];
    save(state);
    render();
    updateFilterSectionsBtn();
    try{ if(typeof toast==='function') toast('Link eliminati'); }catch(e){}
  }catch(e){ alert('Pulisci link non riuscito: '+(e&&e.message?e.message:e)); }
})
  var _el=document.getElementById('clearAllBtn'); if(_el) _el.onclick=clearAll;
  var _fs=document.getElementById('filterSectionsBtn'); if(_fs) _fs.onclick=openFilterSectionsDialog;
  var _nb=document.getElementById('newBtn'); if(_nb) _nb.onclick=function(){ openDialog(); };
  (function(){var _ms=document.getElementById('manageSectionsBtn'); if(_ms) _ms.onclick=function(){ try{ renderSectionsList(); sectionsDlg.showModal(); setTimeout(function(){ var el=document.getElementById('newSectionName'); if(el) el.focus(); }, 50); }catch(e){ alert('Apri il file nel browser per usare questo dialog.'); } };})();
  var opToggle=document.getElementById('opToggle'), opBody=document.getElementById('opBody'); if(opToggle && opBody){ var uiState = loadUIState(); if (uiState.opCollapsed) { opBody.classList.add('hidden'); opToggle.textContent='‚ñ∏'; } else { opBody.classList.remove('hidden'); opToggle.textContent='‚ñæ'; } opToggle.addEventListener('click', function(){ var collapsed = opBody.classList.toggle('hidden'); opToggle.textContent = collapsed ? '‚ñ∏' : '‚ñæ'; uiState.opCollapsed = collapsed; saveUIState(uiState); }); }
  var svcToggle=document.getElementById('svcToggle'), svcBody=document.getElementById('svcBody'); if(svcToggle && svcBody){ var uiState2 = loadUIState(); if (uiState2.svcCollapsed){ svcBody.classList.add('hidden'); svcToggle.textContent='‚ñ∏'; } else { svcBody.classList.remove('hidden'); svcToggle.textContent='‚ñæ'; } svcToggle.addEventListener('click', function(){ var collapsed = svcBody.classList.toggle('hidden'); svcToggle.textContent = collapsed ? '‚ñ∏' : '‚ñæ'; uiState2.svcCollapsed = collapsed; saveUIState(uiState2); }); }
  // Link dialog
  document.getElementById('cancelBtn').onclick = function(){ dialog.close(); };
  document.getElementById('saveBtn').onclick = saveDialog;
  document.getElementById('closeXBtn').onclick = function(){ dialog.close(); };
  // Sections dialog
  document.getElementById('closeSectionsBtn').onclick = function(){ sectionsDlg.close(); };
  document.getElementById('addSectionBtn').onclick = addSection;
  fillColorsSelect();
  // OP dialog
  document.getElementById('opCancelBtn').onclick = function(){ opDialog.close(); };
  document.getElementById('opSaveBtn').onclick = saveOpDialog;
  document.getElementById('opCloseXBtn').onclick = function(){ opDialog.close(); };
  // Service dialog close handlers
  try{
    document.getElementById('svcCancelBtn').onclick = function(){ serviceDialog.close(); };
    document.getElementById('svcCloseXBtn').onclick = function(){ serviceDialog.close(); };
    document.getElementById('svcSaveBtn').onclick = saveServiceDialog;
  }catch(e){}
}

// Export/Import links
async function exportFullJSON(fileName){ const data = JSON.stringify({sections: state.sections||[], links: state.links||[]}, null, 2); const blob = new Blob([data], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(String(fileName||'').trim()||'linkhub-links.json'); document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},400); toast('Download avviato'); }
function openSaveLinksDialog(){ try { var fn = 'linkhub-links.json'; var dlg = document.getElementById('saveLinksDlg'); var inp = document.getElementById('saveLinksFileName'); var closeX = document.getElementById('saveLinksCloseBtn'); var cancel = document.getElementById('saveLinksCancelBtn'); var ok = document.getElementById('saveLinksOkBtn'); inp.value = fn; dlg.showModal(); closeX.onclick = function(){ dlg.close(); }; cancel.onclick = function(){ dlg.close(); }; ok.onclick = function(){ var chosen = String(inp.value||'').trim() || fn; exportFullJSON(chosen); dlg.close(); }; } catch(e){ alert('Apri il file nel browser per usare questa finestra.'); } }
async function importFullJSON(){ try{ var inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=async function(){ var f=inp.files[0]; if(!f) return; var text=await f.text(); try{ var json=JSON.parse(text); var imported=normalizeState(json);
  var existingOP = Array.isArray(state && state.openPoints)? state.openPoints : [];
  if(!('openPoints' in json)){ imported.openPoints = existingOP; } else {
    var map=new Map();
    function keyOf(o){ return (o && o.id) ? ('id:'+o.id) : ('k:'+[o.title||'', o.project||'', o.createdAt||''].join('\n')); }
    (existingOP||[]).concat(imported.openPoints||[]).forEach(function(op){ map.set(keyOf(op), op); });
    imported.openPoints = Array.from(map.values());
  }
  var existingSvc = Array.isArray(state && state.services)? state.services : [];
  if(!('services' in json)){ imported.services = existingSvc; }
  state = imported; save(); render(); renderOpenPoints(); renderServices(); updateFilterSectionsBtn(); toast('Caricato da file (sezioni+link). Open Points/Servizi preservati'); }catch(err){ alert('Errore import: '+err.message); } }; inp.click(); }catch(e){ alert('Caricamento non riuscito: '+e.message); } }

// Sections helpers
var sectionsDlg=document.getElementById('sectionsDlg'); var sectionsList=document.getElementById('sectionsList'); var newSectionColor=document.getElementById('newSectionColor'); function fillColorsSelect(){ newSectionColor.innerHTML = '<option value="">Colore (auto)</option>'+PALETTE.map(function(p){return '<option value="'+p.id+'">'+p.id.toUpperCase()+'</option>';}).join(''); }
function headerStyle(sec){ var c1=(sec.color&&sec.color.c1)||'#0b1328', c2=(sec.color&&sec.color.c2)||'#0b1328'; return 'background: linear-gradient(90deg, '+c1+', '+c2+'); border-bottom: 1px solid '+c2+'80'; }
function render(){ var container=document.getElementById('container'); var term=(document.getElementById('q').value||'').trim().toLowerCase(); var vis=getVisibleSectionsSet(); var groups = state.sections.map(function(sec){ return { sec:sec, items: state.links.filter(function(it){ var inTerm= !term || [it.title,it.desc,(it.tags||[]).join(' ')].join(' ').toLowerCase().includes(term); var inSec = !vis || vis.has(it.sectionId); return inTerm && inSec && it.sectionId===sec.id; }) }; }); var anyItem = groups.some(function(g){return g.items.length;}); if(!anyItem){ container.innerHTML='<div class="empty">Nessun link trovato.</div>'; return; } container.innerHTML = groups.map(function(g){ if(g.items.length===0) return ''; var icon=g.sec.collapsed?'‚ñ∏':'‚ñæ'; var grid = g.sec.collapsed? '' : '<div class="grid">'+g.items.map(cardTemplate).join('')+'</div>'; return ('<section class="section" data-sec="'+g.sec.id+'">\n' +' <div class="section-header" style="'+headerStyle(g.sec)+'">\n' +' <div class="section-title">\n' +' <button class="toggle" onclick="toggleSection(\''+g.sec.id+'\')">'+icon+'</button>\n' +' <span>'+(g.sec.icon && String(g.sec.icon).trim()?String(g.sec.icon).trim():'üìÅ')+'</span> <span>'+escapeHtml(g.sec.name)+'</span>\n' +' </div>\n' +' <div class="section-actions">\n' +' <button onclick="openDialog(undefined,\''+g.sec.id+'\')">‚ûï Link</button>\n' +' </div>\n' +' </div>\n' + grid + '\n' +'</section>'); }).join(''); setupDragAndDrop(); }
function cardTemplate(item){ return ('<div class="card" data-id="'+item.id+'">\n' +' <div class="card-head">\n' +' <h3>üîó <a href="'+escapeAttr(item.url)+'" target="_blank" rel="noopener noreferrer">'+escapeHtml(item.title)+'</a></h3>\n' +' <button class="drag-handle" draggable="true" title="Trascina" aria-label="Trascina" data-id="'+item.id+'">‚ãÆ‚ãÆ</button>\n' +' </div>\n' + (item.desc?'<p>'+escapeHtml(item.desc)+'</p>':'') +' <div class="actions">\n' +' <button title="Modifica" aria-label="Modifica" onclick="editItem(\''+item.id+'\')">‚úèÔ∏è</button>\n' +' <button class="danger" title="Elimina" aria-label="Elimina" onclick="removeItem(\''+item.id+'\')">üóëÔ∏è</button>\n' +' </div>\n' +'</div>'); }
function openDialog(item, defaultSectionId){ try{ dlgTitle.textContent = item? 'Modifica link' : 'Nuovo link'; fSection.innerHTML = state.sections.map(function(s){ return '<option value="'+s.id+'">'+escapeHtml(s.name)+'</option>'; }).join(''); var secId=(item&&item.sectionId)||defaultSectionId||(state.sections[0]?state.sections[0].id:''); fSection.value=secId; dialog.showModal(); fTitle.value=(item&&item.title)||''; fUrl.value=(item&&item.url)||''; fDesc.value=(item&&item.desc)||''; fTags.value=((item&&item.tags)||[]).join(', '); dialog.dataset.editing=item?item.id:''; setTimeout(function(){ fTitle.focus(); },50); }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }}
window.openDialog = openDialog;
function normalizeLink(x){ return { id: x.id || crypto.randomUUID(), title:(x.title||'').trim(), url:(x.url||'').trim(), desc:(x.desc||'').trim(), tags:(x.tags||[]).map(function(t){return String(t).trim();}).filter(Boolean), sectionId:x.sectionId }; }
function saveDialog(){ var obj=normalizeLink({title:fTitle.value,url:fUrl.value,desc:fDesc.value,tags:fTags.value.split(','), sectionId:fSection.value}); if(!obj.title||!obj.url){ alert('Titolo e URL sono obbligatori'); return; } if(!obj.sectionId){ alert('Seleziona una sezione'); return; } var id=dialog.dataset.editing; if(id){ var i=state.links.findIndex(function(l){return l.id===id;}); if(i>=0) state.links[i]=Object.assign({}, obj, {id:id}); } else { state.links.unshift(obj); } dialog.close(); refreshAll(); }
window.removeItem = function(id){ if(!confirm('Eliminare questo link?')) return; state.links = state.links.filter(function(l){return l.id!==id;}); refreshAll(); };
window.editItem = function(id){ var item=state.links.find(function(l){return l.id===id;}); openDialog(item, item&&item.sectionId); };
window.toggleSection = function(id){ var s = state.sections.find(function(x){return x.id===id;}); if(!s) return; s.collapsed = !s.collapsed; var ui = loadUIState(); ui.sectionCollapsed = ui.sectionCollapsed || {}; ui.sectionCollapsed[id] = s.collapsed; saveUIState(ui); refreshAll(); };
function addSection(){ var name=(document.getElementById('newSectionName').value||'').trim(); if(!name) return; var desc=(document.getElementById('newSectionDesc').value||'').trim(); var icon=(document.getElementById('newSectionIcon').value||'').trim(); var colorChoice=newSectionColor.value; var paletteItem = colorChoice? PALETTE.find(function(p){return p.id===colorChoice;}) : PALETTE[state.sections.length % (PALETTE.length||7)]; state.sections.push({id:crypto.randomUUID(), name:name, desc:desc, icon:icon, collapsed:false, color:paletteItem}); document.getElementById('newSectionName').value=''; document.getElementById('newSectionDesc').value=''; document.getElementById('newSectionIcon').value=''; newSectionColor.value=''; renderSectionsList(); refreshAll(); }
function renderSectionsList(){ sectionsList.innerHTML = state.sections.map(function(s){ return ('<div class="list-item" data-id="'+s.id+'">\n' +' <input value="'+escapeAttr(s.name)+'" oninput="renameSection(\''+s.id+'\', this.value)" placeholder="Nome"/>\n' +' <input value="'+escapeAttr(s.desc||'')+'" oninput="redescSection(\''+s.id+'\', this.value)" placeholder="Descrizione (opzionale)"/>\n' +' <select class="iconSel" onchange="reiconSection(\''+s.id+'\', this.value)">'+["üìÅ","üë•","üß©","üìÇ","üìù","üìå","üìä","üìé","üõ†","üóÉ","üìÖ","üß™","üí°","‚úÖ","‚öô"].map(function(e){return '<option '+(s.icon===e?'selected':'')+'>'+e+'</option>';}).join('')+'</select>\n' +' <select onchange="recolorSection(\''+s.id+'\', this.value)">'+PALETTE.map(function(p){ return '<option value="'+p.id+'" '+(((s.color&&s.color.id)===p.id)?'selected':'')+'>'+p.id.toUpperCase()+'</option>'; }).join('')+'</select>\n' +' <div class="controls">\n' +' <button onclick="moveSection(\''+s.id+'\', -1)">‚¨ÜÔ∏è</button>\n' +' <button onclick="moveSection(\''+s.id+'\', 1)">‚¨áÔ∏è</button>\n' +' <button class="danger" onclick="deleteSection(\''+s.id+'\')">üóëÔ∏è</button>\n' +' </div>\n' +'</div>'); }).join(''); }
window.recolorSection=function(id,pid){ var s=state.sections.find(function(x){return x.id===id;}); var p=PALETTE.find(function(x){return x.id===pid;}); if(!s||!p) return; s.color=p; refreshAll(); };
window.redescSection=function(id,val){ var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; s.desc=String(val||'').trim(); save(); updateFilterSectionsBtn(); };
window.reiconSection=function(id,val){ var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; s.icon=String(val||'').trim(); refreshAll(); };
window.renameSection=function(id,val){ var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; s.name=String(val||'').trim()||'Senza nome'; save(); updateFilterSectionsBtn(); };
window.moveSection=function(id,delta){ var i=state.sections.findIndex(function(x){return x.id===id;}); if(i<0) return; var j=i+delta; if(j<0||j>=state.sections.length) return; var tmp=state.sections[i]; state.sections[i]=state.sections[j]; state.sections[j]=tmp; renderSectionsList(); refreshAll(); };
window.deleteSection=function(id){ if(state.sections.length===1){ alert('Deve esistere almeno una sezione.'); return; } var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; if(!confirm('Eliminare la sezione "'+s.name+'"? I link saranno spostati nella prima sezione.')) return; var target=state.sections.find(function(x){return x.id!==id;}); state.links = state.links.map(function(l){ return l.sectionId===id ? Object.assign({}, l, {sectionId: target.id}) : l; }); state.sections = state.sections.filter(function(x){return x.id!==id;}); renderSectionsList(); refreshAll(); };
function refreshAll(){ save(); render(); renderOpenPoints(); renderServices(); updateFilterSectionsBtn(); }
function clearAll(){ if(!confirm('Confermi? Saranno eliminati TUTTI i link, TUTTE le sezioni e TUTTI gli Open Points. Operazione irreversibile.')) return; var base={ id:crypto.randomUUID(), name:'Generale', desc:'', icon:'üè†', collapsed:false, color:PALETTE[0] }; state={ sections:[base], links:[], openPoints:[], services:[], crq:[] }; try{ localStorage.removeItem('linkhub.secFilter.v1'); }catch(_){ } save(); render(); renderOpenPoints(); renderServices(); try{ if(window.renderCrq){ window.renderCrq(); } else if(typeof renderCrq==='function'){ renderCrq(); } }catch(e){} updateFilterSectionsBtn(); toast('Ripulito'); }
var SEC_FILTER_KEY='linkhub.secFilter.v1'; function getVisibleSectionsSet(){ try{ var raw=localStorage.getItem(SEC_FILTER_KEY); if(!raw) return null; var arr=JSON.parse(raw); if(!Array.isArray(arr)||arr.length===0) return null; return new Set(arr); }catch(e){ return null; } }
function setVisibleSections(ids){ try{ if(!ids || ids.length===0 || ids.length===state.sections.length){ localStorage.removeItem(SEC_FILTER_KEY); } else { localStorage.setItem(SEC_FILTER_KEY, JSON.stringify(ids)); } }catch(e){} }
function updateFilterSectionsBtn(){ var btn=document.getElementById('filterSectionsBtn'); if(!btn) return; btn.textContent='üè† Menu'; try{ var vis=getVisibleSectionsSet(); var total= state && state.sections ? state.sections.length : 0; var all=(!vis || (vis && vis.size===total)); var label = all ? 'Tutte ('+total+')' : ('Filtrate: '+vis.size+'/'+total); btn.title='Selezione sezioni: '+label; }catch(e){} }

// --- Utility: mostra/nascondi sezioni speciali OP / SVC e salva su UI state
function setMainSectionsVisibility(opVisible, svcVisible) {
  var ui = loadUIState() || {};
  ui.opCollapsed  = !opVisible;
  ui.svcCollapsed = !svcVisible;
  saveUIState(ui);
  // OP
  var opBody   = document.getElementById('opBody');
  var opToggle = document.getElementById('opToggle');
  if (opBody && opToggle) {
    opBody.classList.toggle('hidden', !opVisible);
    opToggle.textContent = opVisible ? '‚ñæ' : '‚ñ∏';
  }
  // SVC
  var svcBody   = document.getElementById('svcBody');
  var svcToggle = document.getElementById('svcToggle');
  if (svcBody && svcToggle) {
    svcBody.classList.toggle('hidden', !svcVisible);
    svcToggle.textContent = svcVisible ? '‚ñæ' : '‚ñ∏';
  }
}
function openFilterSectionsDialog(){ try{ var dlg=document.getElementById('filterSectionsDlg'); var menu=document.getElementById('filterMenu'); var items=[]; items.push('<button class="menu-btn" data-id="ALL"><div class="label"><span class="ico">üè†</span><div class="text"><div class="name">Tutte</div><div class="desc">Mostra tutte le sezioni</div></div></div></button>'); items.push(''); items.push(''); Array.prototype.push.apply(items, state.sections.map(function(s){ var icon=(s.icon&&String(s.icon).trim())? String(s.icon).trim() : 'üìÅ'; var desc=(s.desc&&String(s.desc).trim())? ('<div class="desc">'+escapeHtml(String(s.desc).trim())+'</div>') : ''; return '<button class="menu-btn" data-id="'+s.id+'"><div class="label"><span class="ico">'+escapeHtml(icon)+'</span><div class="text"><div class="name">'+escapeHtml(s.name)+'</div>'+desc+'</div></div></button>'; })); menu.innerHTML = items.join(''); Array.prototype.forEach.call(menu.querySelectorAll('button.menu-btn'), function(btn){ btn.onclick = function () {
  var id = btn.getAttribute('data-id');
  if (id === 'ALL') {
    setVisibleSections(null);
    setMainSectionsVisibility(true, true);
  } else if (id === 'SOLO_OP') {
    setVisibleSections(['__NONE__']);
    setMainSectionsVisibility(true, false);
  } else if (id === 'SOLO_SVC') {
    setVisibleSections(['__NONE__']);
    setMainSectionsVisibility(false, true);
  } else {
    setVisibleSections([id]);
    setMainSectionsVisibility(true, true);
  }
  render();
  updateFilterSectionsBtn();
  dlg.close();
}; }); var fsClose=document.getElementById('fsCloseBtn'); if(fsClose) fsClose.onclick=function(){ dlg.close(); }; dlg.showModal(); }catch(e){ alert('Apri il file nel browser per usare questo dialog.'); } }

// Drag & drop for cards
var dragState={id:null}; var caretEl=null; var rafId=0; function setupDragAndDrop(){ Array.prototype.forEach.call(document.querySelectorAll('.drag-handle'), function(h){ h.addEventListener('dragstart', onHandleDragStart); h.addEventListener('dragend', onHandleDragEnd); }); Array.prototype.forEach.call(document.querySelectorAll('.card'), function(card){ card.addEventListener('dragover', onCardDragOver); card.addEventListener('dragleave', onCardDragLeave); card.addEventListener('drop', onCardDrop); }); Array.prototype.forEach.call(document.querySelectorAll('.section'), function(sectionEl){ sectionEl.addEventListener('dragover', onSectionDragOver); sectionEl.addEventListener('dragleave', onSectionDragLeave); sectionEl.addEventListener('drop', onSectionDrop); }); }
function onHandleDragStart(e){ var handle=e.currentTarget; var card=handle.closest('.card'); dragState.id=(card&&card.dataset.id)||handle.dataset.id; if(card) card.classList.add('dragging'); try{ e.dataTransfer.setData('text/plain', dragState.id); }catch(_){ } if(e.dataTransfer) e.dataTransfer.effectAllowed='move'; }
function onHandleDragEnd(e){ var card=e.currentTarget.closest('.card'); if(card) card.classList.remove('dragging'); hideCaret(); dragState.id=null; }
function onCardDragOver(e){ if(!dragState.id) return; e.preventDefault(); e.stopPropagation(); var card=e.currentTarget; placeCaret(card, e.clientX); }
function onCardDragLeave(e){ if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(function(){}); }
function onCardDrop(e){ if(!dragState.id) return; e.preventDefault(); e.stopPropagation(); var card=e.currentTarget; var targetId=card.dataset.id; var rect=card.getBoundingClientRect(); var before = e.clientX < (rect.left + rect.width/2); hideCaret(); if(!targetId || dragState.id===targetId) return; moveRelative(dragState.id, targetId, before? 'before':'after'); refreshAll(); }
function onSectionDragOver(e){ if(!dragState.id) return; e.preventDefault(); var sectionEl=e.currentTarget; sectionEl.classList.add('drop-target'); var grid=sectionEl.querySelector('.grid'); if(grid){ var last=grid.querySelector('.card:last-of-type'); if(last){ var rect=last.getBoundingClientRect(); showCaretAt(grid, rect.right, rect.top, rect.height); } else { var grect=grid.getBoundingClientRect(); showCaretAt(grid, grect.left + 8, grect.top, Math.max(48, grect.height)); } } }
function onSectionDragLeave(e){ e.currentTarget.classList.remove('drop-target'); }
function onSectionDrop(e){ if(!dragState.id) return; e.preventDefault(); var sectionEl=e.currentTarget; sectionEl.classList.remove('drop-target'); var secId=sectionEl.getAttribute('data-sec'); hideCaret(); if(secId){ moveToSectionEnd(dragState.id, secId); refreshAll(); } }
function ensureCaret(grid){ if(!caretEl){ caretEl=document.createElement('div'); caretEl.className='insert-caret'; } if(caretEl.parentElement!==grid){ grid.appendChild(caretEl); } }
function placeCaret(card, clientX){ var grid=card.parentElement; if(!grid) return; var rect=card.getBoundingClientRect(); var before = clientX < (rect.left + rect.width/2); var top=rect.top; var height=rect.height; var left = before ? rect.left : rect.right; showCaretAt(grid, left, top, height); }
function showCaretAt(grid, absLeft, absTop, height){ var grect=grid.getBoundingClientRect(); ensureCaret(grid); caretEl.style.left=(absLeft - grect.left - 1)+'px'; caretEl.style.top=(absTop - grect.top)+'px'; caretEl.style.height=Math.max(24,height)+'px'; caretEl.style.display='block'; }
function hideCaret(){ if(caretEl){ caretEl.style.display='none'; } }
function moveRelative(dragId, targetId, where){ var di=state.links.findIndex(function(l){return l.id===dragId;}); var ti=state.links.findIndex(function(l){return l.id===targetId;}); if(di<0||ti<0) return; var dragged=state.links[di]; var target=state.links[ti]; if(dragged.sectionId!==target.sectionId){ dragged.sectionId=target.sectionId; } state.links.splice(di,1); var insertAt; if(where==='after') insertAt = (di < ti) ? ti : ti+1; else insertAt = (di < ti) ? ti-1 : ti; insertAt = Math.max(0, Math.min(insertAt, state.links.length)); state.links.splice(insertAt,0,dragged); save(); }
function moveToSectionEnd(dragId, sectionId){ var di=state.links.findIndex(function(l){return l.id===dragId;}); if(di<0) return; var dragged=state.links[di]; dragged.sectionId=sectionId; state.links.splice(di,1); var last=-1; for(var i=0;i<state.links.length;i++){ if(state.links[i].sectionId===sectionId) last=i; } var insertAt = last===-1? state.links.length : last+1; state.links.splice(insertAt,0,dragged); save(); }

// ===== OP =====
var opDialog=document.getElementById('opDialog'); var opTitle=document.getElementById('opTitle'); var opProject=document.getElementById('opProject'); var opAssignees=document.getElementById('opAssignees'); var opPriority=document.getElementById('opPriority'); var opStatus=document.getElementById('opStatus'); var opMaxPrio=document.getElementById('opMaxPrio'); var opCreatedAt=document.getElementById('opCreatedAt'); var opDueAt=document.getElementById('opDueAt'); var opDesc=document.getElementById('opDesc'); var opNotes=document.getElementById('opNotes');
function openOpDialog(item){ try{ document.getElementById('opDlgTitle').textContent=item?'Modifica open point':'Nuovo open point'; opTitle.value=(item&&item.title)||''; opProject.value=(item&&item.project)||''; opAssignees.value=(item&&Array.isArray(item.assignees)?item.assignees.join(', '):(item&&item.assignees)||''); opPriority.value=(item&&item.priority)||'medium'; opStatus.value=(item&&item.status)||'Nuovo'; opMaxPrio.checked=!!(item&&item.maxPriority); opCreatedAt.value=(item&&item.createdAt)||todayISO(); opDueAt.value=(item&&item.dueAt)||''; opDesc.value=(item&&item.desc)||''; opNotes.value=(item&&item.notes)||''; opDialog.dataset.editing=item?item.id:''; opDialog.showModal(); setTimeout(function(){opTitle.focus();},50); }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }}
function normalizeOPInput(){ var ass=String(opAssignees.value||'').split(',').map(function(s){return s.trim();}).filter(Boolean); return { id:crypto.randomUUID(), title:String(opTitle.value||'').trim(), project:String(opProject.value||'').trim(), assignees:ass, priority:String(opPriority.value||'medium').toLowerCase(), status:String(opStatus.value||'Nuovo'), maxPriority:!!opMaxPrio.checked, createdAt:String(opCreatedAt.value||'').trim(), dueAt:String(opDueAt.value||'').trim(), desc:String(opDesc.value||'').trim(), notes:String(opNotes.value||'').trim() }; }
function saveOpDialog(){ var obj=normalizeOPInput(); if(!obj.title){ alert('Il Titolo √® obbligatorio'); return; } if(!obj.createdAt) obj.createdAt=todayISO(); var id=opDialog.dataset.editing; if(id){ var i=state.openPoints.findIndex(function(o){return o.id===id;}); if(i>=0) state.openPoints[i]=Object.assign({}, obj, {id:id}); } else { state.openPoints.unshift(obj); } opDialog.close(); refreshAll(); }
window.editOpenPoint = function(id){ var item=state.openPoints.find(function(o){return o.id===id;}); if(item) openOpDialog(item); };
window.deleteOpenPoint = function(id){ if(!confirm('Eliminare questo open point?')) return; state.openPoints = state.openPoints.filter(function(o){return o.id!==id;}); refreshAll(); };
function clearOpenPoints(){ if(!confirm('Confermi? Saranno eliminati TUTTI gli Open Points. Operazione irreversibile.')) return; state.openPoints=[]; refreshAll(); }
var OPF_KEY='openpoints.filter.v1'; function defaultOpFilter(){ return { text:'', priorities:['medium','high','critical','low'], statuses:['Nuovo','Da fare','In corso','Schedulato','Completato'], maxOnly:false, createdFrom:'', createdTo:'', dueFrom:'', dueTo:'', assignees:[], projects:[] }; }
function loadOpFilter(){ try{ var raw=localStorage.getItem(OPF_KEY); if(!raw) return defaultOpFilter(); var f=JSON.parse(raw); return Object.assign(defaultOpFilter(), f); }catch(e){ return defaultOpFilter(); } }
function saveOpFilter(f){ try{ localStorage.setItem(OPF_KEY, JSON.stringify(f || defaultOpFilter())); }catch(e){} }
var opFilter=loadOpFilter();
window.openOpFilterDialog = function(){ try{ var dlg=document.getElementById('opFilterDlg'); if(!dlg) return alert('Dialog non disponibile'); document.getElementById('opfText').value=opFilter.text||''; Array.prototype.forEach.call(document.querySelectorAll('#opfPrioGroup input[type=checkbox]'), function(cb){ cb.checked = (opFilter.priorities||[]).indexOf(cb.value) >= 0; }); Array.prototype.forEach.call(document.querySelectorAll('#opfStatusGroup input[type=checkbox]'), function(cb){ cb.checked = (opFilter.statuses||[]).indexOf(cb.value) >= 0; }); document.getElementById('opfMaxOnly').checked=!!opFilter.maxOnly; document.getElementById('opfCreatedFrom').value=opFilter.createdFrom||''; document.getElementById('opfCreatedTo').value=opFilter.createdTo||''; document.getElementById('opfDueFrom').value=opFilter.dueFrom||''; document.getElementById('opfDueTo').value=opFilter.dueTo||''; document.getElementById('opfAssignees').value=(opFilter.assignees||[]).join(', '); document.getElementById('opfProjects').value=(opFilter.projects||[]).join(', '); document.getElementById('opFilterCloseXBtn').onclick=function(){ dlg.close(); }; document.getElementById('opfResetBtn').onclick=function(){ opFilter=defaultOpFilter(); saveOpFilter(opFilter); renderOpenPoints(); dlg.close(); }; document.getElementById('opfApplyBtn').onclick=function(){ function getChecked(containerId){ var box=document.getElementById(containerId); return Array.prototype.filter.call(box.querySelectorAll('input[type=checkbox]'), function(o){return o.checked;}).map(function(o){return o.value;}); } opFilter={ text:String(document.getElementById('opfText').value||'').trim().toLowerCase(), priorities:getChecked('opfPrioGroup'), statuses:getChecked('opfStatusGroup'), maxOnly:!!document.getElementById('opfMaxOnly').checked, createdFrom:String(document.getElementById('opfCreatedFrom').value||'').trim(), createdTo:String(document.getElementById('opfCreatedTo').value||'').trim(), dueFrom:String(document.getElementById('opfDueFrom').value||'').trim(), dueTo:String(document.getElementById('opfDueTo').value||'').trim(), assignees:String(document.getElementById('opfAssignees').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), projects:String(document.getElementById('opfProjects').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean) }; saveOpFilter(opFilter); renderOpenPoints(); dlg.close(); }; dlg.showModal(); }catch(e){ alert('Apri il file nel browser per usare il filtro OP.'); } }
function inDateRange(val, from, to){ if(!val) return true; try{ var v=new Date(val).toISOString().slice(0,10); if(from && v<from) return false; if(to && v>to) return false; return true; }catch(e){ return true; } }
function applyOpFilters(rows){ var f=opFilter||defaultOpFilter(); return rows.filter(function(o){ var text=(f.text||''); if(text){ var bag=[o.title||'', o.project||'', o.desc||'', o.notes||'', Array.isArray(o.assignees)? o.assignees.join(' '): (o.assignees||'')].join(' ').toLowerCase(); if(bag.indexOf(text)===-1) return false; } var pr=(o.priority||'medium').toLowerCase(); if(Array.isArray(f.priorities)&&f.priorities.length&&f.priorities.indexOf(pr)===-1) return false; var st=(o.status||'Nuovo'); if(Array.isArray(f.statuses)&&f.statuses.length&&f.statuses.indexOf(st)===-1) return false; if(!!f.maxOnly && !o.maxPriority) return false; if(!inDateRange(o.createdAt||'', f.createdFrom||'', f.createdTo||'')) return false; if(!inDateRange(o.dueAt||'', f.dueFrom||'', f.dueTo||'')) return false; if(Array.isArray(f.assignees)&&f.assignees.length){ var a = Array.isArray(o.assignees)? o.assignees.map(function(x){return String(x).toLowerCase();}) : String(o.assignees||'').toLowerCase(); var ok=false; f.assignees.forEach(function(x){ var k=String(x).toLowerCase(); if(Array.isArray(a)){ if(a.indexOf(k)>=0) ok=true; } else { if(a.indexOf(k)>=0) ok=true; } }); if(!ok) return false; } if(Array.isArray(f.projects)&&f.projects.length){ var p=String(o.project||'').toLowerCase(); var okp=false; f.projects.forEach(function(x){ var k=String(x).toLowerCase(); if(k && p.indexOf(k)>=0) okp=true; }); if(!okp) return false; } return true; }); }
var opSort={ key:'createdAt', dir:'desc' }; var PRIO_ORDER={low:1, medium:2, high:3, critical:4}; var STATUS_ORDER={'Nuovo':1, 'Da fare':2, 'In corso':3, 'Schedulato':4, 'Completato':5};
function cmp(a,b){ return a<b? -1 : a>b? 1 : 0; }
function cmpDate(a,b){ try{ a=a? new Date(a).toISOString().slice(0,10):''; b=b? new Date(b).toISOString().slice(0,10):''; }catch(_){ } return cmp(a,b); }
function sortRows(rows){ var k=opSort.key, d=(opSort.dir==='desc'?-1:1); return rows.slice().sort(function(x,y){ var r=0; if(k==='title'||k==='project') r=cmp(String(x[k]||'').toLowerCase(), String(y[k]||'').toLowerCase()); else if(k==='assignees'){ r=cmp(String((Array.isArray(x.assignees)?x.assignees.join(', '):x.assignees)||'').toLowerCase(), String((Array.isArray(y.assignees)?y.assignees.join(', '):y.assignees)||'').toLowerCase()); } else if(k==='priority'){ r=cmp(PRIO_ORDER[(x.priority||'medium')], PRIO_ORDER[(y.priority||'medium')]); } else if(k==='status'){ r=cmp(STATUS_ORDER[(x.status||'Nuovo')], STATUS_ORDER[(y.status||'Nuovo')]); } else if(k==='maxPriority'){ r=cmp(!!x.maxPriority, !!y.maxPriority); } else if(k==='createdAt'||k==='dueAt'){ r=cmpDate(x[k]||'', y[k]||''); } else if(k==='id'){ r=cmp(String(x.id||''), String(y.id||'')); } return r*d; }); }
function setOpSort(key){ if(opSort.key===key){ opSort.dir=(opSort.dir==='asc'?'desc':'asc'); } else { opSort.key=key; opSort.dir=(key==='createdAt'||key==='dueAt')?'desc':'asc'; } renderOpenPoints(); }
function sortArrowFor(key){ if(opSort.key!==key) return ''; return ' <span class="arrow">'+(opSort.dir==='asc'?'‚Üë':'‚Üì')+'</span>'; }
function renderOpenPoints(){ var tbl=document.getElementById('opTable'); if(!tbl) return; var all=state.openPoints||[]; var filtered=applyOpFilters(all); var rows=sortRows(filtered); document.getElementById('opCount').textContent = rows.length + ' risultati su ' + all.length; var thead = '<thead><tr>' + '<th class="col-id sortable" onclick="setOpSort(\'id\')">ID'+sortArrowFor('id')+'</th>' + '<th class="sortable" onclick="setOpSort(\'title\')">Titolo'+sortArrowFor('title')+'</th>' + '<th class="sortable" onclick="setOpSort(\'project\')">Progetto'+sortArrowFor('project')+'</th>' + '<th class="sortable" onclick="setOpSort(\'assignees\')">Assegnatari'+sortArrowFor('assignees')+'</th>' + '<th class="sortable" onclick="setOpSort(\'priority\')">Priorit√†'+sortArrowFor('priority')+'</th>' + '<th class="sortable" onclick="setOpSort(\'status\')">Stato'+sortArrowFor('status')+'</th>' + '<th class="sortable" onclick="setOpSort(\'maxPriority\')">Max'+sortArrowFor('maxPriority')+'</th>' + '<th class="sortable" onclick="setOpSort(\'createdAt\')">Inserito il'+sortArrowFor('createdAt')+'</th>' + '<th class="sortable" onclick="setOpSort(\'dueAt\')">Scadenza'+sortArrowFor('dueAt')+'</th>' + '<th>Azioni</th>' + '</tr></thead>'; if(rows.length===0){ tbl.innerHTML = thead + '<tbody><tr><td colspan="10"><div class="empty">Nessun open point</div></td></tr></tbody>'; return; } var tbody = '<tbody>' + rows.map(function(o){ var assTxt=Array.isArray(o.assignees)? o.assignees.join(', ') : (o.assignees||''); return '<tr>' + '<td class="col-id">'+escapeHtml(o.id)+'</td>' + '<td class="col-title"><strong>'+escapeHtml(o.title)+'</strong>' + (o.desc? '<br><span style="color:var(--muted)">'+escapeHtml(o.desc)+'</span>':'' ) + (o.notes? '<br><span style="color:var(--muted)"><em>Note:</em> '+escapeHtml(o.notes)+'</span>':'' ) + '</td>' + '<td>'+escapeHtml(o.project||'')+'</td>' + '<td>'+escapeHtml(assTxt)+'</td>' + '<td><span class="badge">'+escapeHtml((o.priority||'medium').toUpperCase())+'</span></td>' + '<td><span class="badge state">'+escapeHtml(o.status||'Nuovo')+'</span></td>' + '<td>'+(o.maxPriority? '<span class="badge max">MAX</span>' : '')+'</td>' + '<td class="col-created">'+escapeHtml(o.createdAt||'')+'</td>' + '<td class="col-due">'+escapeHtml(o.dueAt||'')+'</td>' + '<td><div class="table-actions">' + '<button title="Modifica" onclick="editOpenPoint(\''+o.id+'\')">‚úèÔ∏è</button>' + '<button class="danger" title="Elimina" onclick="deleteOpenPoint(\''+o.id+'\')">üóëÔ∏è</button>' + '</div></td>' + '</tr>'; }).join('') + '</tbody>'; tbl.innerHTML = thead + tbody; }
async function exportOpenPointsToFile(fileName){ try{ var data=JSON.stringify({openPoints: state.openPoints||[]}, null, 2); var blob=new Blob([data], {type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=String(fileName||'open-points.json'); document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},400); toast('Download OP avviato'); }catch(e){ alert('Salvataggio OP non riuscito: '+(e&&e.message?e.message:e)); } }
window.importOpenPointsFromFile = async function(){ try{ var inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=async function(){ var f=inp.files[0]; if(!f) return; var text=await f.text(); try{ var json=JSON.parse(text); var arr=Array.isArray(json)? json : (Array.isArray(json.openPoints)? json.openPoints : null); if(!arr){ alert('JSON non valido: atteso array o { openPoints: [...] }'); return; } state.openPoints = arr.map(function(o){ return { id:o.id||crypto.randomUUID(), title:String(o.title||o.titolo||'').trim(), project:String(o.project||o.progetto||'').trim(), assignees:Array.isArray(o.assignees||o.assegnatari)? (o.assignees||o.assegnatari) : String(o.assignees||o.assegnatari||'').split(',').map(function(s){return s.trim();}).filter(Boolean), priority:(o.priority||o.priorita||o['priorit√†']||'medium').toLowerCase(), status:String(o.status||o.stato||'Nuovo').trim(), maxPriority:!!(o.maxPriority||o.max||o['priorit√†Massima']), createdAt:String(o.createdAt||o.dataInserimento||'').trim(), dueAt:String(o.dueAt||o.dataScadenza||'').trim(), desc:String(o.desc||o.descrizione||'').trim(), notes:String(o.notes||o.note||'').trim() }; }); refreshAll(); toast('Open Points caricati da file'); }catch(err){ alert('Errore import OP: '+err.message); } }; inp.click(); }catch(e){ alert('Caricamento OP fallito: '+e.message); } }
function opRowsFiltered(){ return sortRows(applyOpFilters(state.openPoints||[])); }
function quoteCSV(v){ v=(v==null? '' : String(v)); if(/["\n;]/.test(v)) return '"'+v.replace(/"/g,'""')+'"'; return v; }
window.exportOpenPointsToCSV = function(){ var rows=opRowsFiltered(); var head=['ID','Titolo','Progetto','Assegnatari','Priorita','Stato','MaxPriority','InseritoIl','Scadenza','Descrizione','Note']; var csv = head.join(';') + '\n' + rows.map(function(o){ var ass=Array.isArray(o.assignees)? o.assignees.join(', ') : (o.assignees||''); var line=[o.id, o.title, o.project, ass, (o.priority||'').toUpperCase(), (o.status||''), (o.maxPriority?'1':'0'), o.createdAt||'', o.dueAt||'', o.desc||'', o.notes||''].map(quoteCSV).join(';'); return line; }).join('\n'); var blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='open-points.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },400); }
window.exportOpenPointsToExcel = function(){ var rows=opRowsFiltered(); function xmlEscape(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/\</g,'&lt;').replace(/\>/g,'&gt;'); } function cell(v,type){ type=type||'String'; return '<Cell><Data ss:Type="'+type+'">'+xmlEscape(v)+'</Data></Cell>'; } var head=['ID','Titolo','Progetto','Assegnatari','Priorit√†','Stato','MaxPriority','Inserito il','Scadenza','Descrizione','Note']; var xml='<?xml version="1.0"?>\n' + '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n' + '<Worksheet ss:Name="OpenPoints"><Table>'; xml += '<Row>' + head.map(function(h){return cell(h); }).join('') + '</Row>'; rows.forEach(function(o){ var ass=Array.isArray(o.assignees)? o.assignees.join(', ') : (o.assignees||''); xml += '<Row>' + cell(o.id) + cell(o.title) + cell(o.project) + cell(ass) + cell((o.priority||'').toUpperCase()) + cell(o.status||'') + cell(o.maxPriority?'1':'0', 'Number') + cell(o.createdAt||'') + cell(o.dueAt||'') + cell(o.desc||'') + cell(o.notes||'') + '</Row>'; }); xml += '</Table></Worksheet></Workbook>'; var blob=new Blob([xml], {type:'application/vnd.ms-excel'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='open-points.xls'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },400); }

// ===== SERVICES =====
var serviceDialog = document.getElementById('serviceDialog'); var svcRoutine = document.getElementById('svcRoutine'); var svcTipo = document.getElementById('svcTipo'); var svcServizio = document.getElementById('svcServizio'); var svcOperation = document.getElementById('svcOperation'); var svcFallback = document.getElementById('svcFallback'); var svcDescrizione = document.getElementById('svcDescrizione'); var svcAmbito = document.getElementById('svcAmbito');
function openServiceDialog(item){ try{ document.getElementById('svcDlgTitle').textContent = item ? 'Modifica servizio' : 'Nuovo servizio';
  svcRoutine.value     = (item && item.routine) || '';
  svcTipo.value        = (item && item.tipo) || 'REST';
  svcServizio.value    = (item && item.servizio) || '';
  svcOperation.value   = (item && item.operation) || '';
  svcFallback.value    = (item && item.fallback) || '';
  svcDescrizione.value = (item && item.descrizione) || '';
  svcAmbito.value      = (item && item.ambito) || '';
  var svcApplicativoEl=document.getElementById('svcApplicativo'); if(svcApplicativoEl) svcApplicativoEl.value=(item&&item.applicativo)||'';
  var svcParamsInEl=document.getElementById('svcParamsIn'); if(svcParamsInEl) svcParamsInEl.value=(item&&item.paramsIngresso)||'';
  var svcOutputEl=document.getElementById('svcOutput'); if(svcOutputEl) svcOutputEl.value=(item&&item.outputServizio)||'';
  serviceDialog.dataset.editing = item ? item.id : '';
  serviceDialog.showModal(); setTimeout(function(){ svcRoutine.focus(); }, 50);
 }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); } }
function normalizeServiceInput(){ return { id: crypto.randomUUID(), routine: String(svcRoutine.value || '').trim(), tipo: (String(svcTipo.value || 'REST').toUpperCase() === 'SOAP') ? 'SOAP' : 'REST', servizio: String(svcServizio.value || '').trim(), operation: String(svcOperation.value || '').trim(), fallback: String(svcFallback.value || '').trim(), descrizione: String(svcDescrizione.value || '').trim(), ambito: String(svcAmbito.value || '').trim(), applicativo: (document.getElementById('svcApplicativo')? String(document.getElementById('svcApplicativo').value||'').trim() : ''), paramsIngresso: (document.getElementById('svcParamsIn')? String(document.getElementById('svcParamsIn').value||'').trim() : ''), outputServizio: (document.getElementById('svcOutput')? String(document.getElementById('svcOutput').value||'').trim() : '') }; }
function saveServiceDialog(){ var obj = normalizeServiceInput(); if(!obj.routine || !obj.servizio){ alert('ROUTINE e SERVIZIO sono obbligatori'); return; } var id = serviceDialog.dataset.editing; if(id){ var i = state.services.findIndex(function(s){ return s.id === id; }); if(i >= 0) state.services[i] = Object.assign({}, obj, { id: id }); }else{ state.services.unshift(obj); } serviceDialog.close(); refreshAll(); }
window.editService = function(id){ var item = state.services.find(function(s){ return s.id === id; }); if(item) openServiceDialog(item); };
window.deleteService = function(id){ if(!confirm('Eliminare questo servizio?')) return; state.services = state.services.filter(function(s){ return s.id !== id; }); refreshAll(); };
function clearServices(){ if(!confirm('Confermi? Saranno eliminati TUTTI i Servizi. Operazione irreversibile.')) return; state.services = []; refreshAll(); }

var SVCF_KEY = 'services.filter.v1'; function defaultSvcFilter(){ return { text:'', tipi:['REST','SOAP'], ambiti:[], routine:[], servizi:[], applicativi:[], fallback:[], operations:[], params:[], outputs:[], stati:[] }; }
function loadSvcFilter(){ try{ var raw=localStorage.getItem(SVCF_KEY); if(!raw) return defaultSvcFilter(); var f=JSON.parse(raw); return Object.assign(defaultSvcFilter(), f); }catch(e){ return defaultSvcFilter(); } }
function saveSvcFilter(f){ try{ localStorage.setItem(SVCF_KEY, JSON.stringify(f || defaultSvcFilter())); }catch(e){} }
var svcFilter = loadSvcFilter();
window.openSvcFilterDialog = function(){ try{ var dlg=document.getElementById('svcFilterDlg'); if(!dlg) return alert('Dialog non disponibile'); document.getElementById('svcfText').value = svcFilter.text || ''; Array.prototype.forEach.call(document.querySelectorAll('#svcfTipoGroup input[type=checkbox]'), function(cb){ cb.checked = (svcFilter.tipi||[]).indexOf(cb.value)>=0; }); document.getElementById('svcfAmbiti').value = (svcFilter.ambiti||[]).join(', '); document.getElementById('svcfRoutine').value = (svcFilter.routine||[]).join(', '); document.getElementById('svcfServizi').value = (svcFilter.servizi||[]).join(', '); var el; el=document.getElementById('svcfApplicativi'); if(el) el.value = (svcFilter.applicativi||[]).join(', '); el=document.getElementById('svcfFallback'); if(el) el.value = (svcFilter.fallback||[]).join(', '); el=document.getElementById('svcfOperation'); if(el) el.value = (svcFilter.operations||[]).join(', '); el=document.getElementById('svcfParamsIn'); if(el) el.value = (svcFilter.params||[]).join(', '); el=document.getElementById('svcfOutput'); if(el) el.value = (svcFilter.outputs||[]).join(', '); el=document.getElementById('svcfStati'); if(el) el.value = (svcFilter.stati||[]).join(', '); document.getElementById('svcFilterCloseXBtn').onclick=function(){ dlg.close(); }; document.getElementById('svcfResetBtn').onclick=function(){ svcFilter=defaultSvcFilter(); saveSvcFilter(svcFilter); renderServices(); dlg.close(); }; document.getElementById('svcfApplyBtn').onclick=function(){ function getChecked(containerId){ var box=document.getElementById(containerId); return Array.prototype.filter.call(box.querySelectorAll('input[type=checkbox]'), function(o){return o.checked;}).map(function(o){return o.value;}); } svcFilter = { text: String(document.getElementById('svcfText').value||'').trim().toLowerCase(), tipi: getChecked('svcfTipoGroup'), ambiti: String(document.getElementById('svcfAmbiti').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), routine: String(document.getElementById('svcfRoutine').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), servizi: String(document.getElementById('svcfServizi').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), applicativi: String((document.getElementById('svcfApplicativi')||{}).value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), fallback: String((document.getElementById('svcfFallback')||{}).value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), operations: String((document.getElementById('svcfOperation')||{}).value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), params: String((document.getElementById('svcfParamsIn')||{}).value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), outputs: String((document.getElementById('svcfOutput')||{}).value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), stati: String((document.getElementById('svcfStati')||{}).value||'').split(',').map(function(s){return s.trim();}).filter(Boolean) }; saveSvcFilter(svcFilter); renderServices(); dlg.close(); }; dlg.showModal(); }catch(e){ alert('Apri il file nel browser per usare il filtro Servizi.'); } };
function applySvcFilters(rows){ var f=svcFilter||defaultSvcFilter(); return (rows||[]).filter(function(s){ var text=(f.text||''); if(text){ var bag=[s.routine||'', s.tipo||'', s.servizio||'', s.operation||'', s.fallback||'', s.descrizione||'', s.ambito||'', s.applicativo||'', s.paramsIngresso||'', s.outputServizio||'', s.stato||''].join(' ').toLowerCase(); if(bag.indexOf(text)===-1) return false; } if(Array.isArray(f.tipi)&&f.tipi.length){ if(f.tipi.indexOf((s.tipo||'').toUpperCase())===-1) return false; } if(Array.isArray(f.ambiti)&&f.ambiti.length){ var amb=(s.ambito||'').toLowerCase(); var ok=false; f.ambiti.forEach(function(a){ var k=String(a).toLowerCase(); if(k && amb.indexOf(k)>=0) ok=true; }); if(!ok) return false; } if(Array.isArray(f.routine)&&f.routine.length){ var r=(s.routine||'').toLowerCase(); var okr=false; f.routine.forEach(function(a){ var k=String(a).toLowerCase(); if(k && r.indexOf(k)>=0) okr=true; }); if(!okr) return false; } if(Array.isArray(f.servizi)&&f.servizi.length){ var sv=(s.servizio||'').toLowerCase(); var oks=false; f.servizi.forEach(function(a){ var k=String(a).toLowerCase(); if(k && sv.indexOf(k)>=0) oks=true; }); if(!oks) return false; } if(Array.isArray(f.applicativi)&&f.applicativi.length){ var app=(s.applicativo||'').toLowerCase(); var okapp=false; f.applicativi.forEach(function(a){ var k=String(a).toLowerCase(); if(k && app.indexOf(k)>=0) okapp=true; }); if(!okapp) return false; } if(Array.isArray(f.fallback)&&f.fallback.length){ var fb=(s.fallback||'').toLowerCase(); var okfb=false; f.fallback.forEach(function(a){ var k=String(a).toLowerCase(); if(k && fb.indexOf(k)>=0) okfb=true; }); if(!okfb) return false; } if(Array.isArray(f.operations)&&f.operations.length){ var op=(s.operation||'').toLowerCase(); var okop=false; f.operations.forEach(function(a){ var k=String(a).toLowerCase(); if(k && op.indexOf(k)>=0) okop=true; }); if(!okop) return false; } if(Array.isArray(f.params)&&f.params.length){ var pin=(s.paramsIngresso||'').toLowerCase(); var okpi=false; f.params.forEach(function(a){ var k=String(a).toLowerCase(); if(k && pin.indexOf(k)>=0) okpi=true; }); if(!okpi) return false; } if(Array.isArray(f.outputs)&&f.outputs.length){ var out=(s.outputServizio||'').toLowerCase(); var okout=false; f.outputs.forEach(function(a){ var k=String(a).toLowerCase(); if(k && out.indexOf(k)>=0) okout=true; }); if(!okout) return false; } if(Array.isArray(f.stati)&&f.stati.length){ var st=(s.stato||'').toLowerCase(); var okst=false; f.stati.forEach(function(a){ var k=String(a).toLowerCase(); if(k && st.indexOf(k)>=0) okst=true; }); if(!okst) return false; } return true; }); }
var svcSort = { key:'routine', dir:'asc' }; function svcCmp(a,b){ return a<b? -1 : a>b? 1 : 0; }
function sortSvcRows(rows){ var k=svcSort.key, d=(svcSort.dir==='desc'?-1:1); return rows.slice().sort(function(x,y){ var r=0; if(k==='routine'||k==='servizio'||k==='operation'||k==='fallback'||k==='descrizione'||k==='ambito'||k==='applicativo'||k==='paramsIngresso'||k==='outputServizio'
    || k==='stato'){ r=svcCmp(String(x[k]||'').toLowerCase(), String(y[k]||'').toLowerCase()); } else if(k==='tipo'){ r=svcCmp(String(x.tipo||'REST'), String(y.tipo||'REST')); } else if(k==='id'){ r=svcCmp(String(x.id||''), String(y.id||'')); } return r*d; }); }
function setSvcSort(key){ if(svcSort.key===key){ svcSort.dir=(svcSort.dir==='asc'?'desc':'asc'); } else { svcSort.key=key; svcSort.dir='asc'; } renderServices(); }
function svcSortArrowFor(key){ if(svcSort.key!==key) return ''; return ' <span class="arrow">'+(svcSort.dir==='asc'?'‚Üë':'‚Üì')+'</span>'; }
function svcRowsFiltered(){ return sortSvcRows(applySvcFilters(state.services||[])); }

function renderServices(){
  var tbl=document.getElementById('svcTable'); if(!tbl) return;
  var rows = svcRowsFiltered();
  var all = state.services||[];
  var thead = '<thead><tr>'
    + '<th class="col-id sortable" onclick="setSvcSort(\'id\')">ID'+svcSortArrowFor('id')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'routine\')">ROUTINE'+svcSortArrowFor('routine')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'tipo\')">TIPO'+svcSortArrowFor('tipo')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'servizio\')">SERVIZIO'+svcSortArrowFor('servizio')+'</th>'
    + '<th class="sortable col-operation" onclick="setSvcSort(\'operation\')">OPERATION / PARAMETRI'+svcSortArrowFor('operation')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'fallback\')">fallback JDBC/SWP'+svcSortArrowFor('fallback')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'descrizione\')">DESCRIZIONE'+svcSortArrowFor('descrizione')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'ambito\')">AMBITO'+svcSortArrowFor('ambito')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'applicativo\')">APPLICATIVO'+svcSortArrowFor('applicativo')+'</th>'
    + '<th class="sortable col-multiline" onclick="setSvcSort(\'paramsIngresso\')">PARAMETRI INGRESSO'+svcSortArrowFor('paramsIngresso')+'</th>'
    + '<th class="sortable col-multiline" onclick="setSvcSort(\'outputServizio\')">OUTPUT SERVIZIO'+svcSortArrowFor('outputServizio')+'</th>'
    + '<th class="sortable" onclick="setSvcSort(\'stato\')">STATO'+svcSortArrowFor('stato')+'</th>'
    + '<th>Azioni</th>'
    + '</tr></thead>';
  if(rows.length===0){
    tbl.innerHTML = thead + '<tbody><tr><td colspan="13"><div class="empty">Nessun servizio (filtrati '+rows.length+' su '+all.length+')</div></td></tr></tbody>';
    return;
  }
  var tbody = '<tbody>' + rows.map(function(s){
    return '<tr>'
      + '<td class="col-id">'+escapeHtml(s.id)+'</td>'
      + '<td>'+escapeHtml(s.routine || '')+'</td>'
      + '<td><span class="badge">'+escapeHtml(s.tipo || '')+'</span></td>'
      + '<td>'+escapeHtml(s.servizio || '')+'</td>'
      + '<td class="col-operation">'+escapeHtml(s.operation || '')+'</td>'
      + '<td>'+escapeHtml(s.fallback || '')+'</td>'
      + '<td>'+escapeHtml(s.descrizione || '')+'</td>'
      + '<td>'+escapeHtml(s.ambito || '')+'</td>'
      + '<td>'+escapeHtml(s.applicativo || '')+'</td>'
      + '<td class="col-multiline">'+escapeHtml(s.paramsIngresso || '')+'</td>'
      + '<td class="col-multiline">'+escapeHtml(s.outputServizio || '')+'</td>'
      + '<td>'+escapeHtml(s.stato || '')+'</td>'
      + '<td><div class="table-actions">'
        + '<button title="Modifica" onclick="editService(\''+ s.id +'\')">‚úèÔ∏è</button>'
        + '<button class="danger" title="Elimina" onclick="deleteService(\''+ s.id +'\')">üóëÔ∏è</button>'
      + '</div></td>'
    + '</tr>';
  }).join('') + '</tbody>';
  tbl.innerHTML = thead + tbody;
}
// Export/Import Servizi
async function exportServicesToFile(fileName){ try{ var data = JSON.stringify({ services: state.services || [] }, null, 2); var blob = new Blob([data], {type:'application/json'}); await saveBlobWithPicker(blob, fileName || 'services.json', [ { description: 'JSON', accept: { 'application/json': ['.json'] } } ]); }catch(e){ alert('Salvataggio servizi non riuscito: ' + (e && e.message ? e.message : e)); } }
window.importServicesFromFile = async function(){ try{ var inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = async function(){ var f = inp.files[0]; if(!f) return; var text = await f.text(); try{ var json = JSON.parse(text); var arr = Array.isArray(json) ? json : (Array.isArray(json.services) ? json.services : null); if(!arr){ alert('JSON non valido: atteso array o { services: [...] }'); return; } state.services = arr.map(function(s){ return { id: s.id || crypto.randomUUID(), routine: String(s.routine || '').trim(), tipo: (String(s.tipo || '').toUpperCase() === 'SOAP') ? 'SOAP' : 'REST', servizio: String(s.servizio || '').trim(), operation: String(s.operation || s['operation / parametro'] || '').trim(), fallback: String(s.fallback || s['fallback JDBC/SWP'] || '').trim(), descrizione: String(s.descrizione || '').trim(), ambito: String(s.ambito || '').trim(), applicativo: String(s.applicativo || s['applicativo'] || '').trim(), paramsIngresso: String(s.paramsIngresso || s['paramsIngresso'] || s['parametriIngresso'] || '').trim(), outputServizio: String(s.outputServizio || s['outputServizio'] || s['output'] || '').trim() }; }); refreshAll(); toast('Servizi caricati da file'); }catch(err){ alert('Errore import servizi: ' + err.message); } }; inp.click(); }catch(e){ alert('Caricamento servizi fallito: ' + e.message); } };
window.exportServicesToCSV = function(){ var rows = svcRowsFiltered(); var head = ['ID','ROUTINE','TIPO','SERVIZIO','OPERATION / PARAMETRI','fallback JDBC/SWP','DESCRIZIONE','AMBITO','APPLICATIVO','PARAMETRI INGRESSO','OUTPUT SERVIZIO']; var csv = head.join(';') + '\n' + rows.map(function(s){ var line = [ s.id, s.routine, s.tipo, s.servizio, s.operation, s.fallback, s.descrizione, s.ambito, s.applicativo, s.paramsIngresso, s.outputServizio ].map(quoteCSV).join(';'); return line; }).join('\n'); var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='servizi.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 400); };
window.exportServicesToExcel = function(){ var rows = svcRowsFiltered(); function xmlEscape(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/\</g,'&lt;').replace(/\>/g,'&gt;'); } function cell(v,type){ type=type||'String'; return '<Cell><Data ss:Type="'+type+'">'+xmlEscape(v)+'</Data></Cell>'; } var head = ['ID','ROUTINE','TIPO','SERVIZIO','OPERATION / PARAMETRI','fallback JDBC/SWP','DESCRIZIONE','AMBITO','APPLICATIVO','PARAMETRI INGRESSO','OUTPUT SERVIZIO']; var xml='<?xml version="1.0"?>\n' + '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n' + '<Worksheet ss:Name="Servizi"><Table>'; xml += '<Row>' + head.map(function(h){ return cell(h); }).join('') + '</Row>'; rows.forEach(function(s){ xml += '<Row>' + cell(s.id) + cell(s.routine) + cell(s.tipo) + cell(s.servizio) + cell(s.operation) + cell(s.fallback) + cell(s.descrizione) + cell(s.ambito) + cell(s.applicativo) + cell(s.paramsIngresso) + cell(s.outputServizio) + '</Row>'; }); xml += '</Table></Worksheet></Workbook>'; var blob=new Blob([xml], {type:'application/vnd.ms-excel'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='servizi.xls'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 400); };

// Save helpers
async function saveBlobWithPicker(blob, suggestedName, types){ try{ if(window.showSaveFilePicker){ const handle = await window.showSaveFilePicker({ suggestedName: suggestedName || 'download.json', types: types || [ { description: 'JSON', accept: { 'application/json': ['.json'] } }, { description: 'CSV', accept: { 'text/csv': ['.csv'] } }, { description: 'Excel (XML)', accept: { 'application/vnd.ms-excel': ['.xls'] } } ] }); const writable = await handle.createWritable(); await writable.write(blob); await writable.close(); toast('File salvato'); return true; } }catch(e){ if(e && e.name === 'AbortError') return true; console.warn('Picker non disponibile/fallito. Fallback al download.', e); } try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=suggestedName||'download.json'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},400); toast('Download avviato'); return true; }catch(err){ alert('Salvataggio non riuscito: '+(err && err.message ? err.message : err)); return false; } }
async function saveLinksWithPicker(){ try{ const data = JSON.stringify({sections: state.sections||[], links: state.links||[]}, null, 2); const blob = new Blob([data], {type:'application/json'}); await saveBlobWithPicker(blob, 'linkhub-links.json'); }catch(e){ alert('Salvataggio link non riuscito: '+(e&&e.message?e.message:e)); } }
async function saveOPWithPicker(){ try{ const data=JSON.stringify({openPoints: state.openPoints||[]}, null, 2); const blob=new Blob([data], {type:'application/json'}); await saveBlobWithPicker(blob, 'open-points.json'); }catch(e){ alert('Salvataggio OP non riuscito: '+(e&&e.message?e.message:e)); } }
</script>
<script>
(function(){
  function setupFit(root){
    var vps = root.querySelectorAll('.fit-viewport');
    vps.forEach(function(vp){
      var content = vp.querySelector('.fit-content');
      if(!content) return;
      var maxScale = parseFloat(vp.getAttribute('data-max-scale')||'1');
      var minScale = parseFloat(vp.getAttribute('data-min-scale')||'0.2');

      function measureNatural(){
        // Temporarily reset transform to measure natural size
        var prev = content.style.transform;
        content.style.transform = 'none';
        // Use scrollWidth/Height to account for contents
        var natW = content.scrollWidth;
        var natH = content.scrollHeight;
        content.style.transform = prev;
        return {natW:natW, natH:natH};
      }

      function applyFit(){
        var rect = vp.getBoundingClientRect();
        var W = rect.width, H = rect.height;
        if(W<=0 || H<=0) return;
        var m = measureNatural();
        var s = Math.min(W / (m.natW||1), H / (m.natH||1));
        if(!isFinite(s) || s<=0) s = 1;
        if(maxScale>0) s = Math.min(s, maxScale);
        if(minScale>0) s = Math.max(s, minScale);
        var center = vp.getAttribute('data-center') === 'true';
        var tx = center ? (W - m.natW * s) / 2 : 0;
        var ty = center ? (H - m.natH * s) / 2 : 0;
        content.style.transform = 'translate(' + Math.floor(tx) + 'px,' + Math.floor(ty) + 'px) scale(' + s + ')';
      }

      var ro = new ResizeObserver(function(){ applyFit(); });
      ro.observe(vp);
      // If dialog is closed/opened, re-apply
      var dlg = vp.closest('dialog');
      if(dlg){ dlg.addEventListener('close', applyFit); }
      window.addEventListener('resize', applyFit);
      // Initial after paint
      requestAnimationFrame(applyFit);
      setTimeout(applyFit, 60);
    });
  }

  // Setup on DOM ready
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setupFit(document);
  }else{
    document.addEventListener('DOMContentLoaded', function(){ setupFit(document); });
  }
})();
</script>
<script>
// === v44.0b ES5 SAFE: Autosave diretto (serverless) o fallback Issue ===
(function(){
  var LS_CFG = 'autosave.repo';
  var LS_LAST = 'autosave.last';
  var LABEL = 'autosave';
  function djb2(str){ var h=5381; for(var i=0;i<str.length;i++){ h=((h<<5)+h) + str.charCodeAt(i); h=h|0; } return (h>>>0).toString(16); }
  function toast(msg){ try{ var t=document.createElement('div'); t.textContent=msg; t.style.position='fixed'; t.style.bottom='18px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.background='#0b1227'; t.style.border='1px solid #334155'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex=99; t.style.color='#e5e7eb'; document.body.appendChild(t); setTimeout(function(){t.remove();},1600);}catch(e){} }
  function buildPayload(){
    try{
      var slim = {
        sections: (window.state && Object.prototype.toString.call(state.sections)==='[object Array]') ? state.sections : [],
        links:    (window.state && Object.prototype.toString.call(state.links)==='[object Array]')    ? state.links    : [],
        openPoints:(window.state && Object.prototype.toString.call(state.openPoints)==='[object Array]')? state.openPoints: [],
        services: (window.state && Object.prototype.toString.call(state.services)==='[object Array]') ? state.services : [],
        crq:      (window.state && Object.prototype.toString.call(state.crq)==='[object Array]')      ? state.crq      : []
      };
      return JSON.stringify(slim);
    }catch(e){ return JSON.stringify({sections:[],links:[],openPoints:[],services:[],crq:[]}); }
  }
  function saveDirect(){
    var ep = (window.AUTOSAVE_ENDPOINT||'').trim();
    if (!/^https?:\/\//i.test(ep)) return false; // non configurato -> usa fallback
    var json = buildPayload();
    try{
      var lastRaw = localStorage.getItem(LS_LAST);
      if (lastRaw){
        var last = JSON.parse(lastRaw);
        if (last && last.hash===djb2(json) && (Date.now()-last.ts)<20000){ toast('Attendi qualche secondo prima di ripetere il salvataggio'); return true; }
      }
    }catch(e){}
    return fetch(ep, { method:'POST', headers:{'Content-Type':'application/json'}, body: json })
      .then(function(res){ if(!res.ok) return res.text().then(function(t){ throw new Error(t||res.statusText);}); return res; })
      .then(function(){ try{ localStorage.setItem(LS_LAST, JSON.stringify({ ts: Date.now(), hash: djb2(json) })); }catch(e){} toast('Salvato su repo ‚úî'); return true; })
      .catch(function(err){ alert('Autosave fallito: '+ (err && err.message ? err.message : err)); return true; });
  }
  function getRepoCfg(){
    try{ var raw = localStorage.getItem(LS_CFG); if (raw){ var cfg=JSON.parse(raw); if (cfg && cfg.owner && cfg.repo) return cfg; } }catch(e){}
    var owner = prompt('GitHub OWNER/ORG (es. my-org o mio-utente):',''); if(!owner) throw new Error('Owner mancante');
    var repo  = prompt('GitHub REPO (es. linkhub):',''); if(!repo)  throw new Error('Repo mancante');
    var cfg = {owner:String(owner).trim(), repo:String(repo).trim()}; localStorage.setItem(LS_CFG, JSON.stringify(cfg)); return cfg;
  }
  function openIssueURL(owner, repo, title, labels, body){
    var base = 'https://github.com/'+encodeURIComponent(owner)+'/'+encodeURIComponent(repo)+'/issues/new';
    var params = new URLSearchParams(); params.set('title', title); if(labels&&labels.length) params.set('labels', labels.join(',')); params.set('body', body);
    var url = base+'?'+params.toString(); window.open(url, '_blank', 'noopener');
  }
  function copyToClipboard(text){
    try{ navigator.clipboard.writeText(text); return true; }
    catch(e){ var ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); var ok=document.execCommand('copy'); ta.remove(); return ok; }
  }
  function handleSave(){
    try{
      var direct = saveDirect();
      if (direct && typeof direct.then==='function'){
        direct.then(function(done){ if(done) return; fallbackIssue(); });
      } else if (!direct){
        fallbackIssue();
      }
    }catch(e){ alert('Salvataggio non riuscito: ' + (e && e.message ? e.message : e)); }
  }
  function fallbackIssue(){
    var cfg = getRepoCfg();
    var json = buildPayload();
    var ts = new Date().toISOString();
    var compactHash = djb2(json);
    var pretty = JSON.stringify(JSON.parse(json), null, 2);
    var header = 'Autosave payload\n' + 'Timestamp: ' + ts + 'Content-Hash: ' + compactHash;
    var bodyBlock = '```json' + pretty + '```';
    var issueBody = header + '\n' + bodyBlock + ''

<!-- linkhub-autosave -->';
    var MAX_URL_BODY = 6500;
    var safeBodyForURL = issueBody.length <= MAX_URL_BODY ? issueBody : null;
    if (safeBodyForURL){ openIssueURL(cfg.owner, cfg.repo, 'autosave '+ts, [LABEL], safeBodyForURL); toast("Si apre GitHub: conferma la creazione dell'Issue"); }
    else{
      var ok = copyToClipboard(issueBody);
      if (ok){
        var smallBody = '**Incolla il payload negli appunti tra i marker qui sotto e premi Submit.**\n```json\nPASTE_HERE\n```Timestamp: '+ts+'	Content-Hash: '+compactHash+''

<!-- linkhub-autosave -->';
        openIssueURL(cfg.owner, cfg.repo, 'autosave '+ts, [LABEL], smallBody);
        toast("Payload copiato: incollalo nel corpo dell'Issue");
      } else { alert('Copia negli appunti non riuscita: prova a ripetere o ridurre i dati'); }
    }
  }
  // esponi per tile e pulsanti
  if(!window.handleSave) window.handleSave = handleSave;
})();
</script>
<script>
// === v44.1: Autoload dai file in /data (sempre all'avvio) ===
(function(){
  function safeJSON(t){ try{ return JSON.parse(t); }catch(e){ throw new Error('JSON non valido'); } }
  async function safeFetchJSON(url){ const r=await fetch(url,{cache:'no-cache'}); if(!r.ok) throw new Error('HTTP '+r.status+' '+url); const t=await r.text(); return safeJSON(t); }
  async function autoload() {
  // PATCH v2.1.4: tenta sempre autoload da /data se disponibile

    if(!location || !/^https?:/i.test(location.protocol)) return;
    const base = new URL('./data/', location.href).href;
    const files = [
  {name:'linkhub-links.json', map:function(data,acc){ if(Object.prototype.toString.call(data)==='[object Array]'){ acc.links=data; } else { if(data.sections) acc.sections = (Object.prototype.toString.call(data.sections)==='[object Array]')? data.sections : acc.sections; if(data.links) acc.links = (Object.prototype.toString.call(data.links)==='[object Array]')? data.links : acc.links; } }},
  {name:'open-points.json', map:function(data,acc){ var arr = (Object.prototype.toString.call(data)==='[object Array]')? data : ((data && Object.prototype.toString.call(data.openPoints)==='[object Array]')? data.openPoints : []); acc.openPoints = arr; }},
  {name:'crq.json', map:function(data,acc){ var arr = (Object.prototype.toString.call(data)==='[object Array]')? data : ((data && Object.prototype.toString.call(data.crq)==='[object Array]')? data.crq : []); acc.crq = arr; }},
  {name:'services.json', map:function(data,acc){ var arr = (Object.prototype.toString.call(data)==='[object Array]')? data : ((data && Object.prototype.toString.call(data.services)==='[object Array]')? data.services : []); acc.services = arr; }}];
    let acc={sections:[],links:[],openPoints:[],services:[],crq:[]}; let any=false;
    for(const f of files){ try{ const j = await safeFetchJSON(base+f.name); f.map(j, acc); any=true; }catch(e){} }
    if(!any) return;
    try{ if(typeof normalizeState==='function'){ const norm = normalizeState(acc); if(norm){ window.state = norm; save(state); render(); renderOpenPoints(); renderServices(); try{ if(window.renderCrq) window.renderCrq(); else if(typeof renderCrq==='function') renderCrq(); }catch(e){} updateFilterSectionsBtn(); } } }catch(e){}
  }
  document.addEventListener('DOMContentLoaded', autoload);
  try{window.reloadFromRepo = async function(force){
    try{ if(force && typeof setRepoMode==='function') setRepoMode(true); }catch(e){}
    try{ await autoload(); try{ if(window.renderCrq) window.renderCrq(); else if(typeof renderCrq==='function') renderCrq(); }catch(e){} if(typeof toast==='function') toast('Dati ricaricati dal repo'); }catch(e){ alert('Caricamento dal repo non riuscito: '+(e&&e.message?e.message:e)); }
  };}catch(e){}
})();
</script>
<!-- HELP CRQ DIALOG -->
<dialog id="helpCrqDlg"><div class="modal"><header class="modal-bar"><span class="title">HELP CRQ ‚Äî Mappatura stati</span><button aria-label="Chiudi" class="close" id="helpCrqCloseXBtn" onclick="document.getElementById('helpCrqDlg').close()">‚úï</button></header><div class="content"><div id="helpCrqHint">Clicca una riga per copiare (Invio/Spazio).</div><div id="helpCrqTableWrap"><table class="table" id="helpCrqTable"><thead><tr><th>BMC Helix (CRQ)</th><th>Bhelp Operatore (RFC)</th><th>NOTE</th></tr></thead><tbody><tr data-bhelp="n.a." data-bmc="Bozza" data-note="Dopo apertura richiedere slot" role="button" tabindex="0"><td>Bozza</td><td>n.a.</td><td>Dopo apertura richiedere slot</td></tr><tr data-bhelp="Verifica Referente Servizio IT" data-bmc="Richiesta autorizzazione" data-note="-" role="button" tabindex="0"><td>Richiesta autorizzazione</td><td>Verifica Referente Servizio IT</td><td>-</td></tr><tr data-bhelp="Deploy Test / Esecuzione Test" data-bmc="Pianificazione in corso" data-note="Marted√¨ settimana prima del rilascio" role="button" tabindex="0"><td>Pianificazione in corso</td><td>Deploy Test / Esecuzione Test</td><td>Marted√¨ settimana prima del rilascio</td></tr><tr data-bhelp="Completamento Test" data-bmc="Revisione pianificata" data-note="-" role="button" tabindex="0"><td>Revisione pianificata</td><td>Completamento Test</td><td>-</td></tr><tr data-bhelp="Verifica ICT" data-bmc="Approvazione pianificata" data-note="Giorno prima del rilascio" role="button" tabindex="0"><td>Approvazione pianificata</td><td>Verifica ICT</td><td>Giorno prima del rilascio</td></tr><tr data-bhelp="n.a." data-bmc="Pianificato" data-note="" role="button" tabindex="0"><td>Pianificato</td><td>n.a.</td><td></td></tr><tr data-bhelp="Preparazione Installazione / Installazione" data-bmc="Implementazione in corso" data-note="" role="button" tabindex="0"><td>Implementazione in corso</td><td>Preparazione Installazione / Installazione</td><td></td></tr><tr data-bhelp="n.a." data-bmc="Completato" data-note="" role="button" tabindex="0"><td>Completato</td><td>n.a.</td><td></td></tr><tr data-bhelp="Chiuso Deploy" data-bmc="Chiuso" data-note="" role="button" tabindex="0"><td>Chiuso</td><td>Chiuso Deploy</td><td></td></tr></tbody></table></div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="primary" onclick="document.getElementById('helpCrqDlg').close()">‚úñÔ∏è CHIUDI</button></div></div></div></dialog>
<div id="helpCrqOverlay"></div>
<div id="helpCrqCard"><header><span><strong>HELP CRQ ‚Äî Mappatura stati</strong> (fallback)</span><div><button id="helpCrqCloseBtn">‚úñÔ∏è Chiudi</button></div></header><div class="body"><div id="helpCrqBodyMount"></div></div></div>
<script>(function(){function mountFromDialog(){var dlg=document.getElementById('helpCrqDlg');var mount=document.getElementById('helpCrqBodyMount');if(!dlg||!mount)return false;var inner=dlg.querySelector('.content');if(!inner)return false;mount.innerHTML=inner.outerHTML;return true}function showCard(){var ov=document.getElementById('helpCrqOverlay');var card=document.getElementById('helpCrqCard');if(!ov||!card)return;ov.style.display='block';card.style.display='block';var b=document.getElementById('helpCrqCloseBtn');if(b){b.onclick=function(){ov.style.display='none';card.style.display='none'}}}window.openHelpCrq=(function(orig){return function(){try{var d=document.getElementById('helpCrqDlg');if(d&&d.showModal){d.showModal();return}}catch(e){}try{if(mountFromDialog()){showCard();return}}catch(e){}alert('Impossibile aprire HELP CRQ: controlla che il browser permetta i dialog, oppure usa questo file via http:// (non file://).')}})(window.openHelpCrq||function(){});document.addEventListener('DOMContentLoaded',function(){var btn=document.getElementById('helpCrqBtn');if(btn&&!btn.onclick){btn.addEventListener('click',function(){window.openHelpCrq()})}});})();</script>
<!-- HELP CRQ JS --><script>(function(){function getRoot(){var ov=document.getElementById('helpCrqOverlay');var card=document.getElementById('helpCrqCard');if(ov&&card&&ov.style.display==='block'&&card.style.display==='block'){return card}var dlg=document.getElementById('helpCrqDlg');return dlg||document}function copyText(t){try{if(navigator.clipboard){navigator.clipboard.writeText(t);return true}}catch(e){}try{var a=document.createElement('textarea');a.value=t;document.body.appendChild(a);a.select();document.execCommand('copy');a.remove();return true}catch(_){return false}}function fmtRow(tr){var bmc=tr.getAttribute('data-bmc')||'',bhelp=tr.getAttribute('data-bhelp')||'',note=tr.getAttribute('data-note')||'';return ['BMC Helix (CRQ): '+bmc,'Bhelp Operatore (RFC): '+bhelp,'NOTE: '+(note||'')].join('\n')}function markCopied(el){el.classList.add('copied');setTimeout(function(){el.classList.remove('copied')},1000)}function onActivate(tr){var txt=fmtRow(tr);var ok=copyText(txt);if(!ok)alert('Copia negli appunti non riuscita');try{if(typeof window.toast==='function'){toast('Riga copiata')}}catch(_){ }markCopied(tr)}function bindInside(root){var table=(root||document).querySelector('#helpCrqTable');if(table&&!table._helpbound){table._helpbound=true;table.addEventListener('click',function(ev){var tr=ev.target.closest('tr[data-bmc]');if(tr)onActivate(tr)});table.addEventListener('keydown',function(ev){if(ev.key==='Enter'||ev.key===' '){var tr=ev.target.closest('tr[data-bmc]');if(tr){ev.preventDefault();onActivate(tr)}}})}}window.openHelpCrq=(function(orig){return function(){try{var d=document.getElementById('helpCrqDlg');if(d&&d.showModal){d.showModal();bindInside(d);return}}catch(e){}try{var mountOk=false;var dlg=document.getElementById('helpCrqDlg');var mount=document.getElementById('helpCrqBodyMount');if(dlg&&mount){var inner=dlg.querySelector('.content');if(inner){mount.innerHTML=inner.outerHTML;mountOk=true}}var ov=document.getElementById('helpCrqOverlay');var card=document.getElementById('helpCrqCard');if(mountOk&&ov&&card){ov.style.display='block';card.style.display='block';var b=document.getElementById('helpCrqCloseBtn');if(b){b.onclick=function(){ov.style.display='none';card.style.display='none'}}bindInside(card);return}}catch(e){}alert('Impossibile aprire HELP CRQ: prova via http:// (non file://)')}})(window.openHelpCrq||function(){});document.addEventListener('DOMContentLoaded',function(){var dlg=document.getElementById('helpCrqDlg');if(dlg)bindInside(dlg);var btn=document.getElementById('helpCrqBtn');if(btn&&!btn.onclick){btn.addEventListener('click',function(){window.openHelpCrq()})}})})();</script>
<script>
(function(){
  function csvToArr(s){ return String(s||'').split(',').map(x=>x.trim()).filter(Boolean); }
  function getCheckedValues(containerId){ var box=document.getElementById(containerId); if(!box) return []; return Array.prototype.filter.call(box.querySelectorAll('input[type=checkbox]'), el=>el.checked).map(el=>el.value); }
  function setCheckedValues(containerId, values){ var set=new Set((values||[]).map(String)); var box=document.getElementById(containerId); if(!box) return; Array.prototype.forEach.call(box.querySelectorAll('input[type=checkbox]'), el=>{ el.checked=set.has(el.value); }); }

  var prevOpen = window.openSvcFilterDialog;
  window.openSvcFilterDialog = function(){
    try{
      var dlg=document.getElementById('svcFilterDlg'); if(!dlg){ if(prevOpen) return prevOpen(); return; }
      if(typeof svcFilter==='undefined' && typeof loadSvcFilter==='function'){ window.svcFilter = loadSvcFilter(); }
      var f = svcFilter || {};
      var t=document.getElementById('svcfText'); if(t) t.value = f.text||'';
      setCheckedValues('svcfTipoGroup', f.tipi||[]);
      [['svcfId', f.id||''],['svcfRoutine', (f.routine||[]).join(', ')],['svcfServizi', (f.servizi||[]).join(', ')],['svcfDescrizione', f.descr||''],['svcfAmbiti', (f.ambiti||[]).join(', ')],['svcfApplicativi', (f.applicativi||[]).join(', ')],['svcfFallback', (f.fallback||[]).join(', ')],['svcfOperation', (f.operations||[]).join(', ')],['svcfParamsIn', (f.params||[]).join(', ')],['svcfOutput', (f.outputs||[]).join(', ')]]
      .forEach(function([id,val]){ var el=document.getElementById(id); if(el) el.value=val; });
      try{
        var statiDistinct = (typeof distinctFromServicesField==='function') ? distinctFromServicesField('stato') : [];
        var box = document.getElementById('svcfStatoGroup'); if(box){
          var uniq = Array.from(new Set((statiDistinct||[]).filter(Boolean))).sort(function(a,b){return String(a).localeCompare(String(b));});
          box.innerHTML = uniq.length ? uniq.map(function(v){return '<label><input type="checkbox" value="'+String(v)+'"/> '+String(v)+'</label>';}).join('') : '<small style="color:var(--muted)">Nessuno stato disponibile</small>';
          setCheckedValues('svcfStatoGroup', f.stati||[]);
        }
      }catch(_){ }
      document.getElementById('svcFilterCloseXBtn').onclick=function(){ dlg.close(); };
      document.getElementById('svcfResetBtn').onclick=function(){ if(typeof defaultSvcFilter==='function'){ svcFilter=defaultSvcFilter(); } if(typeof saveSvcFilter==='function') saveSvcFilter(svcFilter); if(typeof renderServices==='function') renderServices(); dlg.close(); };
      document.getElementById('svcfApplyBtn').onclick=function(){
        svcFilter = {
          text: String((document.getElementById('svcfText')||{}).value||'').trim().toLowerCase(),
          id: String((document.getElementById('svcfId')||{}).value||'').trim().toLowerCase(),
          descr: String((document.getElementById('svcfDescrizione')||{}).value||'').trim().toLowerCase(),
          tipi: getCheckedValues('svcfTipoGroup'),
          ambiti: csvToArr((document.getElementById('svcfAmbiti')||{}).value||''),
          routine: csvToArr((document.getElementById('svcfRoutine')||{}).value||''),
          servizi: csvToArr((document.getElementById('svcfServizi')||{}).value||''),
          applicativi: csvToArr((document.getElementById('svcfApplicativi')||{}).value||''),
          fallback: csvToArr((document.getElementById('svcfFallback')||{}).value||''),
          operations: csvToArr((document.getElementById('svcfOperation')||{}).value||''),
          params: csvToArr((document.getElementById('svcfParamsIn')||{}).value||''),
          outputs: csvToArr((document.getElementById('svcfOutput')||{}).value||''),
          stati: getCheckedValues('svcfStatoGroup')
        };
        if(typeof saveSvcFilter==='function') saveSvcFilter(svcFilter);
        if(typeof renderServices==='function') renderServices();
        dlg.close();
      };
      dlg.showModal();
    }catch(e){ console.error('SVC filter open error', e); if(prevOpen) try{prevOpen();}catch(_){} }
  };
})();
</script>


<!-- Dialog: Open Points (Accordion in dialog) -->
<dialog id="openPointsDlg">
<div class="modal">
<header class="modal-bar">
<span class="title">Open Points</span>
<button aria-label="Chiudi" class="close" id="openPointsCloseXBtn">‚úï</button>
</header>
<div class="content">
<section class="section" id="opSection">
<div class="section-header" style="background: linear-gradient(90deg, #0b3a68, #0f447a); border-bottom: 1px solid #0f447a80;">
<div class="section-title">
<button class="toggle" id="opToggle">‚ñæ</button>
<span>üìù</span> <span>Open Points</span>
</div>
<div class="section-actions">
<button onclick="openOpDialog()">‚ûï Nuovo</button>
<button onclick="(window.showSaveFilePicker? saveOPWithPicker() : openSaveOPDialog())">üíæ Salva OP</button>
<button onclick="importOpenPointsFromFile()">üì• Carica OP</button>
<button onclick="openOpFilterDialog()">üîé Filtra</button>
<button onclick="exportOpenPointsToCSV()">üì§ Export CSV</button>
<button onclick="exportOpenPointsToExcel()">üì§ Export Excel (.xls)</button>
<button class="danger" onclick="clearOpenPoints()">üßπ Pulisci OP</button>
</div>
</div>
<div id="opBody">
<div class="grid" style="padding:0">
<div id="opSummaryBar"><div class="count" id="opCount">0 risultati su 0</div></div>
<div id="opTableWrap">
<table class="table" id="opTable"></table>
</div>
</div>
</div>
</section>
</div>
</div></dialog>
<script>
function openOpenPointsDialog(){
  try{ var dlg=document.getElementById("openPointsDlg"); if(dlg && dlg.showModal){ dlg.showModal(); } else { alert("Apri il file nel browser per usare questa finestra."); } }
  catch(e){ alert("Apri il file nel browser per usare questa finestra."); }
}
window.addEventListener("DOMContentLoaded", function(){
  try{ var btn=document.getElementById("openPointsBtn"); if(btn){ btn.addEventListener("click", openOpenPointsDialog); } }catch(e){}
  try{ var x=document.getElementById("openPointsCloseXBtn"); if(x){ x.addEventListener("click", function(){ var dlg=document.getElementById("openPointsDlg"); if(dlg) dlg.close(); }); } }catch(e){}
});
</script>
<script>
// === CRQ: normalizzazione + export/import (v1) ===
function str(v){return (v==null? '': String(v)).trim();}
function boolish(v){
  const s = String(v==null?'':v).trim().toLowerCase();
  return s==='1' || s==='true' || s==='si' || s==='s√¨' || s==='x' || s==='yes';
}
function normalizeCRQItem(o){
  // v1.3c: unify keys for table rendering
  function str(x){ return String(x==null?'':x).trim(); }
  function boolish(x){ var s=str(x).toLowerCase(); if(s==='si'||s==='s√¨'||s==='yes'||s==='true'||s==='1') return 'S√¨'; if(s==='no'||s==='false'||s==='0') return 'No'; return str(x); }
  return {
    id: o && o.id ? String(o.id) : (crypto && crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(16).slice(2)+'-'+Date.now())),
    rfcAperti: str(o.rfcAperti || o.rfc || o.RFC || o['RFC'] || o['RFC Aperti']),
    dataApertura: str(o.dataApertura || o['Data apertura'] || o.openedAt),
    anno: str(o.anno || o['Anno']),
    emerg: boolish(o.emerg || o.emergenza || o['Emerg.'] || o.emerg),
    utilizzato: boolish(o.utilizzato || o['Utilizzato']),
    categoria: str(o.categoria || o['Categoria']),
    dataRilascio: str(o.dataRilascio || o['Data rilascio'] || o.releaseAt),
    rifNostro: str(o.rifNostro || o['Rif nostro'] || o.riferimento),
    prj: str(o.prj || o['PRJ'] || o.progetto),
    contenuto: str(o.contenuto || o['Contenuto'] || o.content)
  }
};

async function exportCrqToFile(fileName){
  try{
    var data = JSON.stringify({ crq: (window.state && Array.isArray(state.crq)) ? state.crq : [] }, null, 2);
    var blob = new Blob([data], {type:'application/json'});
    await saveBlobWithPicker(blob, fileName || 'crq.json');
  }catch(e){ alert('Salvataggio CRQ non riuscito: ' + (e && e.message ? e.message : e)); }
}
window.importCrqFromFile = async function(){
  try{
    var inp = document.createElement('input');
    inp.type='file'; inp.accept='application/json';
    inp.onchange = async function(){
      var f = inp.files[0]; if(!f) return; var text = await f.text();
      try{
        var json = JSON.parse(text);
        var arr = Array.isArray(json) ? json : (Array.isArray(json.crq) ? json.crq : null);
        if(!arr){ alert('JSON non valido: atteso array o { crq: [...] }'); return; }
        state.crq = arr.map(normalizeCRQItem);
        if(typeof save==='function') save();
        if(typeof render==='function') render();
        if(typeof renderOpenPoints==='function') renderOpenPoints();
        if(typeof renderServices==='function') renderServices();
        if(typeof updateFilterSectionsBtn==='function') updateFilterSectionsBtn();
        try{ toast('CRQ caricati da file'); }catch(_){}
      }catch(err){ alert('Errore import CRQ: ' + err.message); }
    };
    inp.click();
  }catch(e){ alert('Caricamento CRQ fallito: ' + e.message); }
};
document.addEventListener('DOMContentLoaded', function(){
  var ex = document.getElementById('crqExportBtn'); if(ex){ ex.addEventListener('click', function(){ exportCrqToFile('crq.json'); }); }
  var im = document.getElementById('crqImportBtn'); if(im){ im.addEventListener('click', function(){ importCrqFromFile(); }); }
});
</script>


<script>
// Fonte unica dei dati CRQ per la UI
function getCrqArray() {
  try {
    if (window.state && Array.isArray(window.state.crq)) return window.state.crq;
  } catch(_) {}
  return [];
}
</script>
<script>
(function(){
  // ---- Data & helpers ----
  function normalizeCRQItem(o){
    var k = ['rfcAperti','dataApertura','anno','emerg','utilizzato','categoria','dataRilascio','rifNostro','prj','contenuto'];
    var n = {};
    for (var i=0;i<k.length;i++){ var key=k[i]; n[key] = (o && o[key]!=null) ? String(o[key]) : ''; }
    if (/^\s*true\s*$/i.test(n.utilizzato)) n.utilizzato='Si';
    if (/^\s*false\s*$/i.test(n.utilizzato)) n.utilizzato='No';
    if (n.emerg==='Si' || n.emerg==='S√¨' || n.emerg==='si' ) n.emerg='S√¨';
    if (n.emerg==='No' || n.emerg==='no') n.emerg='No';
    return n;
  }
  function getCRQ(){ try{ return Array.isArray(state && state.crq) ? state.crq : []; }catch(e){ return []; } }
  function setCRQ(arr){ try{ if (!state) state={}; state.crq = (arr||[]).map(normalizeCRQItem); if (typeof save==='function') save(state); }catch(e){} }
  function ensureCRQ(){ setCRQ(getCRQ()); }

  // ---- Filter model ----
  var CRQF_KEY='crq.filter.v1';
  function defaultCrqFilter(){ return { text:'', rfc:'', anno:'', emerg:[], utilizzato:[], categoria:'', rif:'', prj:'', contenuto:'', apFrom:'', apTo:'', rilFrom:'', rilTo:'' }; }
  function loadCrqFilter(){ try{ var raw=localStorage.getItem(CRQF_KEY); if(!raw) return defaultCrqFilter(); var f=JSON.parse(raw); return Object.assign(defaultCrqFilter(), f); }catch(e){ return defaultCrqFilter(); } }
  function saveCrqFilter(f){ try{ localStorage.setItem(CRQF_KEY, JSON.stringify(f||defaultCrqFilter())); }catch(e){} }
  var crqFilter = loadCrqFilter();

  // ---- Sorting ----
  var crqSort = { key:'dataRilascio', dir:'desc' };
  function sortArrowFor(key){ if(crqSort.key!==key) return ''; return ' <span class="arrow">'+(crqSort.dir==='asc'?'‚Üë':'‚Üì')+'</span>'; }
  function cmp(a,b){ return a<b?-1:a>b?1:0; }
  function cmpDate(a,b){ try{ a=a? new Date(a).toISOString().slice(0,10):''; b=b? new Date(b).toISOString().slice(0,10):''; }catch(_){ } return cmp(a,b); }

  function setCrqSort(key){ if(crqSort.key===key){ crqSort.dir = (crqSort.dir==='asc'?'desc':'asc'); } else { crqSort.key=key; crqSort.dir = (key==='dataApertura'||key==='dataRilascio')?'desc':'asc'; } renderCrq(); }

  // ---- Filtering ----
  function inRange(val, from, to){ if(!val) return true; try{ var v=new Date(val).toISOString().slice(0,10); if(from && v<from) return false; if(to && v>to) return false; return true; }catch(e){ return true; } }
  function arrHas(arr, v){ return Array.isArray(arr)&&arr.length? arr.indexOf(v)>=0 : true; }
  function applyCrqFilters(rows){ var f=crqFilter||defaultCrqFilter();
    return (rows||[]).filter(function(o){
      var bag=[o.rfcAperti,o.anno,o.emerg,o.utilizzato,o.categoria,o.rifNostro,o.prj,o.contenuto].join(' ').toLowerCase();
      var text=(f.text||'').toLowerCase(); if(text && bag.indexOf(text)===-1) return false;
      if (f.rfc && String(o.rfcAperti||'').toLowerCase().indexOf(String(f.rfc).toLowerCase())===-1) return false;
      if (f.anno && String(o.anno||'').toLowerCase().indexOf(String(f.anno).toLowerCase())===-1) return false;
      if (Array.isArray(f.emerg) && f.emerg.length && f.emerg.indexOf(o.emerg)<0) return false;
      if (Array.isArray(f.utilizzato) && f.utilizzato.length && f.utilizzato.indexOf(o.utilizzato)<0) return false;
      if (f.categoria && String(o.categoria||'').toLowerCase().indexOf(String(f.categoria).toLowerCase())===-1) return false;
      if (!inRange(o.dataApertura||'', f.apFrom||'', f.apTo||'')) return false;
      if (!inRange(o.dataRilascio||'', f.rilFrom||'', f.rilTo||'')) return false;
      if (f.rif && String(o.rifNostro||'').toLowerCase().indexOf(String(f.rif).toLowerCase())===-1) return false;
      if (f.prj && String(o.prj||'').toLowerCase().indexOf(String(f.prj).toLowerCase())===-1) return false;
      if (f.contenuto && String(o.contenuto||'').toLowerCase().indexOf(String(f.contenuto).toLowerCase())===-1) return false;
      return true;
    });
  }
  function sortCrqRows(rows){ var k=crqSort.key, d=(crqSort.dir==='desc'?-1:1);
    return rows.slice().sort(function(x,y){ var r=0;
      if(k==='dataApertura'||k==='dataRilascio'){ r=cmpDate(x[k]||'', y[k]||''); }
      else { r=cmp(String(x[k]||'').toLowerCase(), String(y[k]||'').toLowerCase()); }
      return r*d;
    });
  }

  // ---- Render ----
  function renderCrq(){ var tbl=document.getElementById('crqTable'); if(!tbl) return;
    ensureCRQ(); var all=getCRQ(); var filtered = applyCrqFilters(all); var rows = sortCrqRows(filtered);
    var countEl=document.getElementById('crqCount'); if(countEl) countEl.textContent = rows.length+" risultati su "+all.length;
        var head = `<thead><tr>
      <th class="sortable" onclick="setCrqSort('rfcAperti')">RFC Aperti${sortArrowFor('rfcAperti')}</th>
      <th class="sortable" onclick="setCrqSort('dataApertura')">Data apertura${sortArrowFor('dataApertura')}</th>
      <th class="sortable" onclick="setCrqSort('anno')">Anno${sortArrowFor('anno')}</th>
      <th class="sortable" onclick="setCrqSort('emerg')">Emerg.${sortArrowFor('emerg')}</th>
      <th class="sortable" onclick="setCrqSort('utilizzato')">Utilizzato${sortArrowFor('utilizzato')}</th>
      <th class="sortable" onclick="setCrqSort('categoria')">Categoria${sortArrowFor('categoria')}</th>
      <th class="sortable" onclick="setCrqSort('dataRilascio')">Data rilascio${sortArrowFor('dataRilascio')}</th>
      <th class="sortable" onclick="setCrqSort('rifNostro')">Rif nostro${sortArrowFor('rifNostro')}</th>
      <th class="sortable" onclick="setCrqSort('prj')">PRJ${sortArrowFor('prj')}</th>
      <th class="sortable" onclick="setCrqSort('contenuto')">Contenuto${sortArrowFor('contenuto')}</th>
      <th>Azioni</th>
    </tr></thead>`;

    if(rows.length===0){ tbl.innerHTML = head + '<tbody><tr><td colspan="11"><div class="empty">Nessuna CRQ</div></td></tr></tbody>'; return; }
    var body = '<tbody>' + rows.map(function(o){
      var idx = getCRQ().indexOf(o); if(idx<0) idx = 0;
      return '<tr>'
      + '<td>'+escapeHtml(o.rfcAperti||'')+'</td>'
      + '<td>'+escapeHtml(o.dataApertura||'')+'</td>'
      + '<td>'+escapeHtml(o.anno||'')+'</td>'
      + '<td>'+escapeHtml(o.emerg||'')+'</td>'
      + '<td>'+escapeHtml(o.utilizzato||'')+'</td>'
      + '<td>'+escapeHtml(o.categoria||'')+'</td>'
      + '<td>'+escapeHtml(o.dataRilascio||'')+'</td>'
      + '<td>'+escapeHtml(o.rifNostro||'')+'</td>'
      + '<td>'+escapeHtml(o.prj||'')+'</td>'
      + '<td>'+escapeHtml(o.contenuto||'')+'</td>'
      + '<td><div class="table-actions">'
        + '<button title="Modifica" onclick="editCrq('+idx+')">‚úèÔ∏è</button>'
        + '<button class="danger" title="Elimina" onclick="deleteCrq('+idx+')">üóëÔ∏è</button>'
      + '</div></td>'
      + '</tr>';
    }).join('') + '</tbody>';
    tbl.innerHTML = head + body;
  }
  window.renderCrq = renderCrq; window.setCrqSort = setCrqSort;

  // ---- Editor ----
  var crqEditor = null;
  function fillEditor(item){
    document.getElementById('crqDlgTitle').textContent = item? 'Modifica CRQ' : 'Nuova CRQ';
    document.getElementById('crqRfcAperti').value = item&&item.rfcAperti||'';
    document.getElementById('crqDataApertura').value = item&&item.dataApertura||'';
    document.getElementById('crqAnno').value = item&&item.anno||'';
    document.getElementById('crqEmerg').value = item&&item.emerg||'';
    document.getElementById('crqUtilizzato').value = item&&item.utilizzato||'';
    document.getElementById('crqCategoria').value = item&&item.categoria||'';
    document.getElementById('crqDataRilascio').value = item&&item.dataRilascio||'';
    document.getElementById('crqRifNostro').value = item&&item.rifNostro||'';
    document.getElementById('crqPrj').value = item&&item.prj||'';
    document.getElementById('crqContenuto').value = item&&item.contenuto||'';
  }
  window.openCrqEditor = function(item, index){ try{ var dlg=document.getElementById('crqEditorDlg'); if(!dlg) return; crqEditor = {index:(typeof index==='number'?index:-1)}; fillEditor(item); dlg.showModal(); setTimeout(function(){ var el=document.getElementById('crqRfcAperti'); if(el) el.focus(); },50); }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); } }
  document.addEventListener('DOMContentLoaded', function(){
    var dlg=document.getElementById('crqEditorDlg'); if(!dlg) return; 
    var cancel=document.getElementById('crqCancelBtn'); if(cancel) cancel.onclick=function(){ dlg.close(); };
    var closeX=document.getElementById('crqEditorCloseXBtn'); if(closeX) closeX.onclick=function(){ dlg.close(); };
    var saveBtn=document.getElementById('crqSaveBtn'); if(saveBtn) saveBtn.onclick=function(){
      var o = normalizeCRQItem({
        rfcAperti: document.getElementById('crqRfcAperti').value,
        dataApertura: document.getElementById('crqDataApertura').value,
        anno: document.getElementById('crqAnno').value,
        emerg: document.getElementById('crqEmerg').value,
        utilizzato: document.getElementById('crqUtilizzato').value,
        categoria: document.getElementById('crqCategoria').value,
        dataRilascio: document.getElementById('crqDataRilascio').value,
        rifNostro: document.getElementById('crqRifNostro').value,
        prj: document.getElementById('crqPrj').value,
        contenuto: document.getElementById('crqContenuto').value
      });
      var arr=getCRQ(); var idx = (crqEditor && typeof crqEditor.index==='number')? crqEditor.index : -1;
      if(!o.rfcAperti){ alert('RFC Aperti √® obbligatorio'); return; }
      if(idx>=0 && idx < arr.length){ arr[idx]=o; } else { arr.push(o); }
      setCRQ(arr); try{ dlg.close(); }catch(e){ dlg.removeAttribute('open'); }
      renderCrq();
    };
  });
  window.editCrq = function(index){ var arr=getCRQ(); var item=arr[index]; openCrqEditor(item,index); };
  window.deleteCrq = function(index){ if(!confirm('Eliminare questa CRQ?')) return; var arr=getCRQ(); if(index>=0&&index<arr.length){ arr.splice(index,1); setCRQ(arr); renderCrq(); } };
  window.clearCrq = function(){ if(!confirm('Confermi? Saranno eliminate TUTTE le CRQ.')) return; setCRQ([]); renderCrq(); };

  // ---- Filters dialog ----
  function getCheckedValues(containerId){ var box=document.getElementById(containerId); if(!box) return []; return Array.prototype.filter.call(box.querySelectorAll('input[type=checkbox]'), function(el){return el.checked;}).map(function(el){return el.value;}); }
  function setCheckedValues(containerId, values){ var set=new Set((values||[]).map(String)); var box=document.getElementById(containerId); if(!box) return; Array.prototype.forEach.call(box.querySelectorAll('input[type=checkbox]'), function(el){ el.checked=set.has(el.value); }); }
  window.openCrqFilterDialog = function(){ try{
    var dlg=document.getElementById('crqFilterDlg'); if(!dlg) return alert('Dialog non disponibile');
    var f=crqFilter||defaultCrqFilter();
    document.getElementById('crqfText').value=f.text||'';
    document.getElementById('crqfRfc').value=f.rfc||'';
    document.getElementById('crqfAnno').value=f.anno||'';
    setCheckedValues('crqfEmergGroup', f.emerg||[]);
    setCheckedValues('crqfUtilGroup', f.utilizzato||[]);
    document.getElementById('crqfCategoria').value=f.categoria||'';
    document.getElementById('crqfAperturaFrom').value=f.apFrom||'';
    document.getElementById('crqfAperturaTo').value=f.apTo||'';
    document.getElementById('crqfRilFrom').value=f.rilFrom||'';
    document.getElementById('crqfRilTo').value=f.rilTo||'';
    document.getElementById('crqfRif').value=f.rif||'';
    document.getElementById('crqfPrj').value=f.prj||'';
    document.getElementById('crqfContenuto').value=f.contenuto||'';
    document.getElementById('crqfResetBtn').onclick=function(){ crqFilter=defaultCrqFilter(); saveCrqFilter(crqFilter); renderCrq(); dlg.close(); };
    document.getElementById('crqfApplyBtn').onclick=function(){
      crqFilter={
        text:String(document.getElementById('crqfText').value||'').trim().toLowerCase(),
        rfc:String(document.getElementById('crqfRfc').value||'').trim(),
        anno:String(document.getElementById('crqfAnno').value||'').trim(),
        emerg:getCheckedValues('crqfEmergGroup'),
        utilizzato:getCheckedValues('crqfUtilGroup'),
        categoria:String(document.getElementById('crqfCategoria').value||'').trim(),
        apFrom:String(document.getElementById('crqfAperturaFrom').value||'').trim(),
        apTo:String(document.getElementById('crqfAperturaTo').value||'').trim(),
        rilFrom:String(document.getElementById('crqfRilFrom').value||'').trim(),
        rilTo:String(document.getElementById('crqfRilTo').value||'').trim(),
        rif:String(document.getElementById('crqfRif').value||'').trim(),
        prj:String(document.getElementById('crqfPrj').value||'').trim(),
        contenuto:String(document.getElementById('crqfContenuto').value||'').trim()
      };
      saveCrqFilter(crqFilter); renderCrq(); dlg.close();
    };
    document.getElementById('crqFilterCloseXBtn').onclick=function(){ dlg.close(); };
    dlg.showModal();
  }catch(e){ alert('Apri il file nel browser per usare il filtro CRQ.'); }
  };

  // ---- Export / Import ----
  window.exportCrqToFile = async function(fileName){ try{
    var data = JSON.stringify({ crq: getCRQ() }, null, 2);
    var blob = new Blob([data], {type:'application/json'});
    await saveBlobWithPicker(blob, fileName||'crq.json', [ { description:'JSON', accept:{ 'application/json':['.json'] } } ]);
  }catch(e){ alert('Salvataggio CRQ non riuscito: '+(e&&e.message?e.message:e)); } };
  window.importCrqFromFile = async function(){ try{
    var inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=async function(){ var f=inp.files[0]; if(!f) return; var text=await f.text(); try{
      var json=JSON.parse(text); var arr= Array.isArray(json)? json : (Array.isArray(json.crq)? json.crq : null);
      if(!arr){ alert('JSON non valido: atteso array o { crq: [...] }'); return; }
      setCRQ(arr.map(normalizeCRQItem)); renderCrq();
    }catch(err){ alert('Errore import CRQ: '+err.message); } };
    inp.click();
  }catch(e){ alert('Caricamento CRQ fallito: '+e.message); } };

  window.exportCrqToCSV = function(){ var rows = sortCrqRows(applyCrqFilters(getCRQ()));
    var head=['RFC Aperti','Data apertura','Anno','Emerg.','Utilizzato','Categoria','Data rilascio','Rif nostro','PRJ','Contenuto'];
    function q(v){ v=(v==null?'':String(v)); return /[";]/.test(v)? '"'+v.replace(/"/g,'""')+'"' : v; }
    var csv = head.join(';')+''+rows.map(function(o){ return [o.rfcAperti,o.dataApertura,o.anno,o.emerg,o.utilizzato,o.categoria,o.dataRilascio,o.rifNostro,o.prj,o.contenuto].map(q).join(';'); }).join('');
    var blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='crq.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},400);
  };
  window.exportCrqToExcel = function(){ var rows = sortCrqRows(applyCrqFilters(getCRQ()));
    function xe(s){ return String(s==null?'':s).replace(/&/g,'&').replace(/\</g,'<').replace(/\>/g,'>'); }
    function cell(v,t){ t=t||'String'; return '<Cell><Data ss:Type="'+t+'">'+xe(v)+'</Data></Cell>'; }
    var head=['RFC Aperti','Data apertura','Anno','Emerg.','Utilizzato','Categoria','Data rilascio','Rif nostro','PRJ','Contenuto'];
    var xml='<?xml version="1.0"?>'+'<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'+'<Worksheet ss:Name="CRQ"><Table>';
    xml += '<Row>'+head.map(function(h){return cell(h);}).join('')+'</Row>';
    rows.forEach(function(o){ xml += '<Row>' + cell(o.rfcAperti) + cell(o.dataApertura) + cell(o.anno) + cell(o.emerg) + cell(o.utilizzato) + cell(o.categoria) + cell(o.dataRilascio) + cell(o.rifNostro) + cell(o.prj) + cell(o.contenuto) + '</Row>'; });
    xml += '</Table></Worksheet></Workbook>';
    var blob=new Blob([xml], {type:'application/vnd.ms-excel'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='crq.xls'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },400);
  };

  // ---- Open/Close ----
  window.openCrqList = function(){ try{ var dlg=document.getElementById('crqListDlg'); if(dlg && dlg.showModal){ dlg.showModal(); renderCrq(); } else { alert('Apri il file nel browser per usare questa finestra.'); } }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); } };
  document.addEventListener('DOMContentLoaded', function(){ try{
    var btn=document.getElementById('crqCloseXBtn'); if(btn) btn.onclick=function(){ document.getElementById('crqListDlg').close(); };
    var tgl=document.getElementById('crqToggle'), body=document.getElementById('crqBody'); if(tgl && body){ var collapsed=false; tgl.onclick=function(){ collapsed=!collapsed; body.classList.toggle('hidden', collapsed); tgl.textContent=collapsed?'‚ñ∏':'‚ñæ'; }; }
  }catch(e){}
    // render on startup if dialog is already open
    if(document.getElementById('crqListDlg') && document.getElementById('crqListDlg').open) renderCrq();
  });
})();
</script>


<script>
// === Re-added safe helpers (Copilot) ===
function openCrqList() {
  try {
    var dlg = document.getElementById('crqListDlg');
    if (dlg && dlg.showModal) { dlg.showModal(); }
    else { alert('Apri il file nel browser per usare questa finestra.'); }
  } catch (e) { alert('Apri il file nel browser per usare questa finestra.'); }
}
function openOpenPointsDialog() {
  try {
    var dlg = document.getElementById('openPointsDlg');
    if (dlg && dlg.showModal) { dlg.showModal(); }
    else { alert('Apri il file nel browser per usare questa finestra.'); }
  } catch (e) { alert('Apri il file nel browser per usare questa finestra.'); }
}
window.addEventListener('DOMContentLoaded', function(){
  try{
    var x=document.getElementById('crqCloseXBtn');
    if (x) x.addEventListener('click', function(){ var d=document.getElementById('crqListDlg'); if(d) d.close(); });
  }catch(e){}
});
</script>


<!-- === v2.1.8 PATCH: Carica da cartella compatibile con file:// === -->
<script>
(function(){
  function safeParseJSON(name, txt){ try{ return JSON.parse(txt);} catch(e){ throw new Error('JSON non valido in '+name+': '+(e&&e.message?e.message:e)); } }

  function mapFileToAcc(fileName, data, acc){
    var fn = String(fileName||'').toLowerCase();
    if(fn.indexOf('linkhub-links.json')!==-1 || fn.indexOf('links')!==-1){
      if(Object.prototype.toString.call(data)==='[object Array]') acc.links=data;
      else if(data && typeof data==='object'){
        if(Object.prototype.toString.call(data.sections)==='[object Array]') acc.sections=data.sections;
        if(Object.prototype.toString.call(data.links)==='[object Array]') acc.links=data.links;
      }
      return;
    }
    if(fn.indexOf('open-points.json')!==-1 || fn.indexOf('openpoints')!==-1 || fn.indexOf('open_points')!==-1){
      if(Object.prototype.toString.call(data)==='[object Array]') acc.openPoints=data;
      else if(data && Object.prototype.toString.call(data.openPoints)==='[object Array]') acc.openPoints=data.openPoints;
      return;
    }
    if(fn.indexOf('services.json')!==-1 || fn.indexOf('servizi')!==-1 || fn.indexOf('service')!==-1){
      if(Object.prototype.toString.call(data)==='[object Array]') acc.services=data;
      else if(data && Object.prototype.toString.call(data.services)==='[object Array]') acc.services=data.services;
      return;
    }
    if(fn.indexOf('crq.json')!==-1 || fn.indexOf('crq')!==-1){
      if(Object.prototype.toString.call(data)==='[object Array]') acc.crq=data;
      else if(data && Object.prototype.toString.call(data.crq)==='[object Array]') acc.crq=data.crq;
      return;
    }
    if(data && typeof data==='object'){
      if(Object.prototype.toString.call(data.sections)==='[object Array]') acc.sections=data.sections;
      if(Object.prototype.toString.call(data.links)==='[object Array]') acc.links=data.links;
      if(Object.prototype.toString.call(data.openPoints)==='[object Array]') acc.openPoints=data.openPoints;
      if(Object.prototype.toString.call(data.services)==='[object Array]') acc.services=data.services;
      if(Object.prototype.toString.call(data.crq)==='[object Array]') acc.crq=data.crq;
    }
  }

  async function applyAcc(acc){
    if(typeof normalizeState==='function'){
      var norm = normalizeState(acc);
      if(norm){
        window.state = norm;
        try{ if(typeof save==='function') save(state); }catch(e){}
        try{ if(typeof render==='function') render(); }catch(e){}
        try{ if(typeof renderOpenPoints==='function') renderOpenPoints(); }catch(e){}
        try{ if(typeof renderServices==='function') renderServices(); }catch(e){}
        try{ if(window.renderCrq) window.renderCrq(); else if(typeof renderCrq==='function') renderCrq(); }catch(e){}
        try{ if(typeof updateFilterSectionsBtn==='function') updateFilterSectionsBtn(); }catch(e){}
        try{ if(typeof toast==='function') toast('Import da cartella completato ‚úî'); }catch(e){}
        return;
      }
    }
    window.state = acc;
  }

  async function loadFromFileList(fileList){
    var files = Array.prototype.slice.call(fileList||[]);
    files = files.filter(function(f){ return /\.json$/i.test(f.name||''); });
    if(!files.length){ alert('Nessun file .json trovato nella selezione.'); return; }
    var acc = {sections:[], links:[], openPoints:[], services:[], crq:[]};
    var any=false;
    for(var i=0;i<files.length;i++){
      var f=files[i];
      try{
        var txt = await f.text();
        var data = safeParseJSON(f.name, txt);
        mapFileToAcc(f.name, data, acc);
        any=true;
      }catch(e){ console.warn('Skip file', f.name, e); }
    }
    if(!any){ alert('Nessun JSON valido importabile trovato.'); return; }
    await applyAcc(acc);
  }

  function pickFolderWithInput(){
    return new Promise(function(resolve){
      var input=document.createElement('input');
      input.type='file';
      input.multiple=true;
      input.accept='application/json,.json';
      input.setAttribute('webkitdirectory','');
      input.setAttribute('directory','');
      input.style.position='fixed';
      input.style.left='-9999px';
      document.body.appendChild(input);
      input.addEventListener('change', function(){
        var files = input.files ? Array.prototype.slice.call(input.files) : [];
        input.remove();
        resolve(files);
      }, {once:true});
      input.click();
    });
  }

  async function loadFromFolder(){
    try{
      var files = await pickFolderWithInput();
      await loadFromFileList(files);
    }catch(e){
      alert('Carica da cartella non riuscito: '+(e&&e.message?e.message:e));
    }
  }

  window.loadFromFolder = loadFromFolder;
})();
</script>

</body>

</html>
