<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team Sistemi Anagrafici (v19_7c)</title>
<style>
:root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --chip:#1f2937; --space:18px; --edge:clamp(8px, 2vw, 16px); }
*{box-sizing:border-box} html, body { max-width:100%; overflow-x:hidden; }
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b1023,#0f172a);color:var(--text)}
.wrap{max-width:none;margin:0;padding:var(--space) var(--edge)} header{position:sticky;top:0;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:20}
h1{margin:0;font-size:22px;display:flex;align-items:center;gap:10px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;align-items:center}
input[type="search"], select, button, .chip {border:1px solid #263041;background:#0b1328;color:var(--text);padding:10px 12px;border-radius:10px}
input[type="search"]{flex:1;min-width:220px;margin-left:20px} button{cursor:pointer}
main{padding:var(--space) var(--edge)} .section{border:1px solid #1f2937;border-radius:14px;margin-bottom:16px;background:linear-gradient(180deg,#0e142a,#091026); overflow:hidden}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
.section-title{display:flex;align-items:center;gap:10px;font-weight:600} .section-title .toggle{width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #263041;border-radius:8px;background:#0a1227}
.section-actions{display:flex;gap:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:14px; position:relative;}
.card{background:#0b1023;border:1px solid #1f2937;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
.card-head{display:flex;align-items:center;gap:10px;justify-content:space-between}
.drag-handle{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #334155;background:#0a1227;color:#cbd5e1;border-radius:8px;cursor:grab}
.drag-handle:active{cursor:grabbing} .card h3{margin:0;font-size:16px;display:flex;align-items:center;gap:8px}
.card p{margin:0;color:var(--muted);font-size:13px} .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.tag{background:var(--chip);border:1px solid #263041;color:#cbd5e1;padding:4px 8px;border-radius:8px;font-size:12px}
.actions{display:flex;gap:8px;margin-top:6px} .actions button{background:#0a1227} .actions .danger{border-color:#3a1b1b;background:#1b0f10;color:#fecaca}
a{ color:#38bdf8; text-decoration-color: rgba(56,189,248,.6); } a:visited{ color:#f59e0b; } a:hover{ color:#7dd3fc; text-decoration-color: currentColor; } a:active{ color:#22c55e; } a:focus-visible{ outline:2px dashed #22c55e; outline-offset:2px; border-radius:4px; }
dialog{border:none;border-radius:14px;padding:0;max-width:560px;width:100%} .modal{background:#0b1023;color:var(--text);border:1px solid #1f2937;border-radius:14px;overflow:hidden} .modal .content{padding:16px}
.row{display:flex;gap:10px;margin-bottom:10px} .row input, .row textarea, .row select{flex:1;width:100%;border:1px solid #263041;background:#0a1227;color:var(--text);padding:10px;border-radius:10px} .row textarea{min-height:80px}
.empty{color:#94a3b8;text-align:center;padding:40px} footer{color:#94a3b8;font-size:12px;text-align:center;padding:22px} .kbd{border:1px solid #334155;background:#0a1227;border-radius:6px;padding:2px 6px;font-family:ui-monospace,Menlo,Consolas,monospace}
.dragging{ opacity:.6; } .section.drop-target{ outline: 2px dashed rgba(34,197,94,.35); } .insert-caret{ position:absolute; width:3px; border-radius:2px; background: #22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.25), 0 0 18px rgba(34,197,94,.35); pointer-events:none; z-index:5; }
.hidden{ display:none; }
@media (max-width: 900px){ :root{ --space:14px } .grid{ gap:12px; padding:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); } }
@media (max-width: 640px){ h1{ font-size:20px } .toolbar{ flex-direction:column; align-items:stretch; gap:8px; } .toolbar > *{ width:100%; } input[type="search"]{ margin-left:0; min-width:0; } button, select, input[type="search"]{ padding:8px 10px; } .section-header{ flex-direction:column; align-items:stretch; gap:8px; } .section-actions{ justify-content:flex-end; } .grid{ grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .card{ padding:12px } .section-title .toggle{ width:24px; height:24px } }
@media (max-width: 420px){ .grid{ grid-template-columns: 1fr; } }
@media (max-width: 640px){ dialog{ margin:0; width:100vw; height:100vh; max-width:100vw; max-height:100vh; } .modal{ height:100%; border-radius:0; border-left:none; border-right:none; display:flex; flex-direction:column; } .modal-bar{ position:sticky; top:0; z-index:2; display:flex; align-items:center; justify-content:space-between; padding:12px var(--edge); background:#0b1023; border-bottom:1px solid #1f2937; } .modal-bar .title{ font-weight:600; } .modal-bar .close{ appearance:none; background:transparent; color:var(--text); border:1px solid #334155; width:36px; height:36px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; } .modal .content{ flex:1; overflow:auto; padding:12px var(--edge); } .row{ gap:8px; margin-bottom:8px } #cancelBtn{ display:none } }
dialog::backdrop{ background: rgba(2,6,23,.6) }
.modal-bar{ display:grid; grid-template-columns: 1fr auto; align-items:center; padding:12px var(--edge); background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom:1px solid #1f2937; }
.modal-bar .title{ margin:0; padding-left:8px; font-weight:600; line-height:1.2; } .modal-bar .close{ justify-self:end; width:36px; height:36px; border-radius:10px; }
.toolbar button#exportBtn{ border-color:#2563eb; box-shadow:0 0 0 1px rgba(37,99,235,.25) inset; } .toolbar button#importBtn{ border-color:#059669; box-shadow:0 0 0 1px rgba(5,150,105,.25) inset; }
.toolbar button#exportBtn:hover{ background:#0b1023; color:#bfdbfe; } .toolbar button#importBtn:hover{ background:#0b1023; color:#a7f3d0; }
.menu-btn { display:flex; align-items:flex-start; justify-content:space-between; width:100%; padding:10px 12px; border:1px solid #1f2937; background:#0b1023; color:var(--text); border-radius:10px; }
.menu-btn:hover { background:#0a1227; } .menu-btn .hint { color: var(--muted); font-size:12px; }
.menu-btn .label{ display:grid; grid-template-columns: 48px 1fr; grid-template-rows: auto auto; column-gap:8px; align-items:start; } .menu-btn .text{ grid-column:2; grid-row:1/span 2; padding-left:0; text-align:left; align-self:start; }
.menu-btn .ico{ grid-row:1/span 2; grid-column:1; display:flex; align-items:center; justify-content:center; box-sizing:border-box; width:48px; height:48px; padding:8px; font-size:1.2rem; background:#0a1227; border:1px solid #1f2937; border-radius:10px; } .menu-btn .text .name{ margin:0; padding:0; font-weight:700; font-size:15px; line-height:1.2; text-align:left; } .menu-btn .text .desc{ display:block; color: var(--muted); font-size:12px; margin:4px 0 0 0; padding:0; text-align:left; }
#sectionsDlg select.iconSel{ min-width:120px; }
#filterSectionsDlg { max-width: 1200px; width: min(96vw, 1200px); }
#filterSectionsDlg .content { padding-top: 14px; }
#filterMenu.menu-grid { display: grid !important; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 12px; align-items: stretch; }
#filterMenu .menu-btn { height: 100%; display: flex; align-items: stretch; justify-content: space-between; text-align: left; }
#filterMenu .menu-btn .label { display: grid; grid-template-columns: 48px 1fr; grid-template-rows: auto auto; column-gap: 8px; align-items: start; }
@media (max-width: 1100px) { #filterMenu.menu-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
@media (max-width: 900px) { #filterMenu.menu-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
@media (max-width: 700px) { #filterMenu.menu-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
@media (max-width: 480px) { #filterMenu.menu-grid { grid-template-columns: 1fr; } }
.toolbar button#clearAllBtn{ border-color:#7F1D1D; box-shadow:0 0 0 1px rgba(127,29,29,.25) inset; color:#FECACA; background:#1B0F10; }
.toolbar button#clearAllBtn:hover{ background:#260F12; }
.table { width: 100%; border-collapse: collapse; }
.table th, .table td { border: 1px solid #1f2937; padding: 8px 10px; font-size: 13px; vertical-align: top; }
.table th { background: #0a1227; text-align: left; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #263041; background: var(--chip); color: #cbd5e1; }
.badge.prio-low { background: #0b1328; color: #93c5fd; border-color:#1d3a5f; }
.badge.prio-medium { background: #0b1328; color: #fde68a; border-color:#7a5a1a; }
.badge.prio-high { background: #1b0f10; color: #fecaca; border-color:#3a1b1b; }
.badge.prio-critical{ background: #3a1021; color: #ffd1dc; border-color:#5b1c33; }
.table-actions { display: inline-flex; gap: 8px; }
.table-actions button { background: #0a1227; border: 1px solid #263041; color: var(--text); padding: 6px 8px; border-radius: 8px; }
.table-actions .danger { border-color: #3a1b1b; background: #1b0f10; color: #fecaca; }
:root{ --op-max: 60vh; }
#opBody > .grid { display: block; }
#opTableWrap { width:100%; overflow:auto; max-height: var(--op-max); }
#opSummaryBar { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #1f2937; background: #0a1227; position:sticky; top:0; z-index:1; }
#opSummaryBar .count { color: var(--muted); font-size:13px; }
.badge.state { background:#0a1227; color:#cbd5e1; border-color:#334155; }
.badge.max { background:#5b1c33; color:#ffd1dc; border-color:#7a2a49; }
.col-id{ display:none; }
th.sortable{ cursor:pointer; user-select:none; }
th.sortable .arrow{ opacity:.7; margin-left:6px; }
/* NEW: one-row layout for Gestisci sezioni */
#sectionsList .list-item{
  display: grid;
  grid-template-columns: minmax(160px, 1.4fr) minmax(200px, 2fr) 110px 140px auto;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
#sectionsList .list-item input,
#sectionsList .list-item select{ width: 100%; }
#sectionsList .list-item .controls{ display:flex; gap:8px; justify-content:flex-end; }
@media (max-width: 720px){
  #sectionsList { overflow-x:auto; }
  #sectionsList .list-item{ min-width: 720px; }
}

/* ===== OP FILTER layout migliorato (v19_7f) ===== */
#opFilterDlg{ max-width: 1100px; width: min(96vw, 1100px); }
.opf-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
.opf-card{ border:1px solid #1f2937; background:#0a1227; border-radius:12px; padding:12px; }
.opf-card h4{ margin:0 0 10px 0; font-size:13px; text-transform:uppercase; letter-spacing:.04em; color:#cbd5e1; }
.opf-checks{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:8px; }
.opf-row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.opf-actions{ display:flex; justify-content:flex-end; gap:10px; }
@media (max-width: 780px){ .opf-grid{ grid-template-columns:1fr; } .opf-row{ grid-template-columns:1fr; } }

/* ===== OP TABLE COLUMN TUNING (v19_7f.1) ===== */
#opTable { table-layout:auto; }
#opTable th.col-created, #opTable td.col-created,
#opTable th.col-due,     #opTable td.col-due{
  width:1%;
  white-space:nowrap;
}
#opTable th.col-title, #opTable td.col-title{ width:auto; }
@media (max-width: 900px){
  #opTable th.col-created, #opTable td.col-created,
  #opTable th.col-due,     #opTable td.col-due{ width:auto; }
}

/* ===== SECTIONS DIALOG WIDER (v19_7f) ===== */
#sectionsDlg{ max-width: 980px; width: min(96vw, 980px); }
#sectionsDlg .content{ overflow:auto; }

</style>
</head>
<body>
<header>
 <div class="wrap">
 <h1><span class="dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--accent);"></span>Team Sistemi Anagrafici</h1>
 <div class="toolbar">
 <input id="q" type="search" placeholder="Cerca per titolo, tag o descrizione‚Ä¶ (‚åò/Ctrl + K)" />
 <button id="filterSectionsBtn" title="Apri menu sezioni">üè† Menu</button>
 <button id="newBtn">‚ûï Nuovo link</button>
 <button id="manageSectionsBtn">üìÇ Gestisci sezioni</button>
 <button id="exportBtn">üíæ Salva link</button>
 <button id="importBtn">üì• Carica link</button>
 <button id="saveToGitHubBtn" title="Committa su GitHub via funzione serverless">‚¨ÜÔ∏è Salva su GitHub</button>
 <button id="clearAllBtn" title="Pulisci tutte le sezioni, link e OP">üßπ Pulisci tutto</button>
 </div>
 </div>
</header>
<main class="wrap">
 <section id="opSection" class="section">
 <div class="section-header" style="background: linear-gradient(90deg, #0b3a68, #0f447a); border-bottom: 1px solid #0f447a80;">
 <div class="section-title">
 <button class="toggle" id="opToggle">‚ñæ</button>
 <span>üìù</span> <span>Open Points</span>
 </div>
 <div class="section-actions">
 <button onclick="openOpDialog()">‚ûï Nuovo</button>
 <button onclick="(window.showSaveFilePicker? saveOPWithPicker() : openSaveOPDialog())">üíæ Salva OP</button>
 <button onclick="importOpenPointsFromFile()">üì• Carica OP</button>
 <button onclick="openOpFilterDialog()">üîé Filtra</button>
 <button onclick="exportOpenPointsToCSV()">üì§ Export CSV</button>
 <button onclick="exportOpenPointsToExcel()">üì§ Export Excel (.xls)</button>
 <button class="danger" onclick="clearOpenPoints()">üßπ Pulisci OP</button>
 </div>
 </div>
 <div id="opBody">
 <div class="grid" style="padding:0">
 <div id="opSummaryBar"><div class="count" id="opCount">0 risultati su 0</div></div>
 <div id="opTableWrap">
 <table class="table" id="opTable"></table>
 </div>
 </div>
 </div>
 </section>
 <div id="container"></div>
</main>
<footer>Suggerimento: premi <span class="kbd">‚åò/Ctrl</span> + <span class="kbd">K</span> per cercare velocemente. Le modifiche sono salvate nel browser (localStorage).</footer>
<dialog id="dialog"><div class="modal">
 <header class="modal-bar"><span class="title" id="dlgTitle">Nuovo link</span><button id="closeXBtn" class="close" aria-label="Chiudi">‚úï</button></header>
 <div class="content">
 <div class="row"><input id="fTitle" placeholder="Titolo" /></div>
 <div class="row"><input id="fUrl" placeholder="URL (https://‚Ä¶)" /></div>
 <div class="row"><textarea id="fDesc" placeholder="Descrizione (opzionale)"></textarea></div>
 <div class="row"><input id="fTags" placeholder="Tag separati da virgola (es. progetto, clienti)" /></div>
 <div class="row"><select id="fSection"></select></div>
 <div class="row" style="justify-content:flex-end"><button id="cancelBtn">Annulla</button><button id="saveBtn" class="primary">Salva</button></div>
 </div>
</div></dialog>
<dialog id="sectionsDlg"><div class="modal">
 <header class="modal-bar"><span class="title">Gestisci sezioni</span><button id="closeSectionsBtn" class="close" aria-label="Chiudi">‚úï</button></header>
 <div class="content">
 <div id="sectionsList" class="list"></div>
 <div class="row">
 <input id="newSectionName" placeholder="Nome nuova sezione" />
 <input id="newSectionDesc" placeholder="Descrizione (opzionale)" />
 <select id="newSectionIcon" class="iconSel">
 <option value="">Icona (auto)</option>
 <option>üìÅ</option><option>üë•</option><option>üß©</option><option>üìÇ</option><option>üìù</option><option>üìå</option><option>üìä</option><option>üìé</option><option>üõ†</option><option>üóÉ</option><option>üìÖ</option><option>üß™</option><option>üí°</option><option>‚úÖ</option><option>‚öô</option>
 </select>
 <select id="newSectionColor"></select>
 <button id="addSectionBtn" class="primary">Aggiungi</button>
 </div>
 </div>
</div></dialog>
<dialog id="filterSectionsDlg"><div class="modal">
 <header class="modal-bar"><span class="title">Filtra sezioni</span><button id="fsCloseBtn" class="close" aria-label="Chiudi">‚úï</button></header>
 <div class="content">
 <div id="filterMenu" class="list menu-grid"></div>
 </div>
</div></dialog>
<dialog id="opDialog"><div class="modal">
 <header class="modal-bar">
 <span class="title" id="opDlgTitle">Nuovo open point</span>
 <button id="opCloseXBtn" class="close" aria-label="Chiudi">‚úï</button>
 </header>
 <div class="content">
 <div class="row"><input id="opTitle" placeholder="Titolo *" /></div>
 <div class="row"><input id="opProject" placeholder="Progetto" /></div>
 <div class="row"><input id="opAssignees" placeholder="Assegnatari (separati da virgola)" /></div>
 <div class="row">
 <select id="opPriority">
 <option value="low">Priorit√†: Bassa</option>
 <option value="medium" selected>Priorit√†: Media</option>
 <option value="high">Priorit√†: Alta</option>
 <option value="critical">Priorit√†: Critica</option>
 </select>
 </div>
 <div class="row">
 <select id="opStatus">
 <option value="Nuovo" selected>Stato: Nuovo</option>
 <option value="Da fare">Stato: Da fare</option>
 <option value="In corso">Stato: In corso</option>
 <option value="Schedulato">Stato: Schedulato</option>
 <option value="Completato">Stato: Completato</option>
 </select>
 <label style="display:inline-flex;align-items:center;gap:8px;margin-left:10px">
 <input type="checkbox" id="opMaxPrio" /> Priorit√† massima
 </label>
 </div>
 <div class="row">
 <input id="opCreatedAt" type="date" placeholder="Data inserimento" />
 <input id="opDueAt" type="date" placeholder="Scadenza" />
 </div>
 <div class="row"><textarea id="opDesc" placeholder="Descrizione"></textarea></div>
 <div class="row"><textarea id="opNotes" placeholder="Note"></textarea></div>
 <div class="row" style="justify-content:flex-end">
 <button id="opCancelBtn">Annulla</button>
 <button id="opSaveBtn" class="primary">Salva</button>
 </div>
 </div>
</div></dialog>
<script>
if(!window.structuredClone){ window.structuredClone = (obj)=> JSON.parse(JSON.stringify(obj)); }
if(!window.crypto){ window.crypto = {}; }
if(!crypto.randomUUID){ crypto.randomUUID = ()=> 'id-' + Math.random().toString(16).slice(2) + '-' + Date.now(); }
function escapeHtml(s){ s=String(s||''); return s.replace(/[&<>"']/g, (m)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function escapeAttr(s){ s=String(s||''); return s.replace(/\"/g,'&quot;'); }
function todayISO(){ try{ return new Date().toISOString().slice(0,10); }catch(_){ return ''; } }
function toast(msg){ var t=document.createElement('div'); t.textContent=msg; t.style.position='fixed'; t.style.bottom='18px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.background='#0b1227'; t.style.border='1px solid #334155'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex=99; t.style.color='#e5e7eb'; document.body.appendChild(t); setTimeout(()=>{ t.remove(); },1600); }
var PALETTE = [
 { id:'emerald', c1:'#064e3b', c2:'#065f46' },
 { id:'blue', c1:'#0b3a68', c2:'#0f447a' },
 { id:'indigo', c1:'#312e81', c2:'#3730a3' },
 { id:'cyan', c1:'#0e3a43', c2:'#0b4a56' },
 { id:'violet', c1:'#4c1d95', c2:'#5b21b6' },
 { id:'amber', c1:'#78350f', c2:'#92400e' },
 { id:'rose', c1:'#7f1d1d', c2:'#991b1b' }
];
var STORAGE_KEY_V2 = 'linkhub.v2';
function save(st){ try{ localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(st || state)); }catch(e){ console.error('save:', e); } }
function loadState(){ try{
 var raw = localStorage.getItem(STORAGE_KEY_V2); if(raw){ return normalizeState(JSON.parse(raw)); }
 var demo={ sections:[
 {id: crypto.randomUUID(), name:'Team', desc:'Contatti, orari, riunioni', icon:'üë•', collapsed:false, color:{id:'emerald', c1:'#064e3b', c2:'#065f46'}},
 {id: crypto.randomUUID(), name:'Progetti', desc:'Piani, task, roadmap', icon:'üß©', collapsed:false, color:{id:'blue', c1:'#0b3a68', c2:'#0f447a'}},
 {id: crypto.randomUUID(), name:'File', desc:'Documenti e cartelle', icon:'üìÅ', collapsed:false, color:{id:'indigo', c1:'#312e81', c2:'#3730a3'}}
 ], links:[], openPoints:[] };
 localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(demo));
 return normalizeState(demo);
}catch(e){ console.error('load:', e); return { sections:[], links:[], openPoints:[] }; } }
function normalizeState(x){
 var sections = Array.isArray(x.sections)? x.sections.map(function(s,i){ return {
 id: s.id || crypto.randomUUID(),
 name: String(s.name||'Senza nome').trim()||'Senza nome',
 collapsed: !!s.collapsed,
 color: (s.color&&s.color.c1&&s.color.c2)? s.color : PALETTE[i%PALETTE.length],
 desc: String(s.desc||'').trim(),
 icon: String(s.icon||'').trim()
 }; }) : [{id: crypto.randomUUID(), name:'Generale', collapsed:false, color:PALETTE[0], desc:'', icon:'üìÅ'}];
 var ids = new Set(sections.map(function(s){return s.id;}));
 var fallback = sections[0]? sections[0].id : '';
 var links = Array.isArray(x.links)? x.links.map(function(l){ return {
 id: l.id || crypto.randomUUID(),
 title: String(l.title||'').trim(),
 url: String(l.url||'').trim(),
 desc: String(l.desc||'').trim(),
 tags: (l.tags||[]).map(function(t){return String(t).trim();}).filter(Boolean),
 sectionId: ids.has(l.sectionId)? l.sectionId : fallback
 }; }) : [];
 function nOP(o){ var a=(o.assignees||o.assegnatari||''); var arr=Array.isArray(a)? a : String(a).split(',').map(function(s){return s.trim();}).filter(Boolean); return {
 id: o.id || crypto.randomUUID(),
 title: String(o.title||o.titolo||'').trim(),
 project: String(o.project||o.progetto||'').trim(),
 assignees: arr,
 priority: (o.priority||o.priorita||o['priorit√†']||'medium').toLowerCase(),
 status: String(o.status||o.stato||'Nuovo').trim(),
 maxPriority: !!(o.maxPriority||o.max||o['priorit√†Massima']),
 createdAt: String(o.createdAt||o.dataInserimento||'').trim(),
 dueAt: String(o.dueAt||o.dataScadenza||'').trim(),
 desc: String(o.desc||o.descrizione||'').trim(),
 notes: String(o.notes||o.note||'').trim()
 }; }
 var openPoints = Array.isArray(x.openPoints)? x.openPoints.map(nOP) : [];
 return { sections:sections, links:links, openPoints:openPoints };
}
var state=null;
window.addEventListener('DOMContentLoaded', initApp);
function initApp(){
 state = loadState();
 render();
 renderOpenPoints();
 updateFilterSectionsBtn();
 tryAutoLoadOnStartup();
 var q=document.getElementById('q'); if(q) q.addEventListener('input', render);
 window.addEventListener('keydown', function(e){ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); if(q) q.focus(); } });
 document.getElementById('exportBtn').onclick = function(){ if(window.showSaveFilePicker) saveLinksWithPicker(); else openSaveLinksDialog(); }; // changed: open dialog
 document.getElementById('importBtn').onclick = importFullJSON;
 document.getElementById('clearAllBtn').onclick = clearAll;
 document.getElementById('filterSectionsBtn').onclick = openFilterSectionsDialog;
 document.getElementById('newBtn').onclick = function(){ openDialog(); };
 document.getElementById('manageSectionsBtn').onclick = function(){ try{ renderSectionsList(); sectionsDlg.showModal(); setTimeout(function(){ var el=document.getElementById('newSectionName'); if(el) el.focus(); }, 50); }catch(e){ alert('Apri il file nel browser per usare questo dialog.'); } };
 var opToggle=document.getElementById('opToggle'), opBody=document.getElementById('opBody');
 if(opToggle && opBody){ opToggle.addEventListener('click', function(){ if(opBody.classList.contains('hidden')){ opBody.classList.remove('hidden'); opToggle.textContent='‚ñæ'; } else { opBody.classList.add('hidden'); opToggle.textContent='‚ñ∏'; } }); }
 document.getElementById('cancelBtn').onclick = function(){ dialog.close(); };
 document.getElementById('saveBtn').onclick = saveDialog;
 document.getElementById('closeXBtn').onclick = function(){ dialog.close(); };
 document.getElementById('closeSectionsBtn').onclick = function(){ sectionsDlg.close(); };
 document.getElementById('addSectionBtn').onclick = addSection;
 fillColorsSelect();
 document.getElementById('opCancelBtn').onclick = function(){ opDialog.close(); };
 document.getElementById('opSaveBtn').onclick = saveOpDialog;
 document.getElementById('opCloseXBtn').onclick = function(){ opDialog.close(); };
}
async function exportFullJSON(fileName){ const data = JSON.stringify(state, null, 2); const blob = new Blob([data], {type:'application/json'});
 const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download= (String(fileName||'').trim() || 'linkhub-links.json'); document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();}, 400); toast('Download avviato'); }
function openSaveLinksDialog(){
  try {
    var fn = 'linkhub-links.json';
    var dlg = document.getElementById('saveLinksDlg');
    var inp = document.getElementById('saveLinksFileName');
    var closeX = document.getElementById('saveLinksCloseBtn');
    var cancel = document.getElementById('saveLinksCancelBtn');
    var ok = document.getElementById('saveLinksOkBtn');
    inp.value = fn;
    dlg.showModal();
    closeX.onclick = function(){ dlg.close(); };
    cancel.onclick = function(){ dlg.close(); };
    ok.onclick = function(){ var chosen = String(inp.value||'').trim() || fn; exportFullJSON(chosen); dlg.close(); };
  } catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }
}
async function importFullJSON(){ try{ var inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=async function(){ var f=inp.files[0]; if(!f) return; var text=await f.text(); try{ var json=JSON.parse(text); var imported=normalizeState(json); state=imported; save(); render(); renderOpenPoints(); updateFilterSectionsBtn();
 tryAutoLoadOnStartup(); toast('Caricato da file'); }catch(err){ alert('Errore import: '+err.message); } }; inp.click(); }catch(e){ alert('Caricamento non riuscito: '+e.message); } }
var sectionsDlg=document.getElementById('sectionsDlg');
var sectionsList=document.getElementById('sectionsList');
var newSectionColor=document.getElementById('newSectionColor');
function fillColorsSelect(){ newSectionColor.innerHTML = '<option value="">Colore (auto)</option>'+PALETTE.map(function(p){return '<option value="'+p.id+'">'+p.id.toUpperCase()+'</option>';}).join(''); }
function headerStyle(sec){ var c1=(sec.color&&sec.color.c1)||'#0b1328', c2=(sec.color&&sec.color.c2)||'#0b1328'; return 'background: linear-gradient(90deg, '+c1+', '+c2+'); border-bottom: 1px solid '+c2+'80'; }
function render(){ var container=document.getElementById('container'); var term=(document.getElementById('q').value||'').trim().toLowerCase(); var vis=getVisibleSectionsSet();
 var groups = state.sections.map(function(sec){ return { sec:sec, items: state.links.filter(function(it){ var inTerm= !term || [it.title,it.desc,(it.tags||[]).join(' ')].join(' ').toLowerCase().includes(term); var inSec = !vis || vis.has(it.sectionId); return inTerm && inSec && it.sectionId===sec.id; }) }; });
 var anyItem = groups.some(function(g){return g.items.length;});
 if(!anyItem){ container.innerHTML='<div class="empty">Nessun link trovato.</div>'; return; }
 container.innerHTML = groups.map(function(g){ if(g.items.length===0) return ''; var icon=g.sec.collapsed?'‚ñ∏':'‚ñæ'; var grid = g.sec.collapsed? '' : '<div class="grid">'+g.items.map(cardTemplate).join('')+'</div>'; return (
'<section class="section" data-sec="'+g.sec.id+'">\n'
+' <div class="section-header" style="'+headerStyle(g.sec)+'">\n'
+' <div class="section-title">\n'
+' <button class="toggle" onclick="toggleSection(\''+g.sec.id+'\')">'+icon+'</button>\n'
+' <span>'+(g.sec.icon && String(g.sec.icon).trim()?String(g.sec.icon).trim():'üìÅ')+'</span> <span>'+escapeHtml(g.sec.name)+'</span>\n'
+' </div>\n'
+' <div class="section-actions">\n'
+' <button onclick="openDialog(undefined,\''+g.sec.id+'\')">‚ûï Link</button>\n'
+' </div>\n'
+' </div>\n'
+ grid + '\n'
+'</section>'
 ); }).join('');
 setupDragAndDrop();
}
function cardTemplate(item){ return (
'<div class="card" data-id="'+item.id+'">\n'
+' <div class="card-head">\n'
+' <h3>üîó <a href="'+escapeAttr(item.url)+'" target="_blank" rel="noopener noreferrer">'+escapeHtml(item.title)+'</a></h3>\n'
+' <button class="drag-handle" draggable="true" title="Trascina" aria-label="Trascina" data-id="'+item.id+'">‚ãÆ‚ãÆ</button>\n'
+' </div>\n'
+ (item.desc?'<p>'+escapeHtml(item.desc)+'</p>':'')
+' <div class="actions">\n'
+' <button title="Modifica" aria-label="Modifica" onclick="editItem(\''+item.id+'\')">‚úèÔ∏è</button>\n'
+' <button class="danger" title="Elimina" aria-label="Elimina" onclick="removeItem(\''+item.id+'\')">üóëÔ∏è</button>\n'
+' </div>\n'
+'</div>'
 ); }
function openDialog(item, defaultSectionId){ try{ dlgTitle.textContent = item? 'Modifica link' : 'Nuovo link'; fSection.innerHTML = state.sections.map(function(s){ return '<option value="'+s.id+'">'+escapeHtml(s.name)+'</option>'; }).join(''); var secId=(item&&item.sectionId)||defaultSectionId||(state.sections[0]?state.sections[0].id:''); fSection.value=secId; dialog.showModal(); fTitle.value=(item&&item.title)||''; fUrl.value=(item&&item.url)||''; fDesc.value=(item&&item.desc)||''; fTags.value=((item&&item.tags)||[]).join(', '); dialog.dataset.editing=item?item.id:''; setTimeout(function(){ fTitle.focus(); },50); }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }}
window.openDialog = openDialog;
function normalizeLink(x){ return { id: x.id || crypto.randomUUID(), title:(x.title||'').trim(), url:(x.url||'').trim(), desc:(x.desc||'').trim(), tags:(x.tags||[]).map(function(t){return String(t).trim();}).filter(Boolean), sectionId:x.sectionId }; }
function saveDialog(){ var obj=normalizeLink({title:fTitle.value,url:fUrl.value,desc:fDesc.value,tags:fTags.value.split(','), sectionId:fSection.value}); if(!obj.title||!obj.url){ alert('Titolo e URL sono obbligatori'); return; } if(!obj.sectionId){ alert('Seleziona una sezione'); return; } var id=dialog.dataset.editing; if(id){ var i=state.links.findIndex(function(l){return l.id===id;}); if(i>=0) state.links[i]=Object.assign({}, obj, {id:id}); } else { state.links.unshift(obj); } dialog.close(); refreshAll(); }
window.copyUrl = async function(url){ try{ await navigator.clipboard.writeText(url); toast('URL copiato'); }catch(e){ alert('Copia non riuscita'); } };
window.removeItem = function(id){ if(!confirm('Eliminare questo link?')) return; state.links = state.links.filter(function(l){return l.id!==id;}); refreshAll(); };
window.editItem = function(id){ var item=state.links.find(function(l){return l.id===id;}); openDialog(item, item&&item.sectionId); };
window.toggleSection = function(id){ var s=state.sections.find(function(x){return x.id===id;}); if(s){ s.collapsed=!s.collapsed; refreshAll(); } };
function addSection(){ var name=(document.getElementById('newSectionName').value||'').trim(); if(!name) return; var desc=(document.getElementById('newSectionDesc').value||'').trim(); var icon=(document.getElementById('newSectionIcon').value||'').trim(); var colorChoice=newSectionColor.value; var paletteItem = colorChoice? PALETTE.find(function(p){return p.id===colorChoice;}) : PALETTE[state.sections.length % PALETTE.length]; state.sections.push({id:crypto.randomUUID(), name:name, desc:desc, icon:icon, collapsed:false, color:paletteItem}); document.getElementById('newSectionName').value=''; document.getElementById('newSectionDesc').value=''; document.getElementById('newSectionIcon').value=''; newSectionColor.value=''; renderSectionsList(); refreshAll(); }
function renderSectionsList(){ sectionsList.innerHTML = state.sections.map(function(s){ return (
'<div class="list-item" data-id="'+s.id+'">\n'
+' <input value="'+escapeAttr(s.name)+'" oninput="renameSection(\''+s.id+'\', this.value)" placeholder="Nome"/>\n'
+' <input value="'+escapeAttr(s.desc||'')+'" oninput="redescSection(\''+s.id+'\', this.value)" placeholder="Descrizione (opzionale)"/>\n'
+' <select class="iconSel" onchange="reiconSection(\''+s.id+'\', this.value)">'+["üìÅ","üë•","üß©","üìÇ","üìù","üìå","üìä","üìé","üõ†","üóÉ","üìÖ","üß™","üí°","‚úÖ","‚öô"].map(function(e){return '<option '+(s.icon===e?'selected':'')+'>'+e+'</option>';}).join('')+'</select>\n'
+' <select onchange="recolorSection(\''+s.id+'\', this.value)">'+PALETTE.map(function(p){ return '<option value="'+p.id+'" '+(((s.color&&s.color.id)===p.id)?'selected':'')+'>'+p.id.toUpperCase()+'</option>'; }).join('')+'</select>\n'
+' <div class="controls">\n'
+' <button onclick="moveSection(\''+s.id+'\', -1)">‚¨ÜÔ∏è</button>\n'
+' <button onclick="moveSection(\''+s.id+'\', 1)">‚¨áÔ∏è</button>\n'
+' <button class="danger" onclick="deleteSection(\''+s.id+'\')">üóëÔ∏è</button>\n'
+' </div>\n'
+'</div>'
 ); }).join(''); }
window.recolorSection=function(id,pid){ var s=state.sections.find(function(x){return x.id===id;}); var p=PALETTE.find(function(x){return x.id===pid;}); if(!s||!p) return; s.color=p; refreshAll(); };
window.redescSection=function(id,val){ var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; s.desc=String(val||'').trim(); save(); updateFilterSectionsBtn();
 tryAutoLoadOnStartup(); };
window.reiconSection=function(id,val){ var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; s.icon=String(val||'').trim(); refreshAll(); };
window.renameSection=function(id,val){ var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; s.name=String(val||'').trim()||'Senza nome'; save(); updateFilterSectionsBtn();
 tryAutoLoadOnStartup(); };
window.moveSection=function(id,delta){ var i=state.sections.findIndex(function(x){return x.id===id;}); if(i<0) return; var j=i+delta; if(j<0||j>=state.sections.length) return; var tmp=state.sections[i]; state.sections[i]=state.sections[j]; state.sections[j]=tmp; renderSectionsList(); refreshAll(); };
window.deleteSection=function(id){ if(state.sections.length===1){ alert('Deve esistere almeno una sezione.'); return; } var s=state.sections.find(function(x){return x.id===id;}); if(!s) return; if(!confirm('Eliminare la sezione "'+s.name+'"? I link saranno spostati nella prima sezione.')) return; var target=state.sections.find(function(x){return x.id!==id;}); state.links = state.links.map(function(l){ return l.sectionId===id ? Object.assign({}, l, {sectionId: target.id}) : l; }); state.sections = state.sections.filter(function(x){return x.id!==id;}); renderSectionsList(); refreshAll(); };
function refreshAll(){ save(); render(); renderOpenPoints(); updateFilterSectionsBtn();
 tryAutoLoadOnStartup(); }
function clearAll(){ if(!confirm('Confermi? Saranno eliminati TUTTI i link, TUTTE le sezioni e TUTTI gli Open Points. Operazione irreversibile.')) return; var base={ id:crypto.randomUUID(), name:'Generale', desc:'', icon:'üìÅ', collapsed:false, color:PALETTE[0] }; state={ sections:[base], links:[], openPoints:[] }; try{ localStorage.removeItem('linkhub.secFilter.v1'); }catch(_){ } save(); render(); renderOpenPoints(); updateFilterSectionsBtn();
 tryAutoLoadOnStartup(); toast('Ripulito'); }
var SEC_FILTER_KEY='linkhub.secFilter.v1';
function getVisibleSectionsSet(){ try{ var raw=localStorage.getItem(SEC_FILTER_KEY); if(!raw) return null; var arr=JSON.parse(raw); if(!Array.isArray(arr)||arr.length===0) return null; return new Set(arr); }catch(e){ return null; } }
function setVisibleSections(ids){ try{ if(!ids || ids.length===0 || ids.length===state.sections.length){ localStorage.removeItem(SEC_FILTER_KEY); } else { localStorage.setItem(SEC_FILTER_KEY, JSON.stringify(ids)); } }catch(e){} }
function updateFilterSectionsBtn(){ var btn=document.getElementById('filterSectionsBtn'); if(!btn) return; btn.textContent='üè† Menu'; try{ var vis=getVisibleSectionsSet(); var total= state && state.sections ? state.sections.length : 0; var all=(!vis || (vis && vis.size===total)); var label = all ? 'Tutte ('+total+')' : ('Filtrate: '+vis.size+'/'+total); btn.title='Selezione sezioni: '+label; }catch(e){} }
function openFilterSectionsDialog(){ try{ var dlg=document.getElementById('filterSectionsDlg'); var menu=document.getElementById('filterMenu'); var items=[]; items.push('<button class="menu-btn" data-id="ALL"><div class="label"><span class="ico">üè†</span><div class="text"><div class="name">Tutte</div><div class="desc">Mostra tutte le sezioni</div></div></div></button>'); items.push('<button class="menu-btn" data-id="SOLO_OP"><div class="label"><span class="ico">üìù</span><div class="text"><div class="name">Solo Open Points</div><div class="desc">Nasconde tutte le sezioni link</div></div></div></button>'); Array.prototype.push.apply(items, state.sections.map(function(s){ var icon=(s.icon&&String(s.icon).trim())? String(s.icon).trim() : 'üìÅ'; var desc=(s.desc&&String(s.desc).trim())? ('<div class="desc">'+escapeHtml(String(s.desc).trim())+'</div>') : ''; return '<button class="menu-btn" data-id="'+s.id+'"><div class="label"><span class="ico">'+escapeHtml(icon)+'</span><div class="text"><div class="name">'+escapeHtml(s.name)+'</div>'+desc+'</div></div></button>'; })); menu.innerHTML = items.join(''); Array.prototype.forEach.call(menu.querySelectorAll('button.menu-btn'), function(btn){ btn.onclick=function(){ var id=btn.getAttribute('data-id'); if(id==='ALL') setVisibleSections(null); else if(id==='SOLO_OP') setVisibleSections(['__NONE__']); else setVisibleSections([id]); render(); updateFilterSectionsBtn();
 tryAutoLoadOnStartup(); dlg.close(); }; }); var fsClose=document.getElementById('fsCloseBtn'); if(fsClose) fsClose.onclick=function(){ dlg.close(); }; dlg.showModal(); }catch(e){ alert('Apri il file nel browser per usare questo dialog.'); } }
window.openFilterSectionsDialog = openFilterSectionsDialog;
var dragState={id:null}; var caretEl=null; var rafId=0;
function setupDragAndDrop(){ Array.prototype.forEach.call(document.querySelectorAll('.drag-handle'), function(h){ h.addEventListener('dragstart', onHandleDragStart); h.addEventListener('dragend', onHandleDragEnd); }); Array.prototype.forEach.call(document.querySelectorAll('.card'), function(card){ card.addEventListener('dragover', onCardDragOver); card.addEventListener('dragleave', onCardDragLeave); card.addEventListener('drop', onCardDrop); }); Array.prototype.forEach.call(document.querySelectorAll('.section'), function(sectionEl){ sectionEl.addEventListener('dragover', onSectionDragOver); sectionEl.addEventListener('dragleave', onSectionDragLeave); sectionEl.addEventListener('drop', onSectionDrop); }); }
function onHandleDragStart(e){ var handle=e.currentTarget; var card=handle.closest('.card'); dragState.id=(card&&card.dataset.id)||handle.dataset.id; if(card) card.classList.add('dragging'); try{ e.dataTransfer.setData('text/plain', dragState.id); }catch(_){ } if(e.dataTransfer) e.dataTransfer.effectAllowed='move'; }
function onHandleDragEnd(e){ var card=e.currentTarget.closest('.card'); if(card) card.classList.remove('dragging'); hideCaret(); dragState.id=null; }
function onCardDragOver(e){ if(!dragState.id) return; e.preventDefault(); e.stopPropagation(); var card=e.currentTarget; placeCaret(card, e.clientX); }
function onCardDragLeave(e){ if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(function(){}); }
function onCardDrop(e){ if(!dragState.id) return; e.preventDefault(); e.stopPropagation(); var card=e.currentTarget; var targetId=card.dataset.id; var rect=card.getBoundingClientRect(); var before = e.clientX < (rect.left + rect.width/2); hideCaret(); if(!targetId || dragState.id===targetId) return; moveRelative(dragState.id, targetId, before? 'before':'after'); refreshAll(); }
function onSectionDragOver(e){ if(!dragState.id) return; e.preventDefault(); var sectionEl=e.currentTarget; sectionEl.classList.add('drop-target'); var grid=sectionEl.querySelector('.grid'); if(grid){ var last=grid.querySelector('.card:last-of-type'); if(last){ var rect=last.getBoundingClientRect(); showCaretAt(grid, rect.right, rect.top, rect.height); } else { var grect=grid.getBoundingClientRect(); showCaretAt(grid, grect.left + 8, grect.top, Math.max(48, grect.height)); } } }
function onSectionDragLeave(e){ e.currentTarget.classList.remove('drop-target'); }
function onSectionDrop(e){ if(!dragState.id) return; e.preventDefault(); var sectionEl=e.currentTarget; sectionEl.classList.remove('drop-target'); var secId=sectionEl.getAttribute('data-sec'); hideCaret(); if(secId){ moveToSectionEnd(dragState.id, secId); refreshAll(); } }
function ensureCaret(grid){ if(!caretEl){ caretEl=document.createElement('div'); caretEl.className='insert-caret'; } if(caretEl.parentElement!==grid){ grid.appendChild(caretEl); } }
function placeCaret(card, clientX){ var grid=card.parentElement; if(!grid) return; var rect=card.getBoundingClientRect(); var before = clientX < (rect.left + rect.width/2); var top=rect.top; var height=rect.height; var left = before ? rect.left : rect.right; showCaretAt(grid, left, top, height); }
function showCaretAt(grid, absLeft, absTop, height){ var grect=grid.getBoundingClientRect(); ensureCaret(grid); caretEl.style.left=(absLeft - grect.left - 1)+'px'; caretEl.style.top=(absTop - grect.top)+'px'; caretEl.style.height=Math.max(24,height)+'px'; caretEl.style.display='block'; }
function hideCaret(){ if(caretEl){ caretEl.style.display='none'; } }
function moveRelative(dragId, targetId, where){ var di=state.links.findIndex(function(l){return l.id===dragId;}); var ti=state.links.findIndex(function(l){return l.id===targetId;}); if(di<0||ti<0) return; var dragged=state.links[di]; var target=state.links[ti]; if(dragged.sectionId!==target.sectionId){ dragged.sectionId=target.sectionId; } state.links.splice(di,1); var insertAt; if(where==='after') insertAt = (di < ti) ? ti : ti+1; else insertAt = (di < ti) ? ti-1 : ti; insertAt = Math.max(0, Math.min(insertAt, state.links.length)); state.links.splice(insertAt,0,dragged); save(); }
function moveToSectionEnd(dragId, sectionId){ var di=state.links.findIndex(function(l){return l.id===dragId;}); if(di<0) return; var dragged=state.links[di]; dragged.sectionId=sectionId; state.links.splice(di,1); var last=-1; for(var i=0;i<state.links.length;i++){ if(state.links[i].sectionId===sectionId) last=i; } var insertAt = last===-1? state.links.length : last+1; state.links.splice(insertAt,0,dragged); save(); }
var opDialog=document.getElementById('opDialog');
var opTitle=document.getElementById('opTitle');
var opProject=document.getElementById('opProject');
var opAssignees=document.getElementById('opAssignees');
var opPriority=document.getElementById('opPriority');
var opStatus=document.getElementById('opStatus');
var opMaxPrio=document.getElementById('opMaxPrio');
var opCreatedAt=document.getElementById('opCreatedAt');
var opDueAt=document.getElementById('opDueAt');
var opDesc=document.getElementById('opDesc');
var opNotes=document.getElementById('opNotes');
function openOpDialog(item){ try{ document.getElementById('opDlgTitle').textContent=item?'Modifica open point':'Nuovo open point'; opTitle.value=(item&&item.title)||''; opProject.value=(item&&item.project)||''; opAssignees.value=(item&&Array.isArray(item.assignees)?item.assignees.join(', '):(item&&item.assignees)||''); opPriority.value=(item&&item.priority)||'medium'; opStatus.value=(item&&item.status)||'Nuovo'; opMaxPrio.checked=!!(item&&item.maxPriority); opCreatedAt.value=(item&&item.createdAt)||todayISO(); opDueAt.value=(item&&item.dueAt)||''; opDesc.value=(item&&item.desc)||''; opNotes.value=(item&&item.notes)||''; opDialog.dataset.editing=item?item.id:''; opDialog.showModal(); setTimeout(function(){opTitle.focus();},50); }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }}
function normalizeOPInput(){ var ass=String(opAssignees.value||'').split(',').map(function(s){return s.trim();}).filter(Boolean); return { id:crypto.randomUUID(), title:String(opTitle.value||'').trim(), project:String(opProject.value||'').trim(), assignees:ass, priority:String(opPriority.value||'medium').toLowerCase(), status:String(opStatus.value||'Nuovo'), maxPriority:!!opMaxPrio.checked, createdAt:String(opCreatedAt.value||'').trim(), dueAt:String(opDueAt.value||'').trim(), desc:String(opDesc.value||'').trim(), notes:String(opNotes.value||'').trim() }; }
function saveOpDialog(){ var obj=normalizeOPInput(); if(!obj.title){ alert('Il Titolo √® obbligatorio'); return; } if(!obj.createdAt) obj.createdAt=todayISO(); var id=opDialog.dataset.editing; if(id){ var i=state.openPoints.findIndex(function(o){return o.id===id;}); if(i>=0) state.openPoints[i]=Object.assign({}, obj, {id:id}); } else { state.openPoints.unshift(obj); } opDialog.close(); refreshAll(); }
window.editOpenPoint = function(id){ var item=state.openPoints.find(function(o){return o.id===id;}); if(item) openOpDialog(item); };
window.deleteOpenPoint = function(id){ if(!confirm('Eliminare questo open point?')) return; state.openPoints = state.openPoints.filter(function(o){return o.id!==id;}); refreshAll(); };
function clearOpenPoints(){ if(!confirm('Confermi? Saranno eliminati TUTTI gli Open Points. Operazione irreversibile.')) return; state.openPoints=[]; refreshAll(); }
var OPF_KEY='openpoints.filter.v1';
function defaultOpFilter(){ return { text:'', priorities:['medium','high','critical','low'], statuses:['Nuovo','Da fare','In corso','Schedulato','Completato'], maxOnly:false, createdFrom:'', createdTo:'', dueFrom:'', dueTo:'', assignees:[], projects:[] }; }
function loadOpFilter(){ try{ var raw=localStorage.getItem(OPF_KEY); if(!raw) return defaultOpFilter(); var f=JSON.parse(raw); return Object.assign(defaultOpFilter(), f); }catch(e){ return defaultOpFilter(); } }
function saveOpFilter(f){ try{ localStorage.setItem(OPF_KEY, JSON.stringify(f || defaultOpFilter())); }catch(e){} }
var opFilter=loadOpFilter();
function openOpFilterDialog(){ try{ var dlg=document.getElementById('opFilterDlg'); if(!dlg) return alert('Dialog non disponibile'); document.getElementById('opfText').value=opFilter.text||'';
 // set checkboxes (priorit√†)
 Array.prototype.forEach.call(document.querySelectorAll('#opfPrioGroup input[type=checkbox]'), function(cb){ cb.checked = (opFilter.priorities||[]).indexOf(cb.value) >= 0; });
 // set checkboxes (stato)
 Array.prototype.forEach.call(document.querySelectorAll('#opfStatusGroup input[type=checkbox]'), function(cb){ cb.checked = (opFilter.statuses||[]).indexOf(cb.value) >= 0; });
 document.getElementById('opfMaxOnly').checked=!!opFilter.maxOnly; document.getElementById('opfCreatedFrom').value=opFilter.createdFrom||''; document.getElementById('opfCreatedTo').value=opFilter.createdTo||''; document.getElementById('opfDueFrom').value=opFilter.dueFrom||''; document.getElementById('opfDueTo').value=opFilter.dueTo||''; document.getElementById('opfAssignees').value=(opFilter.assignees||[]).join(', '); document.getElementById('opfProjects').value=(opFilter.projects||[]).join(', ');
 document.getElementById('opFilterCloseXBtn').onclick=function(){ dlg.close(); }; document.getElementById('opfResetBtn').onclick=function(){ opFilter=defaultOpFilter(); saveOpFilter(opFilter); renderOpenPoints(); dlg.close(); }; document.getElementById('opfApplyBtn').onclick=function(){ function getChecked(containerId){ var box=document.getElementById(containerId); return Array.prototype.filter.call(box.querySelectorAll('input[type=checkbox]'), function(o){return o.checked;}).map(function(o){return o.value;}); }
 opFilter={ text:String(document.getElementById('opfText').value||'').trim().toLowerCase(), priorities:getChecked('opfPrioGroup'), statuses:getChecked('opfStatusGroup'), maxOnly:!!document.getElementById('opfMaxOnly').checked, createdFrom:String(document.getElementById('opfCreatedFrom').value||'').trim(), createdTo:String(document.getElementById('opfCreatedTo').value||'').trim(), dueFrom:String(document.getElementById('opfDueFrom').value||'').trim(), dueTo:String(document.getElementById('opfDueTo').value||'').trim(), assignees:String(document.getElementById('opfAssignees').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean), projects:String(document.getElementById('opfProjects').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean) }; saveOpFilter(opFilter); renderOpenPoints(); dlg.close(); }; dlg.showModal(); }catch(e){ alert('Apri il file nel browser per usare il filtro OP.'); } }
function inDateRange(val, from, to){ if(!val) return true; try{ var v=new Date(val).toISOString().slice(0,10); if(from && v<from) return false; if(to && v>to) return false; return true; }catch(e){ return true; } }
function applyOpFilters(rows){ var f=opFilter||defaultOpFilter(); return rows.filter(function(o){ var text=(f.text||''); if(text){ var bag=[o.title||'', o.project||'', o.desc||'', o.notes||'', Array.isArray(o.assignees)? o.assignees.join(' '): (o.assignees||'')].join(' ').toLowerCase(); if(bag.indexOf(text)===-1) return false; } var pr=(o.priority||'medium').toLowerCase(); if(Array.isArray(f.priorities)&&f.priorities.length&&f.priorities.indexOf(pr)===-1) return false; var st=(o.status||'Nuovo'); if(Array.isArray(f.statuses)&&f.statuses.length&&f.statuses.indexOf(st)===-1) return false; if(!!f.maxOnly && !o.maxPriority) return false; if(!inDateRange(o.createdAt||'', f.createdFrom||'', f.createdTo||'')) return false; if(!inDateRange(o.dueAt||'', f.dueFrom||'', f.dueTo||'')) return false; if(Array.isArray(f.assignees)&&f.assignees.length){ var a = Array.isArray(o.assignees)? o.assignees.map(function(x){return String(x).toLowerCase();}) : String(o.assignees||'').toLowerCase(); var ok=false; f.assignees.forEach(function(x){ var k=String(x).toLowerCase(); if(Array.isArray(a)){ if(a.indexOf(k)>=0) ok=true; } else { if(a.indexOf(k)>=0) ok=true; } }); if(!ok) return false; } if(Array.isArray(f.projects)&&f.projects.length){ var p=String(o.project||'').toLowerCase(); var okp=false; f.projects.forEach(function(x){ var k=String(x).toLowerCase(); if(k && p.indexOf(k)>=0) okp=true; }); if(!okp) return false; } return true; }); }
var opSort={ key:'createdAt', dir:'desc' };
var PRIO_ORDER={low:1, medium:2, high:3, critical:4};
var STATUS_ORDER={'Nuovo':1, 'Da fare':2, 'In corso':3, 'Schedulato':4, 'Completato':5};
function cmp(a,b){ return a<b? -1 : a>b? 1 : 0; }
function cmpDate(a,b){ try{ a=a? new Date(a).toISOString().slice(0,10):''; b=b? new Date(b).toISOString().slice(0,10):''; }catch(_){ } return cmp(a,b); }
function sortRows(rows){ var k=opSort.key, d=(opSort.dir==='desc'?-1:1); return rows.slice().sort(function(x,y){ var r=0; if(k==='title'||k==='project') r=cmp(String(x[k]||'').toLowerCase(), String(y[k]||'').toLowerCase()); else if(k==='assignees'){ r=cmp(String((Array.isArray(x.assignees)?x.assignees.join(', '):x.assignees)||'').toLowerCase(), String((Array.isArray(y.assignees)?y.assignees.join(', '):y.assignees)||'').toLowerCase()); } else if(k==='priority'){ r=cmp(PRIO_ORDER[(x.priority||'medium')], PRIO_ORDER[(y.priority||'medium')]); } else if(k==='status'){ r=cmp(STATUS_ORDER[(x.status||'Nuovo')], STATUS_ORDER[(y.status||'Nuovo')]); } else if(k==='maxPriority'){ r=cmp(!!x.maxPriority, !!y.maxPriority); } else if(k==='createdAt'||k==='dueAt'){ r=cmpDate(x[k]||'', y[k]||''); } else if(k==='id'){ r=cmp(String(x.id||''), String(y.id||'')); } return r*d; }); }
function setOpSort(key){ if(opSort.key===key){ opSort.dir=(opSort.dir==='asc'?'desc':'asc'); } else { opSort.key=key; opSort.dir=(key==='createdAt'||key==='dueAt')?'desc':'asc'; } renderOpenPoints(); }
function sortArrowFor(key){ if(opSort.key!==key) return ''; return ' <span class="arrow">'+(opSort.dir==='asc'?'‚Üë':'‚Üì')+'</span>'; }
function renderOpenPoints(){ var tbl=document.getElementById('opTable'); if(!tbl) return; var all=state.openPoints||[]; var filtered=applyOpFilters(all); var rows=sortRows(filtered); document.getElementById('opCount').textContent = rows.length + ' risultati su ' + all.length; var thead = '<thead><tr>'
 + '<th class="col-id sortable" onclick="setOpSort(\'id\')">ID'+sortArrowFor('id')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'title\')">Titolo'+sortArrowFor('title')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'project\')">Progetto'+sortArrowFor('project')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'assignees\')">Assegnatari'+sortArrowFor('assignees')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'priority\')">Priorit√†'+sortArrowFor('priority')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'status\')">Stato'+sortArrowFor('status')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'maxPriority\')">Max'+sortArrowFor('maxPriority')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'createdAt\')">Inserito il'+sortArrowFor('createdAt')+'</th>'
 + '<th class="sortable" onclick="setOpSort(\'dueAt\')">Scadenza'+sortArrowFor('dueAt')+'</th>'
 + '<th>Azioni</th>'
 + '</tr></thead>';
 if(rows.length===0){ tbl.innerHTML = thead + '<tbody><tr><td colspan="10"><div class="empty">Nessun open point</div></td></tr></tbody>'; return; }
 var tbody = '<tbody>' + rows.map(function(o){ var prioCls='prio-'+(o.priority||'medium'); var assTxt=Array.isArray(o.assignees)? o.assignees.join(', ') : (o.assignees||''); return '<tr>'
 + '<td class="col-id">'+escapeHtml(o.id)+'</td>'
 + '<td class="col-title"><strong>'+escapeHtml(o.title)+'</strong>' + (o.desc? '<br><span style="color:var(--muted)">'+escapeHtml(o.desc)+'</span>':'' ) + (o.notes? '<br><span style="color:var(--muted)"><em>Note:</em> '+escapeHtml(o.notes)+'</span>':'' ) + '</td>'
 + '<td>'+escapeHtml(o.project||'')+'</td>'
 + '<td>'+escapeHtml(assTxt)+'</td>'
 + '<td><span class="badge '+prioCls+'">'+escapeHtml((o.priority||'medium').toUpperCase())+'</span></td>'
 + '<td><span class="badge state">'+escapeHtml(o.status||'Nuovo')+'</span></td>'
 + '<td>'+(o.maxPriority? '<span class="badge max">MAX</span>' : '')+'</td>'
 + '<td class="col-created">'+escapeHtml(o.createdAt||'')+'</td>'
 + '<td class="col-due">'+escapeHtml(o.dueAt||'')+'</td>'
 + '<td><div class="table-actions">'
 + '<button title="Modifica" onclick="editOpenPoint(\''+o.id+'\')">‚úèÔ∏è</button>'
 + '<button class="danger" title="Elimina" onclick="deleteOpenPoint(\''+o.id+'\')">üóëÔ∏è</button>'
 + '</div></td>'
 + '</tr>'; }).join('') + '</tbody>';
 tbl.innerHTML = thead + tbody;
}
async function exportOpenPointsToFile(fileName){ try{ var data=JSON.stringify({openPoints: state.openPoints||[]}, null, 2); var blob=new Blob([data], {type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=String(fileName||'open-points.json'); document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},400); toast('Download OP avviato'); }catch(e){ alert('Salvataggio OP non riuscito: '+(e&&e.message?e.message:e)); } }
async function importOpenPointsFromFile(){ try{ var inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=async function(){ var f=inp.files[0]; if(!f) return; var text=await f.text(); try{ var json=JSON.parse(text); var arr=Array.isArray(json)? json : (Array.isArray(json.openPoints)? json.openPoints : null); if(!arr){ alert('JSON non valido: atteso array o { openPoints: [...] }'); return; } state.openPoints = arr.map(function(o){ return { id:o.id||crypto.randomUUID(), title:String(o.title||o.titolo||'').trim(), project:String(o.project||o.progetto||'').trim(), assignees:Array.isArray(o.assignees||o.assegnatari)? (o.assignees||o.assegnatari) : String(o.assignees||o.assegnatari||'').split(',').map(function(s){return s.trim();}).filter(Boolean), priority:(o.priority||o.priorita||o['priorit√†']||'medium').toLowerCase(), status:String(o.status||o.stato||'Nuovo').trim(), maxPriority:!!(o.maxPriority||o.max||o['priorit√†Massima']), createdAt:String(o.createdAt||o.dataInserimento||'').trim(), dueAt:String(o.dueAt||o.dataScadenza||'').trim(), desc:String(o.desc||o.descrizione||'').trim(), notes:String(o.notes||o.note||'').trim() }; }); refreshAll(); toast('Open Points caricati da file'); }catch(err){ alert('Errore import OP: '+err.message); } }; inp.click(); }catch(e){ alert('Caricamento OP fallito: '+e.message); } }
function opRowsFiltered(){ return sortRows(applyOpFilters(state.openPoints||[])); }
function quoteCSV(v){ v=(v==null? '' : String(v)); if(/["\n;]/.test(v)) return '"'+v.replace(/"/g,'""')+'"'; return v; }
function exportOpenPointsToCSV(){ var rows=opRowsFiltered(); var head=['ID','Titolo','Progetto','Assegnatari','Priorita','Stato','MaxPriority','InseritoIl','Scadenza','Descrizione','Note']; var csv = head.join(';') + '\n' + rows.map(function(o){ var ass=Array.isArray(o.assignees)? o.assignees.join(', ') : (o.assignees||''); var line=[o.id, o.title, o.project, ass, (o.priority||'').toUpperCase(), (o.status||''), (o.maxPriority?'1':'0'), o.createdAt||'', o.dueAt||'', o.desc||'', o.notes||''].map(quoteCSV).join(';'); return line; }).join('\n'); var blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='open-points.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },400); }
function exportOpenPointsToExcel(){ var rows=opRowsFiltered(); function xmlEscape(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/\</g,'&lt;').replace(/\>/g,'&gt;'); } function cell(v,type){ type=type||'String'; return '<Cell><Data ss:Type="'+type+'">'+xmlEscape(v)+'</Data></Cell>'; } var head=['ID','Titolo','Progetto','Assegnatari','Priorit√†','Stato','MaxPriority','Inserito il','Scadenza','Descrizione','Note']; var xml='<?xml version="1.0"?>\n' + '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n' + '<Worksheet ss:Name="OpenPoints"><Table>'; xml += '<Row>' + head.map(function(h){return cell(h); }).join('') + '</Row>'; rows.forEach(function(o){ var ass=Array.isArray(o.assignees)? o.assignees.join(', ') : (o.assignees||''); xml += '<Row>' + cell(o.id) + cell(o.title) + cell(o.project) + cell(ass) + cell((o.priority||'').toUpperCase()) + cell(o.status||'') + cell(o.maxPriority?'1':'0', 'Number') + cell(o.createdAt||'') + cell(o.dueAt||'') + cell(o.desc||'') + cell(o.notes||'') + '</Row>'; }); xml += '</Table></Worksheet></Workbook>'; var blob=new Blob([xml], {type:'application/vnd.ms-excel'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='open-points.xls'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },400); }

function openSaveOPDialog(){
  try{
    var dlg=document.getElementById('saveOPDlg');
    var inp=document.getElementById('saveOPFileName');
    var closeX=document.getElementById('saveOPCloseBtn');
    var cancel=document.getElementById('saveOPCancelBtn');
    var ok=document.getElementById('saveOPOkBtn');
    if(!dlg||!inp){ alert('Dialog non disponibile'); return; }
    if(!inp.value) inp.value='open-points.json';
    dlg.showModal();
    closeX.onclick=function(){ dlg.close(); };
    cancel.onclick=function(){ dlg.close(); };
    ok.onclick=function(){ var name=String(inp.value||'').trim()||'open-points.json'; exportOpenPointsToFile(name); dlg.close(); };
  }catch(e){ alert('Apri il file nel browser per usare questa finestra.'); }
}


// ===== File Save: Native Save As (File System Access API) con fallback =====
async function saveBlobWithPicker(blob, suggestedName, types){
  try{
    if(window.showSaveFilePicker){
      const handle = await window.showSaveFilePicker({
        suggestedName: suggestedName || 'download.json',
        types: types || [
          { description: 'JSON',        accept: { 'application/json': ['.json'] } },
          { description: 'CSV',         accept: { 'text/csv':        ['.csv'] } },
          { description: 'Excel (XML)', accept: { 'application/vnd.ms-excel': ['.xls'] } }
        ]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      toast('File salvato');
      return true;
    }
  }catch(e){ if(e && e.name==='AbortError') return true; console.warn('Picker non disponibile/fallito. Fallback al download.', e); }
  try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=suggestedName||'download.json'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},400); toast('Download avviato'); return true; }catch(err){ alert('Salvataggio non riuscito: '+(err&&err.message?err.message:err)); return false; }
}
async function saveLinksWithPicker(){ try{ const data=JSON.stringify(state, null, 2); const blob=new Blob([data], {type:'application/json'}); await saveBlobWithPicker(blob, 'linkhub-links.json'); }catch(e){ alert('Salvataggio link non riuscito: '+(e&&e.message?e.message:e)); } }
async function saveOPWithPicker(){ try{ const data=JSON.stringify({openPoints: state.openPoints||[]}, null, 2); const blob=new Blob([data], {type:'application/json'}); await saveBlobWithPicker(blob, 'open-points.json'); }catch(e){ alert('Salvataggio OP non riuscito: '+(e&&e.message?e.message:e)); } }


// ===== Auto-load files (no localStorage fallback if missing) =====
async function readJSONFromRelative(path){
  const res = await fetch(path, { cache: 'no-store' });
  if(!res.ok) throw new Error('HTTP '+res.status+' for '+path);
  return await res.json();
}
function mapSections(json){
  try{
    const arr = Array.isArray(json) ? json : (Array.isArray(json.sections)? json.sections : null);
    if(!arr) return null;
    return arr.map(function(s){ return { id: s.id, name:s.name, desc:s.desc, icon:s.icon, collapsed:!!s.collapsed, color:s.color } });
  }catch(_){ return null; }
}
function mapOP(json){
  try{
    const arr = Array.isArray(json) ? json : (Array.isArray(json.openPoints)? json.openPoints : null);
    if(!arr) return null;
    return arr;
  }catch(_){ return null; }
}

// Directory handle persistence (File System Access API)
const __FS_DB = 'linkhubFS.v1'; const __FS_STORE = 'handles';
function __idb(){ return new Promise(function(resolve, reject){ const req = indexedDB.open(__FS_DB, 1); req.onupgradeneeded = function(){ req.result.createObjectStore(__FS_STORE); }; req.onsuccess = function(){ resolve(req.result); }; req.onerror = function(){ reject(req.error); }; }); }
async function idbSet(key, val){ const db=await __idb(); return new Promise(function(resolve,reject){ const tx=db.transaction(__FS_STORE,'readwrite'); tx.objectStore(__FS_STORE).put(val, key); tx.oncomplete=function(){ resolve(); }; tx.onerror=function(){ reject(tx.error); }; }); }
async function idbGet(key){ const db=await __idb(); return new Promise(function(resolve,reject){ const tx=db.transaction(__FS_STORE,'readonly'); const rq=tx.objectStore(__FS_STORE).get(key); rq.onsuccess=function(){ resolve(rq.result); }; rq.onerror=function(){ reject(rq.error); }; }); }
async function verifyPerm(handle, mode){ try{ const q=await handle.queryPermission({mode:mode||'read'}); if(q==='granted') return true; const r=await handle.requestPermission({mode:mode||'read'}); return r==='granted'; }catch(_){ return false; } }
async function getOrAskDataDirectory(){ try{ let dir=await idbGet('dataDir'); if(dir){ if(await verifyPerm(dir,'read')) return dir; } }catch(_){ } try{ if(window.showDirectoryPicker){ const picked=await window.showDirectoryPicker(); if(await verifyPerm(picked,'read')){ try{ await idbSet('dataDir', picked); }catch(_){ } return picked; } } }catch(_){ } return null; }
async function readJSONFromDir(dirHandle, fileName){ const fh=await dirHandle.getFileHandle(fileName); const f=await fh.getFile(); const text=await f.text(); return JSON.parse(text); }

async function tryAutoLoadOnStartup(){
  if(!AUTO_LOAD || !AUTO_LOAD.enabled) return;
  try{
    let sectionsLoaded=false, opLoaded=false;

    if(location.protocol==='http:' || location.protocol==='https:'){
      try{ const sjson=await readJSONFromRelative('./'+AUTO_LOAD.sectionsFile); const secs=mapSections(sjson); if(secs){ state.sections = normalizeState({ sections: secs, links: state.links, openPoints: state.openPoints }).sections; sectionsLoaded=true; } }catch(_){ }
      try{ const ojson=await readJSONFromRelative('./'+AUTO_LOAD.opFile); const ops=mapOP(ojson); if(ops){ state.openPoints = normalizeState({ sections: state.sections, links: state.links, openPoints: ops }).openPoints; opLoaded=true; } }catch(_){ }
    } else if(window.showDirectoryPicker){
      const dir = await getOrAskDataDirectory();
      if(dir){
        try{ const sjson=await readJSONFromDir(dir, AUTO_LOAD.sectionsFile); const secs=mapSections(sjson); if(secs){ state.sections = normalizeState({ sections: secs, links: state.links, openPoints: state.openPoints }).sections; sectionsLoaded=true; } }catch(_){ }
        try{ const ojson=await readJSONFromDir(dir, AUTO_LOAD.opFile); const ops=mapOP(ojson); if(ops){ state.openPoints = normalizeState({ sections: state.sections, links: state.links, openPoints: ops }).openPoints; opLoaded=true; } }catch(_){ }
      }
    }

    if(!sectionsLoaded){ state.sections = []; }
    if(!opLoaded){ state.openPoints = []; }

    save();
    refreshAll();
  }catch(e){ console.warn('Auto-load fallito:', e); }
}


// ===== Salvataggio su GitHub via funzione serverless =====
var GH_API_ENDPOINT = '/api/save-to-github'; // se deployi altrove, sostituisci con l'URL completo
async function saveToGitHub(){
  try{
    var payload = {
      sections: state && Array.isArray(state.sections) ? state.sections : [],
      openPoints: state && Array.isArray(state.openPoints) ? state.openPoints : []
    };
    var res = await fetch(GH_API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      credentials: 'omit',
      cache: 'no-store'
    });
    var out = {};
    try{ out = await res.json(); }catch(_){ }
    if(!res.ok){ throw new Error(out && out.error ? out.error : (res.status+' '+res.statusText)); }
    toast('Commit effettuato su GitHub');
  }catch(e){
    alert('Salvataggio su GitHub fallito: '+(e && e.message ? e.message : e));
  }
}
(function(){ try{ var b=document.getElementById('saveToGitHubBtn'); if(b) b.onclick = saveToGitHub; }catch(_){ } })();

</script>
<dialog id="opFilterDlg"><div class="modal">
  <header class="modal-bar"><span class="title">Filtra Open Points</span><button id="opFilterCloseXBtn" class="close" aria-label="Chiudi">‚úï</button></header>
  <div class="content">
    <div class="row"><input id="opfText" placeholder="Cerca in titolo, progetto, assegnatari, descrizione, note"/></div>
    <div class="opf-grid">
      <div class="opf-card">
        <h4>Priorit√†</h4>
        <div id="opfPrioGroup" class="opf-checks">
          <label><input type="checkbox" value="low"> Bassa</label>
          <label><input type="checkbox" value="medium"> Media</label>
          <label><input type="checkbox" value="high"> Alta</label>
          <label><input type="checkbox" value="critical"> Critica</label>
        </div>
      </div>
      <div class="opf-card">
        <h4>Stato</h4>
        <div id="opfStatusGroup" class="opf-checks">
          <label><input type="checkbox" value="Nuovo"> Nuovo</label>
          <label><input type="checkbox" value="Da fare"> Da fare</label>
          <label><input type="checkbox" value="In corso"> In corso</label>
          <label><input type="checkbox" value="Schedulato"> Schedulato</label>
          <label><input type="checkbox" value="Completato"> Completato</label>
        </div>
      </div>
      <div class="opf-card">
        <h4>Date inserimento</h4>
        <div class="opf-row">
          <input id="opfCreatedFrom" type="date" placeholder="Creato dal"/>
          <input id="opfCreatedTo" type="date" placeholder="Creato al"/>
        </div>
      </div>
      <div class="opf-card">
        <h4>Scadenza</h4>
        <div class="opf-row">
          <input id="opfDueFrom" type="date" placeholder="Scadenza da"/>
          <input id="opfDueTo" type="date" placeholder="Scadenza a"/>
        </div>
      </div>
      <div class="opf-card">
        <h4>Altre opzioni</h4>
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="opfMaxOnly"/> Solo Priorit√† massima</label>
      </div>
      <div class="opf-card">
        <h4>Assegnatari / Progetti</h4>
        <div class="opf-row">
          <input id="opfAssignees" placeholder="Assegnatari (virgole)"/>
          <input id="opfProjects" placeholder="Progetti (virgole)"/>
        </div>
      </div>
    </div>
    <div class="opf-actions" style="margin-top:12px">
      <button id="opfResetBtn">Azzera</button>
      <button id="opfApplyBtn" class="primary">Applica</button>
    </div>
  </div>
</div></dialog>
<!-- NEW Dialog: Salva link con nome file -->
<dialog id="saveLinksDlg"><div class="modal">
  <header class="modal-bar">
    <span class="title">Salva link</span>
    <button id="saveLinksCloseBtn" class="close" aria-label="Chiudi">‚úï</button>
  </header>
  <div class="content">
    <div class="row">
      <input id="saveLinksFileName" placeholder="Nome file" value="linkhub-links.json"/>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="saveLinksCancelBtn">Annulla</button>
      <button id="saveLinksOkBtn" class="primary">Salva</button>
    </div>
  </div>
</div></dialog>

<dialog id="saveOPDlg"><div class="modal">
  <header class="modal-bar">
    <span class="title">Salva Open Points</span>
    <button id="saveOPCloseBtn" class="close" aria-label="Chiudi">‚úï</button>
  </header>
  <div class="content">
    <div class="row">
      <input id="saveOPFileName" placeholder="Nome file" value="open-points.json"/>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="saveOPCancelBtn">Annulla</button>
      <button id="saveOPOkBtn" class="primary">Salva</button>
    </div>
  </div>
</div></dialog>

</body>
</html>
